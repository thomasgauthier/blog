<!DOCTYPE html><html class="theme-newspaper dark" lang="en"> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="Blogster"><!-- <Favicon /> --><!-- <slot name="meta" /> --><!-- <GoogleFont /> --><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" rel="stylesheet"><script>
  // figure out user's preferred theme and set it as html class for tailwind before paint
  (function () {
    if (typeof window !== "undefined") {
      const isSystemColorSchemeDark = window.matchMedia(
        "(prefers-color-scheme: dark)"
      ).matches;
      const storageTheme = sessionStorage.getItem("theme");
      if (!storageTheme && isSystemColorSchemeDark) {
        document.documentElement.classList.add("dark");
        document.head.children.namedItem("theme-color").content = "#262626";
      } else if (storageTheme === "dark") {
        document.documentElement.classList.add("dark");
        document.head.children.namedItem("theme-color").content = "#262626";
      } else {
        // we already server render light theme
        document.head.children.namedItem("theme-color").content = "#ffffff";
      }
    }
  })();
</script><link href="/fontawesome/css/fontawesome.bareminimum.css" rel="stylesheet"><link href="/fontawesome/css/brands.bareminimum.css" rel="stylesheet"><link href="/fontawesome/css/solid.min.css" rel="stylesheet"><link rel="stylesheet" href="/_astro/about.mnngu0Db.css" />
<style>.hidden[data-astro-cid-qbtd5bqq]{display:none}.output-result[data-astro-cid-c5o6katz]{background:#081a47;padding:.5em 1em;border:solid 1px #37373d;color:#fff;--tw-prose-headings: white}
</style><script type="module" src="/_astro/hoisted.nEQyc8Sb.js"></script></head> <body> <div class="sticky top-0 h-0 hidden lg:block"> <nav class="toc text-sm ml-4 mt-4 absolute top-0 left-0" aria-label="Table of Contents" data-astro-cid-xvrfupwn> <h2 class="text-base" data-astro-cid-xvrfupwn>Content</h2> <hr class="mb-4 w-[40%]" data-astro-cid-xvrfupwn> <ol data-astro-cid-un5m56br><li class="toc-element" data-section="understanding-human-communication-observations-vs-evaluations" data-astro-cid-un5m56br><a class="unset" href="#understanding-human-communication-observations-vs-evaluations" data-astro-cid-un5m56br>Understanding human communication: Observations vs Evaluations</a></li><li class="toc-element" data-section="testing-large-language-models-nvc-abilities" data-astro-cid-un5m56br><a class="unset" href="#testing-large-language-models-nvc-abilities" data-astro-cid-un5m56br>Testing large language models NVC abilities</a></li><ol data-astro-cid-un5m56br><li class="toc-element" data-section="getting-around-data-scarcity" data-astro-cid-un5m56br><a class="unset" href="#getting-around-data-scarcity" data-astro-cid-un5m56br>Getting around data scarcity</a></li><li class="toc-element" data-section="creating-a-good-prompt" data-astro-cid-un5m56br><a class="unset" href="#creating-a-good-prompt" data-astro-cid-un5m56br>Creating a good prompt</a></li><li class="toc-element" data-section="llama-2-as-statement-generator" data-astro-cid-un5m56br><a class="unset" href="#llama-2-as-statement-generator" data-astro-cid-un5m56br>Llama 2 as Statement Generator</a></li></ol><li class="toc-element" data-section="getting-around-mode-collapse-with-tv-scripts" data-astro-cid-un5m56br><a class="unset" href="#getting-around-mode-collapse-with-tv-scripts" data-astro-cid-un5m56br>Getting Around Mode Collapse with TV Scripts</a></li><li class="toc-element" data-section="quality-control-rating-and-refining-the-generated-statements" data-astro-cid-un5m56br><a class="unset" href="#quality-control-rating-and-refining-the-generated-statements" data-astro-cid-un5m56br>Quality Control: Rating and Refining the Generated Statements</a></li><li class="toc-element" data-section="balancing-the-dataset" data-astro-cid-un5m56br><a class="unset" href="#balancing-the-dataset" data-astro-cid-un5m56br>Balancing the dataset</a></li><li class="toc-element" data-section="the-final-step-pushing-to-hugging-face-hub" data-astro-cid-un5m56br><a class="unset" href="#the-final-step-pushing-to-hugging-face-hub" data-astro-cid-un5m56br>The Final Step: Pushing to Hugging Face hub</a></li></ol> <dynamic-toc data-headings="[&#34;understanding-human-communication-observations-vs-evaluations&#34;,&#34;testing-large-language-models-nvc-abilities&#34;,&#34;getting-around-data-scarcity&#34;,&#34;creating-a-good-prompt&#34;,&#34;llama-2-as-statement-generator&#34;,&#34;getting-around-mode-collapse-with-tv-scripts&#34;,&#34;quality-control-rating-and-refining-the-generated-statements&#34;,&#34;balancing-the-dataset&#34;,&#34;the-final-step-pushing-to-hugging-face-hub&#34;]" data-astro-cid-xvrfupwn></dynamic-toc> </nav>   </div> <div class="max-w-3xl mx-auto min-h-screen px-6 sm:px-8"> <header class="w-[calc(100vw - 24rem)]" data-astro-cid-3ef6ksr2> <a class="unset absolute z-10 left-[50%] -top-[100rem] translate-x-[-50%] bg-white text-black px-8 py-2 focus:top-[initial]" href="#main" data-astro-cid-3ef6ksr2>
Skip to content
</a> <nav class="flex w-full" data-astro-cid-3ef6ksr2> <section class="text-text-bold" data-astro-cid-3ef6ksr2> <ul class="unset flex gap-4 [&>li]:p-0" data-astro-cid-3ef6ksr2> <li data-astro-cid-3ef6ksr2><!-- DO NOT FORMAT. IT ADDS AN EXTRA SPACE ON RENDERED CONTENT. --><a href="/" class="unset animated-link" data-astro-cid-3ef6ksr2>Home</a></li> </ul> </section> <section class="ml-auto space-x-2" data-astro-cid-3ef6ksr2> <!-- DO NOT FORMAT. IT ADDS AN EXTRA SPACE ON RENDERED CONTENT. --><a href="/about" class="unset animated-link" data-astro-cid-3ef6ksr2> About </a> <a href="https://github.com/thomasgauthier" class="unset" data-astro-cid-3ef6ksr2> <i class="fa-brands fa-github" data-astro-cid-3ef6ksr2></i> </a> <a href="https://twitter.com/thomasgauthierc/" class="unset" data-astro-cid-3ef6ksr2> <i class="fa-brands fa-twitter" data-astro-cid-3ef6ksr2></i> </a> </section> </nav> <!-- <div
    class="justify-self-end flex items-center content-center text-text-bold"
  >
    <DarkModeToggle />
  </div> --> </header>  <main id="main"> <section class="blog-post prose max-w-none prose-newspaper"> <h1 class="m-0 pt-1 mb-[0.375em] after:mt-6 after:content-[''] after:block after:h-[1px] after:w-[100%] after:border-b-[1px] after:border-current"> Creating a high quality synthetic dataset with open models and a $10 budget </h1> <time class="block mb-[2em] text-text-muted"> Feb 28, 2024 </time> <p>Large language models (LLMs) are awesome. Yet sometime they still struggle to grasp the subtleties of human communication, particularly when it comes to the nuanced understanding of day to day communication. Effective understanding requires a lot of skills. One such skill is the ability to distinguish statements which present observations (noticing) from statements which contain evaluations (judgments).</p>
<p>This skill is an integral part of <a href="https://en.wikipedia.org/wiki/Nonviolent_Communication">Nonviolent Communication (NVC)</a>, a form of communication aimed at building authentic understanding between people. I believe the technique and associated literature are a treasure trove of insights for building empathy through language.</p>
<p>In this post we will dive into how I used one exercise from a NVC book and $7 in <a href="https://www.together.ai/">Together.ai</a> credits to generate, filter and refine a high quality text comprehension dataset of 1500 samples.</p>
<p>The final dataset is available on <a href="https://huggingface.co/datasets/thomasgauthier/observation_or_evaluation">Hugging Face</a>. This blog post is also availabe in jupyter notebook format on <a href="https://github.com/thomasgauthier/observation_or_evaluation">Github</a>.</p>
<h2 id="understanding-human-communication-observations-vs-evaluations">Understanding human communication: Observations vs Evaluations</h2>
<p>In his seminal book <em>Nonviolent Communication: A Language of Life</em>, NVC creator Marshall Rosenberg makes the case that the ability to distinguish between evaluations and observations is crucial for effective nonviolent communication. In his book, Rosenberg includes an exercise prompting readers to distinguish between both types of statements. Notice the use of the <em>prompting</em> here, that will be relevant later.</p>
<blockquote>
<p><em>Exercise 1</em></p>
<p>OBSERVATION OR EVALUATION?</p>
<p>To determine your proficiency at discerning between observations and evaluations, complete the following exercise. Circle the number in front of each statement that is an observation only, with no evaluation mixed in.</p>
<ol>
<li>“John was angry with me yesterday for no reason.”</li>
<li>“Yesterday evening Nancy bit her fingernails while watching television.”</li>
<li>“Sam didn’t ask for my opinion during the meeting.”</li>
<li>“My father is a good man.”</li>
<li>“Janice works too much.”</li>
<li>“Henry is aggressive.”</li>
<li>“Pam was first in line every day this week.”</li>
<li>“My son often doesn’t brush his teeth.”</li>
<li>“Luke told me I didn’t look good in yellow.”</li>
<li>“My aunt complains when I talk with her.”</li>
</ol>
<p><em>Here are my responses for Exercise 1:</em></p>
<ol>
<li>If you circled this number, we’re not in agreement. I consider “for no reason” to be an evaluation. Furthermore, I consider it an evaluation to infer that John was angry. He might have been feeling hurt, scared, sad, or something else. Examples of observations without evaluation might be: “John told me he was angry,” or “John pounded his fist on the table.”</li>
<li>If you circled this number, we’re in agreement that an observation was expressed without being mixed together with an evaluation.</li>
<li>If you circled this number, we’re in agreement that an observation was expressed without being mixed together with an evaluation.</li>
<li>If you circled this number, we’re not in agreement. I consider “good man” to be an evaluation. An observation without evaluation might be: “For the last twenty-five years, my father has given one-tenth of his salary to charity.”</li>
<li>If you circled this number, we’re not in agreement. I consider “too much” to be an evaluation. An observation without evaluation might be: “Janice spent more than sixty hours at the office this week.”</li>
<li>If you circled this number, we’re not in agreement. I consider “aggressive” to be an evaluation. An observation without evaluation might be: “Henry hit his sister when she switched the television channel.”</li>
<li>If you circled this number, we’re in agreement that an observation was expressed without being mixed together with an evaluation.</li>
<li>If you circled this number, we’re not in agreement. I consider “often” to be an evaluation. An observation without evaluation might be: “Twice this week my son didn’t brush his teeth before going to bed.”</li>
<li>If you circled this number, we’re in agreement that an observation was expressed without being mixed together with an evaluation.</li>
<li>If you circled this number, we’re not in agreement. I consider “complains” to be an evaluation. An observation without evaluation might be: “My aunt called me three times this week, and each time talked about people who treated her in ways she didn’t like.”</li>
</ol>
</blockquote>
<p>If you are like me, reading this you will immedialty notice the exercise looks a whole lot like a natural language processing task.</p>
<h2 id="testing-large-language-models-nvc-abilities">Testing large language models NVC abilities</h2>
<p>Reading Rosenberg’s book, I got curious about current large language models abilities to complete this exercise. How well can current AI systems, trained on vast datasets of human language, grasp the often nuanced distinction between factual observations and subjective evaluations? This demands the ability to delve deeper than surface interpretations, drawing inferences from context to identify implicit messages and understand the speaker’s subjective perspective.</p>
<p>Arguably, current models can already do this to some extent, but we would like to test this quantitatively. To do so we need a dataset to evaluate models against. As it stands, Rosenberg’s book cannot bring us all the way there as it contains only 10 labeled statements (not to mention it is most likely part of the training set of a lot of models).</p>
<h3 id="getting-around-data-scarcity">Getting around data scarcity</h3>
<p>Thankfully in 2024 we have access to a range of open-weight models from big and powerful to small and efficient. We can leverage that full array of generation capabilities to synthetically create a benchmark dataset for our task.</p>
<p>We will use a larger model, assuming it will perform better initially, to generate evaluation prompts for smaller models.</p>
<p>While the generated data might not be 100% accurate, this isn’t critical when aiming to assess relative performance. While our dataset might not be all that usefull in evaluating large models capabilities, it will still be useful to evaluate small models which make up a decent portion of the market. See, even if a smaller model benefits from occasional matches with incorrect labels in the test set, its overall lower accuracy compared to the larger model would still be evident.</p>
<p>This approach might seem less than ideal but it scales well as we can generate new better test sets as better models are released over time. Improving the generation prompts could also lead to a baseline improvement without changing models. So even though it might be imperfect, this dataset will provide a solid foundation for future iterations.</p>
<p>To generate this first version of our dataset we will leverage a few low hanging fruits, mostly prompting techniques.</p>
<h3 id="creating-a-good-prompt">Creating a good prompt</h3>
<p>First we use few-shot prompting, so we present the model with a few classification examples before the statement we want to classify.</p>
<p>Second, using a simple <a href="https://shareg.pt/TY5PQQk">prompt</a> we can ask ChatGPT to augment the classification with a rationale. This is similar to chain-of-thought prompting, the intuition is it will help with accuracy by allowing the model to expand more compute on the problem. Our few-shot examples will be the augmented examples.</p>
<p>With all this, we can then rework the exercise into a neat little text completion prompt.</p>
<pre class="astro-code one-dark-pro" style="background-color:#282c34;color:#abb2bf;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word" tabindex="0"><code><span class="line"><span>OBSERVATION OR EVALUATION?</span></span>
<span class="line"><span></span></span>
<span class="line"><span>In the context of Nonviolent Communication (NVC), it&#39;s crucial to distinguish between observations and evaluations. Observations are neutral descriptions of what one perceives, devoid of personal judgments or interpretations. In contrast, evaluations contain personal judgments or interpretations of situations. Your task is to review the provided statements and identify which ones are pure observations without any evaluations mixed in. By mastering this distinction, you can communicate more effectively, minimizing misunderstandings and conflicts.</span></span>
<span class="line"><span></span></span>
<span class="line"><span>To determine your proficiency at discerning between observations and evaluations, complete the following exercise.</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Statement: “John was angry with me yesterday for no reason.”</span></span>
<span class="line"><span>Reasoning: The statement suggests that John felt a certain emotion (anger) directed towards the speaker and adds the qualifier &quot;for no reason&quot;. Emotions are subjective experiences, and we can&#39;t definitively know someone&#39;s emotion unless they express it. The phrase &quot;for no reason&quot; is a judgment because it interprets the cause of John&#39;s perceived emotion.</span></span>
<span class="line"><span>Classification: Evaluation</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Statement: “Yesterday evening Nancy bit her fingernails while watching television.”</span></span>
<span class="line"><span>Reasoning: This statement is simply describing an action Nancy did at a specific time. There is no attached judgment or interpretation of why she did it or what it means about her character or state of mind.</span></span>
<span class="line"><span>Classification: Observation</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Statement: “Sam didn’t ask for my opinion during the meeting.”</span></span>
<span class="line"><span>Reasoning: This is a factual statement about something Sam did not do during a meeting. It doesn&#39;t assign any emotion, motive, or judgment to Sam&#39;s actions.</span></span>
<span class="line"><span>Classification: Observation</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Statement: “My father is a good man.”</span></span>
<span class="line"><span>Reasoning: The term &quot;good&quot; is subjective. What constitutes a &quot;good man&quot; can vary from person to person. This statement is expressing a personal judgment or belief about the father&#39;s character rather than a factual observation.</span></span>
<span class="line"><span>Classification: Evaluation</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Statement: “Janice works too much.”</span></span>
<span class="line"><span>Reasoning: The phrase &quot;too much&quot; is a judgment that implies there is an appropriate or normal amount of work, and Janice exceeds that. It&#39;s not a simple recounting of facts but an interpretation of her work habits.</span></span>
<span class="line"><span>Classification: Evaluation</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Statement: “Henry is aggressive.”</span></span>
<span class="line"><span>Reasoning: Labeling Henry as &quot;aggressive&quot; is a judgment. &quot;Aggressive&quot; is an interpretive term that assigns a character trait to Henry based on behaviors or actions that aren&#39;t specified in this statement.</span></span>
<span class="line"><span>Classification: Evaluation</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Statement: “Pam was first in line every day this week.”</span></span>
<span class="line"><span>Reasoning: This statement simply states a repeated action Pam took on specific days. There&#39;s no interpretation about why she was first in line or what it might mean about her character.</span></span>
<span class="line"><span>Classification: Observation</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Statement: “My son often doesn’t brush his teeth.”</span></span>
<span class="line"><span>Reasoning: The term &quot;often&quot; is a judgment that implies a frequency comparison to what is considered normal or acceptable. The statement isn&#39;t just stating times when the son didn&#39;t brush his teeth but is implying he neglects this action more than he should.</span></span>
<span class="line"><span>Classification: Evaluation</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Statement: “Luke told me I didn’t look good in yellow.”</span></span>
<span class="line"><span>Reasoning: This statement recounts a specific thing Luke said to the speaker. While Luke&#39;s statement was evaluative, the speaker is merely stating a fact about what Luke expressed, without adding their own judgment or interpretation.</span></span>
<span class="line"><span>Classification: Observation</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Statement: {Put statement here and LLM will complete with reasoning and classification}</span></span>
<span class="line"><span>Reasoning: [LLM COMPLETION]</span></span></code></pre>
<p>Now we have a few-shot prompt to evaluate any model on this task. There’s only one problem: the prompt allows us to evaluate any statement, but to make it into a benchmark we will need hundreds of statements with associated classification. Thankfully we can reuse our prompt to solve this problem.</p>
<h3 id="llama-2-as-statement-generator">Llama 2 as Statement Generator</h3>
<p>What if I told you we can use the evaluation prompt we crafted earlier to generate new statements? We simply truncate the prompt at ‘Statement: ’ and let the LLM complete.</p>
<p>Here we will use Llama 2 70B as it is a decently large model with little alignment bias and might provide more objective completions.</p>
<p>For this we will use my favorite cloud inference provider: Together. To save time we also leverage multithreading. As good measure, we save the prompts and generations to a sqlite database.</p>
<pre class="astro-code one-dark-pro" style="background-color:#282c34;color:#abb2bf;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word" tabindex="0"><code><span class="line"><span style="color:#C678DD">import</span><span style="color:#ABB2BF"> os</span></span>
<span class="line"><span style="color:#C678DD">from</span><span style="color:#ABB2BF"> multiprocessing </span><span style="color:#C678DD">import</span><span style="color:#ABB2BF"> Process, Queue, Event</span></span>
<span class="line"><span style="color:#C678DD">import</span><span style="color:#ABB2BF"> threading</span></span>
<span class="line"><span style="color:#C678DD">import</span><span style="color:#ABB2BF"> concurrent.futures</span></span>
<span class="line"><span style="color:#C678DD">from</span><span style="color:#ABB2BF"> queue </span><span style="color:#C678DD">import</span><span style="color:#ABB2BF"> Queue, Empty</span></span>
<span class="line"><span style="color:#C678DD">import</span><span style="color:#ABB2BF"> traceback</span></span>
<span class="line"><span style="color:#C678DD">import</span><span style="color:#ABB2BF"> time</span></span>
<span class="line"><span style="color:#C678DD">import</span><span style="color:#ABB2BF"> sys</span></span>
<span class="line"><span style="color:#C678DD">import</span><span style="color:#ABB2BF"> requests</span></span>
<span class="line"><span style="color:#C678DD">import</span><span style="color:#ABB2BF"> random</span></span>
<span class="line"><span style="color:#C678DD">import</span><span style="color:#ABB2BF"> sqlite3</span></span>
<span class="line"><span style="color:#C678DD">import</span><span style="color:#ABB2BF"> json</span></span>
<span class="line"><span style="color:#C678DD">import</span><span style="color:#ABB2BF"> pandas </span><span style="color:#C678DD">as</span><span style="color:#ABB2BF"> pd</span></span>
<span class="line"><span style="color:#ABB2BF">pd.</span><span style="color:#61AFEF">set_option</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;display.max_colwidth&#39;</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">None</span><span style="color:#ABB2BF">) </span><span style="color:#7F848E;font-style:italic"># Don&#39;t truncate text in columns when displaying</span></span>
<span class="line"><span style="color:#C678DD">from</span><span style="color:#ABB2BF"> tqdm.notebook </span><span style="color:#C678DD">import</span><span style="color:#ABB2BF"> tqdm</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D19A66">TOGETHER_API_KEY</span><span style="color:#56B6C2"> =</span><span style="color:#ABB2BF"> os.environ.</span><span style="color:#61AFEF">get</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;TOGETHER_API_KEY&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">    </span></span>
<span class="line"><span style="color:#C678DD">if</span><span style="color:#D19A66"> TOGETHER_API_KEY</span><span style="color:#C678DD"> is</span><span style="color:#D19A66"> None</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#D19A66">    TOGETHER_API_KEY</span><span style="color:#56B6C2"> =</span><span style="color:#56B6C2"> input</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&quot;Enter your Together API Key: &quot;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">    </span></span>
<span class="line"><span style="color:#D19A66">ENDPOINT_URL</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> &#39;https://api.together.xyz/v1/completions&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">def</span><span style="color:#61AFEF"> make_seed_prompt</span><span style="color:#ABB2BF">():</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    #GPT-4 augmented examples</span></span>
<span class="line"><span style="color:#ABB2BF">    statements </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> [</span><span style="color:#98C379">&quot;&quot;&quot;Statement: “John was angry with me yesterday for no reason.”</span></span>
<span class="line"><span style="color:#98C379">Reasoning: The statement suggests that John felt a certain emotion (anger) directed towards the speaker and adds the qualifier &quot;for no reason&quot;. Emotions are subjective experiences, and we can&#39;t definitively know someone&#39;s emotion unless they express it. The phrase &quot;for no reason&quot; is a judgment because it interprets the cause of John&#39;s perceived emotion.</span></span>
<span class="line"><span style="color:#98C379">Classification: Evaluation</span></span>
<span class="line"><span style="color:#98C379">Pure observation alternative: “John told me he was angry,” or “John pounded his fist on the table.”&quot;&quot;&quot;</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#98C379">&quot;&quot;&quot;Statement: “Yesterday evening Nancy bit her fingernails while watching television.”</span></span>
<span class="line"><span style="color:#98C379">Reasoning: This statement is simply describing an action Nancy did at a specific time. There is no attached judgment or interpretation of why she did it or what it means about her character or state of mind.</span></span>
<span class="line"><span style="color:#98C379">Classification: Observation&quot;&quot;&quot;</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#98C379">&quot;&quot;&quot;Statement: “Sam didn’t ask for my opinion during the meeting.”</span></span>
<span class="line"><span style="color:#98C379">Reasoning: This is a factual statement about something Sam did not do during a meeting. It doesn&#39;t assign any emotion, motive, or judgment to Sam&#39;s actions.</span></span>
<span class="line"><span style="color:#98C379">Classification: Observation&quot;&quot;&quot;</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#98C379">&quot;&quot;&quot;Statement: “Working in the banking industry, I&#39;ve found it difficult to maintain a balance between my professional life and personal life, especially with regards to my children.”</span></span>
<span class="line"><span style="color:#98C379">Reasoning: This statement combines several observations about the speaker&#39;s experience working in the banking industry and their personal struggles balancing work and family life. However, it also includes some evaluations like &quot;difficult&quot; and &quot;especially with regards to my children.&quot;</span></span>
<span class="line"><span style="color:#98C379">Classification: Mixed</span></span>
<span class="line"><span style="color:#98C379">Pure observation alternative: “I work in the banking industry and I spend more time at the office than I do with my children.”&quot;&quot;&quot;</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#98C379">&quot;&quot;&quot;Statement: “My father is a good man.”</span></span>
<span class="line"><span style="color:#98C379">Reasoning: The term &quot;good&quot; is subjective. What constitutes a &quot;good man&quot; can vary from person to person. This statement is expressing a personal judgment or belief about the father&#39;s character rather than a factual observation.</span></span>
<span class="line"><span style="color:#98C379">Classification: Evaluation</span></span>
<span class="line"><span style="color:#98C379">Nonviolent alternative: “For the last twenty-five years, my father has given one-tenth of his salary to charity.”&quot;&quot;&quot;</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#98C379">&quot;&quot;&quot;Statement: “Janice works too much.”</span></span>
<span class="line"><span style="color:#98C379">Reasoning: The phrase &quot;too much&quot; is a judgment that implies there is an appropriate or normal amount of work, and Janice exceeds that. It&#39;s not a simple recounting of facts but an interpretation of her work habits.</span></span>
<span class="line"><span style="color:#98C379">Classification: Evaluation</span></span>
<span class="line"><span style="color:#98C379">Pure observation alternative: “Janice spent more than sixty hours at the office this week.”&quot;&quot;&quot;</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#98C379">&quot;&quot;&quot;Statement: “Henry is aggressive.”</span></span>
<span class="line"><span style="color:#98C379">Reasoning: Labeling Henry as &quot;aggressive&quot; is a judgment. &quot;Aggressive&quot; is an interpretive term that assigns a character trait to Henry based on behaviors or actions that aren&#39;t specified in this statement.</span></span>
<span class="line"><span style="color:#98C379">Classification: Evaluation</span></span>
<span class="line"><span style="color:#98C379">Pure observation alternative: “Henry hit his sister when she switched the television channel.”&quot;&quot;&quot;</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#98C379">&quot;&quot;&quot;Statement: “Pam was first in line every day this week.”</span></span>
<span class="line"><span style="color:#98C379">Reasoning: This statement simply states a repeated action Pam took on specific days. There&#39;s no interpretation about why she was first in line or what it might mean about her character.</span></span>
<span class="line"><span style="color:#98C379">Classification: Observation&quot;&quot;&quot;</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#98C379">&quot;&quot;&quot;Statement: “My son often doesn’t brush his teeth.”</span></span>
<span class="line"><span style="color:#98C379">Reasoning: The term &quot;often&quot; is a judgment that implies a frequency comparison to what is considered normal or acceptable. The statement isn&#39;t just stating times when the son didn&#39;t brush his teeth but is implying he neglects this action more than he should.</span></span>
<span class="line"><span style="color:#98C379">Classification: Evaluation</span></span>
<span class="line"><span style="color:#98C379">Pure observation alternative: “Twice this week my son didn’t brush his teeth before going to bed.”&quot;&quot;&quot;</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#98C379">&quot;&quot;&quot;Statement: “Luke told me I didn’t look good in yellow.”</span></span>
<span class="line"><span style="color:#98C379">Reasoning: This statement recounts a specific thing Luke said to the speaker. While Luke&#39;s statement was evaluative, the speaker is merely stating a fact about what Luke expressed, without adding their own judgment or interpretation.</span></span>
<span class="line"><span style="color:#98C379">Classification: Observation&quot;&quot;&quot;</span><span style="color:#ABB2BF">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    random.</span><span style="color:#61AFEF">shuffle</span><span style="color:#ABB2BF">(statements) </span><span style="color:#7F848E;font-style:italic"># Let&#39;s shuffle the few shot ordering, hopefully this will give us more varied outputs</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    concatenated </span><span style="color:#56B6C2">=</span><span style="color:#98C379"> &quot;</span><span style="color:#56B6C2">\n\n</span><span style="color:#98C379">&quot;</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">join</span><span style="color:#ABB2BF">(statements)</span></span>
<span class="line"><span style="color:#ABB2BF">    </span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#98C379"> &quot;&quot;&quot;OBSERVATION OR EVALUATION?</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">In the context of Nonviolent Communication (NVC), it&#39;s crucial to distinguish between observations and evaluations. Observations are neutral descriptions of what one perceives, devoid of personal judgments or interpretations. In contrast, evaluations contain personal judgments or interpretations of situations. Your task is to review the provided statements and identify which ones are pure observations without any evaluations mixed in. By mastering this distinction, you can communicate more effectively, minimizing misunderstandings and conflicts.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">To determine your proficiency at discerning between observations and evaluations, complete the following exercise.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">&quot;&quot;&quot;</span><span style="color:#56B6C2"> +</span><span style="color:#ABB2BF"> concatenated </span><span style="color:#56B6C2">+</span><span style="color:#98C379"> &#39;</span><span style="color:#56B6C2">\n\n</span><span style="color:#98C379">&#39;</span><span style="color:#56B6C2"> +</span><span style="color:#98C379"> &#39;Statement:&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic"># Let&#39;s define a class that will allow us to call a generate function many times in parallel</span></span>
<span class="line"><span style="color:#C678DD">class</span><span style="color:#E5C07B"> Generator</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#C678DD">    def</span><span style="color:#56B6C2"> __init__</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B;font-style:italic">self</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66;font-style:italic">max_workers</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66;font-style:italic">generate_function</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66;font-style:italic">arguments_list</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#E5C07B">        self</span><span style="color:#ABB2BF">.task_queue </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> Queue</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#E5C07B">        self</span><span style="color:#ABB2BF">.results_queue </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> Queue</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#E5C07B">        self</span><span style="color:#ABB2BF">.workers </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> []</span></span>
<span class="line"><span style="color:#E5C07B">        self</span><span style="color:#ABB2BF">.max_workers </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> max_workers</span></span>
<span class="line"><span style="color:#E5C07B">        self</span><span style="color:#ABB2BF">.generate_function </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> generate_function</span></span>
<span class="line"><span style="color:#E5C07B">        self</span><span style="color:#ABB2BF">.arguments_list </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> arguments_list</span></span>
<span class="line"><span style="color:#E5C07B">        self</span><span style="color:#ABB2BF">.stop_signal_received </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> False</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    def</span><span style="color:#61AFEF"> worker</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B;font-style:italic">self</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#C678DD">        while</span><span style="color:#C678DD"> not</span><span style="color:#E5C07B"> self</span><span style="color:#ABB2BF">.stop_signal_received:</span></span>
<span class="line"><span style="color:#C678DD">            try</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#ABB2BF">                arg </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> self</span><span style="color:#ABB2BF">.task_queue.</span><span style="color:#61AFEF">get</span><span style="color:#ABB2BF">(</span><span style="color:#E06C75;font-style:italic">timeout</span><span style="color:#56B6C2">=</span><span style="color:#D19A66">1</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#C678DD">                if</span><span style="color:#ABB2BF"> arg </span><span style="color:#C678DD">is</span><span style="color:#D19A66"> None</span><span style="color:#ABB2BF">:  </span><span style="color:#7F848E;font-style:italic"># Stop signal</span></span>
<span class="line"><span style="color:#C678DD">                    break</span></span>
<span class="line"><span style="color:#C678DD">                try</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#ABB2BF">                    result </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> self</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">generate_function</span><span style="color:#ABB2BF">(arg)</span></span>
<span class="line"><span style="color:#E5C07B">                    self</span><span style="color:#ABB2BF">.results_queue.</span><span style="color:#61AFEF">put</span><span style="color:#ABB2BF">(result)</span></span>
<span class="line"><span style="color:#C678DD">                except</span><span style="color:#ABB2BF"> Exception </span><span style="color:#C678DD">as</span><span style="color:#ABB2BF"> e:</span></span>
<span class="line"><span style="color:#ABB2BF">                    traceback.</span><span style="color:#61AFEF">print_exc</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#C678DD">                finally</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E5C07B">                    self</span><span style="color:#ABB2BF">.task_queue.</span><span style="color:#61AFEF">task_done</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#C678DD">            except</span><span style="color:#ABB2BF"> Empty:</span></span>
<span class="line"><span style="color:#C678DD">                continue</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    def</span><span style="color:#61AFEF"> start_workers</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B;font-style:italic">self</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#C678DD">        for</span><span style="color:#ABB2BF"> _ </span><span style="color:#C678DD">in</span><span style="color:#56B6C2"> range</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">self</span><span style="color:#ABB2BF">.max_workers):</span></span>
<span class="line"><span style="color:#ABB2BF">            worker </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> threading.</span><span style="color:#61AFEF">Thread</span><span style="color:#ABB2BF">(</span><span style="color:#E06C75;font-style:italic">target</span><span style="color:#56B6C2">=</span><span style="color:#E5C07B">self</span><span style="color:#ABB2BF">.worker)</span></span>
<span class="line"><span style="color:#ABB2BF">            worker.</span><span style="color:#61AFEF">start</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#E5C07B">            self</span><span style="color:#ABB2BF">.workers.</span><span style="color:#61AFEF">append</span><span style="color:#ABB2BF">(worker)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    def</span><span style="color:#61AFEF"> stop_workers</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B;font-style:italic">self</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#E5C07B">        self</span><span style="color:#ABB2BF">.stop_signal_received </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> True</span></span>
<span class="line"><span style="color:#C678DD">        for</span><span style="color:#ABB2BF"> _ </span><span style="color:#C678DD">in</span><span style="color:#E5C07B"> self</span><span style="color:#ABB2BF">.workers:</span></span>
<span class="line"><span style="color:#E5C07B">            self</span><span style="color:#ABB2BF">.task_queue.</span><span style="color:#61AFEF">put</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">None</span><span style="color:#ABB2BF">)  </span><span style="color:#7F848E;font-style:italic"># Send stop signal to all workers</span></span>
<span class="line"><span style="color:#C678DD">        for</span><span style="color:#ABB2BF"> worker </span><span style="color:#C678DD">in</span><span style="color:#E5C07B"> self</span><span style="color:#ABB2BF">.workers:</span></span>
<span class="line"><span style="color:#ABB2BF">            worker.</span><span style="color:#61AFEF">join</span><span style="color:#ABB2BF">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    def</span><span style="color:#56B6C2"> __iter__</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B;font-style:italic">self</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#E5C07B">        self</span><span style="color:#ABB2BF">.stop_signal_received </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> False</span><span style="color:#7F848E;font-style:italic">  # Reset stop signal in case of reuse</span></span>
<span class="line"><span style="color:#C678DD">        try</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            # Enqueue all tasks</span></span>
<span class="line"><span style="color:#C678DD">            for</span><span style="color:#ABB2BF"> arg </span><span style="color:#C678DD">in</span><span style="color:#E5C07B"> self</span><span style="color:#ABB2BF">.arguments_list:</span></span>
<span class="line"><span style="color:#E5C07B">                self</span><span style="color:#ABB2BF">.task_queue.</span><span style="color:#61AFEF">put</span><span style="color:#ABB2BF">(arg)</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            # Start worker threads</span></span>
<span class="line"><span style="color:#E5C07B">            self</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">start_workers</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#C678DD">        except</span><span style="color:#ABB2BF"> KeyboardInterrupt:</span></span>
<span class="line"><span style="color:#56B6C2">            print</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&quot;KeyboardInterrupt detected, stopping workers...&quot;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#E5C07B">            self</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">stop_workers</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#C678DD">            raise</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E5C07B"> self</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    def</span><span style="color:#56B6C2"> __next__</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B;font-style:italic">self</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#E5C07B"> self</span><span style="color:#ABB2BF">.stop_signal_received </span><span style="color:#C678DD">and</span><span style="color:#E5C07B"> self</span><span style="color:#ABB2BF">.results_queue.</span><span style="color:#61AFEF">empty</span><span style="color:#ABB2BF">():</span></span>
<span class="line"><span style="color:#C678DD">            raise</span><span style="color:#ABB2BF"> StopIteration</span></span>
<span class="line"><span style="color:#C678DD">        try</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#ABB2BF">            result </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> self</span><span style="color:#ABB2BF">.results_queue.</span><span style="color:#61AFEF">get</span><span style="color:#ABB2BF">(</span><span style="color:#E06C75;font-style:italic">timeout</span><span style="color:#56B6C2">=</span><span style="color:#D19A66">120</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#C678DD">            return</span><span style="color:#ABB2BF"> result</span></span>
<span class="line"><span style="color:#C678DD">        except</span><span style="color:#ABB2BF"> Empty:</span></span>
<span class="line"><span style="color:#E5C07B">            self</span><span style="color:#ABB2BF">.stop_signal_received </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> True</span><span style="color:#7F848E;font-style:italic">  # Signal to stop if no results are available</span></span>
<span class="line"><span style="color:#E5C07B">            self</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">stop_workers</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#C678DD">            raise</span><span style="color:#ABB2BF"> StopIteration</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">def</span><span style="color:#61AFEF"> generate_statement</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66;font-style:italic">_</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66;font-style:italic">max_retries</span><span style="color:#ABB2BF">=</span><span style="color:#D19A66">10</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#ABB2BF">    prompt </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> make_seed_prompt</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">    generation_params </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#98C379">        &quot;model&quot;</span><span style="color:#ABB2BF">: </span><span style="color:#98C379">&quot;togethercomputer/llama-2-70b&quot;</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#98C379">        &quot;max_tokens&quot;</span><span style="color:#ABB2BF">: </span><span style="color:#D19A66">512</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#98C379">        &quot;temperature&quot;</span><span style="color:#ABB2BF">: </span><span style="color:#D19A66">0.7</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#98C379">        &quot;top_p&quot;</span><span style="color:#ABB2BF">: </span><span style="color:#D19A66">0.7</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#98C379">        &quot;top_k&quot;</span><span style="color:#ABB2BF">: </span><span style="color:#D19A66">50</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#98C379">        &quot;stop&quot;</span><span style="color:#ABB2BF">: </span><span style="color:#98C379">&quot;</span><span style="color:#56B6C2">\n\n</span><span style="color:#98C379">&quot;</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#98C379">        &quot;repetition_penalty&quot;</span><span style="color:#ABB2BF">: </span><span style="color:#D19A66">1</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    retries </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 0</span></span>
<span class="line"><span style="color:#C678DD">    while</span><span style="color:#ABB2BF"> retries </span><span style="color:#56B6C2">&lt;</span><span style="color:#ABB2BF"> max_retries:</span></span>
<span class="line"><span style="color:#C678DD">        try</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#ABB2BF">            res </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> requests.</span><span style="color:#61AFEF">post</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">ENDPOINT_URL</span><span style="color:#ABB2BF">, </span><span style="color:#E06C75;font-style:italic">json</span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF">{</span></span>
<span class="line"><span style="color:#56B6C2">                **</span><span style="color:#ABB2BF">generation_params,</span></span>
<span class="line"><span style="color:#98C379">                &quot;prompt&quot;</span><span style="color:#ABB2BF">: prompt,</span></span>
<span class="line"><span style="color:#ABB2BF">            }, </span><span style="color:#E06C75;font-style:italic">headers</span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF">{</span></span>
<span class="line"><span style="color:#98C379">                &quot;Authorization&quot;</span><span style="color:#ABB2BF">: </span><span style="color:#C678DD">f</span><span style="color:#98C379">&quot;Bearer </span><span style="color:#D19A66">{TOGETHER_API_KEY}</span><span style="color:#98C379">&quot;</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#ABB2BF">            })</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">            if</span><span style="color:#ABB2BF"> res.status_code </span><span style="color:#56B6C2">==</span><span style="color:#D19A66"> 200</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#C678DD">                return</span><span style="color:#ABB2BF"> prompt, res.</span><span style="color:#61AFEF">json</span><span style="color:#ABB2BF">()[</span><span style="color:#98C379">&#39;choices&#39;</span><span style="color:#ABB2BF">][</span><span style="color:#D19A66">0</span><span style="color:#ABB2BF">][</span><span style="color:#98C379">&#39;text&#39;</span><span style="color:#ABB2BF">], generation_params</span></span>
<span class="line"><span style="color:#C678DD">            else</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#ABB2BF">                error_message </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> res.text</span></span>
<span class="line"><span style="color:#56B6C2">                print</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">f</span><span style="color:#98C379">&quot;Attempt </span><span style="color:#D19A66">{</span><span style="color:#ABB2BF">retries </span><span style="color:#56B6C2">+</span><span style="color:#D19A66"> 1}</span><span style="color:#98C379"> failed with status code </span><span style="color:#D19A66">{</span><span style="color:#ABB2BF">res.status_code</span><span style="color:#D19A66">}</span><span style="color:#98C379">. Error: </span><span style="color:#D19A66">{</span><span style="color:#ABB2BF">error_message</span><span style="color:#D19A66">}</span><span style="color:#98C379">. Retrying...&quot;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#C678DD">        except</span><span style="color:#ABB2BF"> requests.exceptions.RequestException </span><span style="color:#C678DD">as</span><span style="color:#ABB2BF"> e:</span></span>
<span class="line"><span style="color:#56B6C2">            print</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">f</span><span style="color:#98C379">&quot;An error occurred: </span><span style="color:#D19A66">{</span><span style="color:#ABB2BF">e</span><span style="color:#D19A66">}</span><span style="color:#98C379">. Retrying...&quot;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">        retries </span><span style="color:#56B6C2">+=</span><span style="color:#D19A66"> 1</span></span>
<span class="line"><span style="color:#ABB2BF">        time.</span><span style="color:#61AFEF">sleep</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">1</span><span style="color:#ABB2BF">)  </span><span style="color:#7F848E;font-style:italic"># Sleep for a bit before retrying to avoid overwhelming the server</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#D19A66"> None</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">def</span><span style="color:#61AFEF"> create_statement_generation_table</span><span style="color:#ABB2BF">():</span></span>
<span class="line"><span style="color:#ABB2BF">    conn </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> sqlite3.</span><span style="color:#61AFEF">connect</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;results.sqlite&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">    c </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> conn.</span><span style="color:#61AFEF">cursor</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">    c.</span><span style="color:#61AFEF">execute</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;&#39;&#39;</span></span>
<span class="line"><span style="color:#98C379">        CREATE TABLE IF NOT EXISTS statement_generation (</span></span>
<span class="line"><span style="color:#98C379">            id INTEGER PRIMARY KEY,</span></span>
<span class="line"><span style="color:#98C379">            prompt TEXT,</span></span>
<span class="line"><span style="color:#98C379">            generation TEXT,</span></span>
<span class="line"><span style="color:#98C379">            statement TEXT,</span></span>
<span class="line"><span style="color:#98C379">            generation_params json</span></span>
<span class="line"><span style="color:#98C379">        )</span></span>
<span class="line"><span style="color:#98C379">    &#39;&#39;&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">    conn.</span><span style="color:#61AFEF">commit</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">    conn.</span><span style="color:#61AFEF">close</span><span style="color:#ABB2BF">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">def</span><span style="color:#61AFEF"> insert_generated_statement</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66;font-style:italic">prompt</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66;font-style:italic">generation</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66;font-style:italic">statement</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66;font-style:italic">generation_params</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#ABB2BF">    conn </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> sqlite3.</span><span style="color:#61AFEF">connect</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;results.sqlite&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">    c </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> conn.</span><span style="color:#61AFEF">cursor</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">    c.</span><span style="color:#61AFEF">execute</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;&#39;&#39;</span></span>
<span class="line"><span style="color:#98C379">        INSERT INTO statement_generation (prompt, generation, statement, generation_params)</span></span>
<span class="line"><span style="color:#98C379">        VALUES (?, ?, ?, ?)</span></span>
<span class="line"><span style="color:#98C379">    &#39;&#39;&#39;</span><span style="color:#ABB2BF">, (prompt, generation, statement, json.</span><span style="color:#61AFEF">dumps</span><span style="color:#ABB2BF">(generation_params)))</span></span>
<span class="line"><span style="color:#ABB2BF">    conn.</span><span style="color:#61AFEF">commit</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">    conn.</span><span style="color:#61AFEF">close</span><span style="color:#ABB2BF">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">def</span><span style="color:#61AFEF"> table_as_dataframe</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66;font-style:italic">table</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#ABB2BF">    conn </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> sqlite3.</span><span style="color:#61AFEF">connect</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;results.sqlite&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">    query </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> f</span><span style="color:#98C379">&#39;SELECT * FROM </span><span style="color:#D19A66">{</span><span style="color:#ABB2BF">table</span><span style="color:#D19A66">}</span><span style="color:#98C379">&#39;</span></span>
<span class="line"><span style="color:#ABB2BF">    df </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> pd.</span><span style="color:#61AFEF">read_sql_query</span><span style="color:#ABB2BF">(query, conn)</span></span>
<span class="line"><span style="color:#ABB2BF">    conn.</span><span style="color:#61AFEF">close</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#ABB2BF"> df</span></span>
<span class="line"></span>
<span class="line"><span style="color:#61AFEF">create_statement_generation_table</span><span style="color:#ABB2BF">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">n_samples </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 1000</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">arguments_list </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> [</span><span style="color:#56B6C2">float</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&quot;nan&quot;</span><span style="color:#ABB2BF">)] </span><span style="color:#56B6C2">*</span><span style="color:#ABB2BF"> n_samples</span></span>
<span class="line"><span style="color:#ABB2BF">generator </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> Generator</span><span style="color:#ABB2BF">(</span><span style="color:#E06C75;font-style:italic">max_workers</span><span style="color:#56B6C2">=</span><span style="color:#D19A66">20</span><span style="color:#ABB2BF">, </span><span style="color:#E06C75;font-style:italic">generate_function</span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF">generate_statement, </span><span style="color:#E06C75;font-style:italic">arguments_list</span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF">arguments_list)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">for</span><span style="color:#ABB2BF"> result </span><span style="color:#C678DD">in</span><span style="color:#61AFEF"> tqdm</span><span style="color:#ABB2BF">(generator, </span><span style="color:#E06C75;font-style:italic">total</span><span style="color:#56B6C2">=len</span><span style="color:#ABB2BF">(arguments_list)):</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#ABB2BF"> result </span><span style="color:#C678DD">is</span><span style="color:#C678DD"> not</span><span style="color:#D19A66"> None</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#ABB2BF">        prompt, generation, generation_params </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> result</span></span>
<span class="line"><span style="color:#ABB2BF">        open_curly_quote </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> generation.</span><span style="color:#61AFEF">find</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;“&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">        close_curly_quote </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> generation.</span><span style="color:#61AFEF">find</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;”&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">    </span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#ABB2BF"> open_curly_quote </span><span style="color:#56B6C2">&gt;=</span><span style="color:#D19A66"> 0</span><span style="color:#C678DD"> and</span><span style="color:#ABB2BF"> close_curly_quote </span><span style="color:#56B6C2">&gt;=</span><span style="color:#D19A66"> 0</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#ABB2BF">            statement </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> generation[open_curly_quote</span><span style="color:#56B6C2">+</span><span style="color:#D19A66">1</span><span style="color:#ABB2BF">:close_curly_quote]</span></span>
<span class="line"><span style="color:#61AFEF">            insert_generated_statement</span><span style="color:#ABB2BF">(prompt, generation, statement, generation_params)</span></span></code></pre>
<p>let’s look at some generated statements with <code>table_as_dataframe(&#39;statement_generation&#39;).head()</code></p>
<div class="output-result" data-astro-cid-c5o6katz> 


































<table><thead><tr><th>Prompt</th><th>Generation</th><th>Statement</th></tr></thead><tbody><tr><td>…</td><td>…</td><td>Jenny is a good person.</td></tr><tr><td>…</td><td>…</td><td>The meeting was a waste of time.</td></tr><tr><td>…</td><td>…</td><td>The weather was awful today.</td></tr><tr><td>…</td><td>…</td><td>My sister is always late.</td></tr><tr><td>…</td><td>…</td><td>The boss is always late.</td></tr></tbody></table> </div> 
<p>Well… our generations don’t seem to have a lot of variety, let’s plot their similarity using the <code>all-MiniLM-L6-v2</code> sentence embedding model.</p>
<astro-accordion data-code="{codeBlock}" data-astro-cid-qbtd5bqq> <button class="accordion-toggle flex items-center text-sm" data-astro-cid-qbtd5bqq><b data-astro-cid-qbtd5bqq>Show Code</b> <svg class="chevron-icon w-6 h-6 -rotate-90 transition-transform transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" data-astro-cid-qbtd5bqq> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" data-astro-cid-qbtd5bqq></path> </svg></button> <div class="code-content hidden" data-astro-cid-qbtd5bqq> <pre class="astro-code one-dark-pro" style="background-color:#282c34;color:#abb2bf;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word" tabindex="0"><code><span class="line"><span style="color:#C678DD">import</span><span style="color:#ABB2BF"> numpy </span><span style="color:#C678DD">as</span><span style="color:#ABB2BF"> np</span></span>
<span class="line"><span style="color:#C678DD">import</span><span style="color:#ABB2BF"> matplotlib.pyplot </span><span style="color:#C678DD">as</span><span style="color:#ABB2BF"> plt</span></span>
<span class="line"><span style="color:#C678DD">from</span><span style="color:#ABB2BF"> sentence_transformers </span><span style="color:#C678DD">import</span><span style="color:#ABB2BF"> SentenceTransformer</span></span>
<span class="line"><span style="color:#C678DD">from</span><span style="color:#ABB2BF"> sklearn.metrics.pairwise </span><span style="color:#C678DD">import</span><span style="color:#ABB2BF"> cosine_similarity</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">def</span><span style="color:#61AFEF"> fetch_all_statements</span><span style="color:#ABB2BF">():</span></span>
<span class="line"><span style="color:#ABB2BF">    conn </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> sqlite3.</span><span style="color:#61AFEF">connect</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;results.sqlite&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">    c </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> conn.</span><span style="color:#61AFEF">cursor</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">    c.</span><span style="color:#61AFEF">execute</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;SELECT statement FROM statement_generation&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">    all_statements </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> [row[</span><span style="color:#D19A66">0</span><span style="color:#ABB2BF">] </span><span style="color:#C678DD">for</span><span style="color:#ABB2BF"> row </span><span style="color:#C678DD">in</span><span style="color:#ABB2BF"> c.</span><span style="color:#61AFEF">fetchall</span><span style="color:#ABB2BF">()]</span></span>
<span class="line"><span style="color:#ABB2BF">    conn.</span><span style="color:#61AFEF">close</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#ABB2BF"> all_statements</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">statements </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> fetch_all_statements</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">model </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> SentenceTransformer</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;all-MiniLM-L6-v2&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic"># Generate embeddings for each string in the DataFrame</span></span>
<span class="line"><span style="color:#ABB2BF">embeddings </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> model.</span><span style="color:#61AFEF">encode</span><span style="color:#ABB2BF">(statements)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic"># Calculate cosine similarity</span></span>
<span class="line"><span style="color:#ABB2BF">cosine_sim </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> cosine_similarity</span><span style="color:#ABB2BF">(embeddings)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic"># Exclude self-comparison</span></span>
<span class="line"><span style="color:#ABB2BF">np.</span><span style="color:#61AFEF">fill_diagonal</span><span style="color:#ABB2BF">(cosine_sim, </span><span style="color:#56B6C2">-</span><span style="color:#D19A66">1</span><span style="color:#ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">highest_cosine_similarity_by_embedding </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> np.</span><span style="color:#61AFEF">max</span><span style="color:#ABB2BF">(cosine_sim, </span><span style="color:#E06C75;font-style:italic">axis</span><span style="color:#56B6C2">=</span><span style="color:#D19A66">1</span><span style="color:#ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">plt.</span><span style="color:#61AFEF">hist</span><span style="color:#ABB2BF">(highest_cosine_similarity_by_embedding, </span><span style="color:#E06C75;font-style:italic">bins</span><span style="color:#56B6C2">=</span><span style="color:#D19A66">10</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">plt.</span><span style="color:#61AFEF">xlabel</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;Highest similarity with another statement in the set&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">plt.</span><span style="color:#61AFEF">ylabel</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;Frequency&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">plt.</span><span style="color:#61AFEF">title</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;Embedding similarity histogram&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">plt.</span><span style="color:#61AFEF">show</span><span style="color:#ABB2BF">()</span></span></code></pre> </div> </astro-accordion>  
<p><img src="/images/nvc/1.png" alt="image"/></p>
<p>That’s a lot of similar statements… It seems the Llama 2 70B model is exhibiting some sort of <a href="https://www.lesswrong.com/posts/t9svvNPNmFf5Qa3TA/mysteries-of-mode-collapse">mode collapse</a> here.</p>
<p>To make sure our statements have sufficient variety let’s bring in some real world data. What if we sourced statements from TV scripts? Given the nature of our task, let’s aim for material that touches on every day sensibilities and showcases a lot of complex interpersonal dynamics.</p>
<h2 id="getting-around-mode-collapse-with-tv-scripts">Getting Around Mode Collapse with TV Scripts</h2>
<p>Looking around the internet, I found <a href="https://www.kaggle.com/datasets/luongleanstocode/seinfeld-text-corpus">this dataset</a> on Kaggle that contains all the Seinfeld episode scripts in a single .txt file.</p>
<p>Let’s parse the file into scenes and dialogues.</p>
<pre class="astro-code one-dark-pro" style="background-color:#282c34;color:#abb2bf;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word" tabindex="0"><code><span class="line"><span style="color:#C678DD">import</span><span style="color:#ABB2BF"> re</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">scenes </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> []</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">with</span><span style="color:#56B6C2"> open</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;corpus.txt&#39;</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">&#39;r&#39;</span><span style="color:#ABB2BF">) </span><span style="color:#C678DD">as</span><span style="color:#ABB2BF"> f:</span></span>
<span class="line"><span style="color:#ABB2BF">    current_scene </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> None</span></span>
<span class="line"><span style="color:#C678DD">    for</span><span style="color:#ABB2BF"> line </span><span style="color:#C678DD">in</span><span style="color:#ABB2BF"> f:</span></span>
<span class="line"><span style="color:#ABB2BF">        line </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> line.</span><span style="color:#61AFEF">strip</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">        </span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#ABB2BF">  (line.</span><span style="color:#61AFEF">startswith</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;[&#39;</span><span style="color:#ABB2BF">) </span><span style="color:#C678DD">and</span><span style="color:#ABB2BF"> line.</span><span style="color:#61AFEF">endswith</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;]&#39;</span><span style="color:#ABB2BF">)) </span><span style="color:#C678DD">or</span><span style="color:#ABB2BF"> (</span><span style="color:#98C379">&#39;INT.&#39;</span><span style="color:#C678DD"> in</span><span style="color:#ABB2BF"> line </span><span style="color:#C678DD">or</span><span style="color:#98C379"> &#39;EXT.&#39;</span><span style="color:#C678DD"> in</span><span style="color:#ABB2BF"> line):</span></span>
<span class="line"><span style="color:#C678DD">            if</span><span style="color:#C678DD"> not</span><span style="color:#ABB2BF"> current_scene </span><span style="color:#C678DD">is</span><span style="color:#D19A66"> None</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#ABB2BF">                scenes.</span><span style="color:#61AFEF">append</span><span style="color:#ABB2BF">(current_scene)</span></span>
<span class="line"><span style="color:#ABB2BF">            current_scene </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> {}</span></span>
<span class="line"><span style="color:#ABB2BF">            current_scene[</span><span style="color:#98C379">&#39;location&#39;</span><span style="color:#ABB2BF">] </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> line</span></span>
<span class="line"><span style="color:#ABB2BF">            current_scene[</span><span style="color:#98C379">&#39;text&#39;</span><span style="color:#ABB2BF">] </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> line</span></span>
<span class="line"><span style="color:#C678DD">        elif</span><span style="color:#C678DD"> not</span><span style="color:#ABB2BF"> current_scene </span><span style="color:#C678DD">is</span><span style="color:#D19A66"> None</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#ABB2BF">            current_scene[</span><span style="color:#98C379">&#39;text&#39;</span><span style="color:#ABB2BF">] </span><span style="color:#56B6C2">+=</span><span style="color:#98C379"> &#39;</span><span style="color:#56B6C2">\n</span><span style="color:#98C379">&#39;</span><span style="color:#56B6C2"> +</span><span style="color:#ABB2BF"> line  </span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">def</span><span style="color:#61AFEF"> flatten</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66;font-style:italic">arr</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#ABB2BF">    flattened </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> []</span></span>
<span class="line"><span style="color:#C678DD">    for</span><span style="color:#ABB2BF"> item </span><span style="color:#C678DD">in</span><span style="color:#ABB2BF"> arr:</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#56B6C2"> isinstance</span><span style="color:#ABB2BF">(item, </span><span style="color:#56B6C2">list</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#ABB2BF">            flattened.</span><span style="color:#61AFEF">extend</span><span style="color:#ABB2BF">(</span><span style="color:#61AFEF">flatten</span><span style="color:#ABB2BF">(item))</span></span>
<span class="line"><span style="color:#C678DD">        else</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#ABB2BF">            flattened.</span><span style="color:#61AFEF">append</span><span style="color:#ABB2BF">(item)</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#ABB2BF"> flattened</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">def</span><span style="color:#61AFEF"> extract_dialogues</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66;font-style:italic">strings</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#ABB2BF">    extracted_parts </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> []</span></span>
<span class="line"><span style="color:#ABB2BF">    </span></span>
<span class="line"><span style="color:#C678DD">    for</span><span style="color:#ABB2BF"> string </span><span style="color:#C678DD">in</span><span style="color:#ABB2BF"> strings:</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#ABB2BF"> re.</span><span style="color:#61AFEF">match</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">r</span><span style="color:#E06C75">&quot;^</span><span style="color:#D19A66">[A-Z</span><span style="color:#E06C75">\s</span><span style="color:#D19A66">]+</span><span style="color:#E06C75">:&quot;</span><span style="color:#ABB2BF">, string): </span><span style="color:#7F848E;font-style:italic"># Match &quot;CHARACTER NAME: ...&quot; </span></span>
<span class="line"><span style="color:#ABB2BF">            extracted_part </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> string.</span><span style="color:#61AFEF">split</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;:&#39;</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66">1</span><span style="color:#ABB2BF">)[</span><span style="color:#D19A66">1</span><span style="color:#ABB2BF">].</span><span style="color:#61AFEF">strip</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">            extracted_parts.</span><span style="color:#61AFEF">append</span><span style="color:#ABB2BF">(extracted_part)</span></span>
<span class="line"><span style="color:#ABB2BF">    </span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#ABB2BF"> extracted_parts</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">dialogues </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> flatten</span><span style="color:#ABB2BF">([</span><span style="color:#61AFEF">extract_dialogues</span><span style="color:#ABB2BF">(scene[</span><span style="color:#98C379">&#39;text&#39;</span><span style="color:#ABB2BF">].</span><span style="color:#61AFEF">split</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;</span><span style="color:#56B6C2">\n</span><span style="color:#98C379">&#39;</span><span style="color:#ABB2BF">)) </span><span style="color:#C678DD">for</span><span style="color:#ABB2BF"> scene </span><span style="color:#C678DD">in</span><span style="color:#ABB2BF"> scenes])</span></span></code></pre>
<p>Now, let’s see if we can use a zero-shot classification model based on BERT to identify dialogues that serve as clear examples of observations or evaluations, while filtering out onomatopoeia, interjections and other irrelevant utterances.</p>
<pre class="astro-code one-dark-pro" style="background-color:#282c34;color:#abb2bf;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word" tabindex="0"><code><span class="line"><span style="color:#C678DD">import</span><span style="color:#ABB2BF"> torch</span></span>
<span class="line"><span style="color:#C678DD">from</span><span style="color:#ABB2BF"> tqdm </span><span style="color:#C678DD">import</span><span style="color:#ABB2BF"> tqdm</span></span>
<span class="line"><span style="color:#C678DD">from</span><span style="color:#ABB2BF"> transformers </span><span style="color:#C678DD">import</span><span style="color:#ABB2BF"> pipeline</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">def</span><span style="color:#61AFEF"> create_classification_table</span><span style="color:#ABB2BF">():</span></span>
<span class="line"><span style="color:#ABB2BF">    conn </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> sqlite3.</span><span style="color:#61AFEF">connect</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;results.sqlite&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">    c </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> conn.</span><span style="color:#61AFEF">cursor</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">    c.</span><span style="color:#61AFEF">execute</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;&#39;&#39;</span></span>
<span class="line"><span style="color:#98C379">        CREATE TABLE IF NOT EXISTS dialogue_bert_classification (</span></span>
<span class="line"><span style="color:#98C379">            id INTEGER PRIMARY KEY,</span></span>
<span class="line"><span style="color:#98C379">            dialogue TEXT,</span></span>
<span class="line"><span style="color:#98C379">            conversation_score REAL,</span></span>
<span class="line"><span style="color:#98C379">            statement_score REAL,</span></span>
<span class="line"><span style="color:#98C379">            ratio REAL</span></span>
<span class="line"><span style="color:#98C379">        )</span></span>
<span class="line"><span style="color:#98C379">    &#39;&#39;&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">    conn.</span><span style="color:#61AFEF">commit</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">    conn.</span><span style="color:#61AFEF">close</span><span style="color:#ABB2BF">()</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">def</span><span style="color:#61AFEF"> insert_classification_result</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66;font-style:italic">dialogue</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66;font-style:italic">conversation_score</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66;font-style:italic">statement_score</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66;font-style:italic">ratio</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#ABB2BF">    conn </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> sqlite3.</span><span style="color:#61AFEF">connect</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;results.sqlite&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">    c </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> conn.</span><span style="color:#61AFEF">cursor</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">    c.</span><span style="color:#61AFEF">execute</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;&#39;&#39;</span></span>
<span class="line"><span style="color:#98C379">        INSERT INTO dialogue_bert_classification (dialogue, conversation_score, statement_score, ratio)</span></span>
<span class="line"><span style="color:#98C379">        VALUES (?, ?, ?, ?)</span></span>
<span class="line"><span style="color:#98C379">    &#39;&#39;&#39;</span><span style="color:#ABB2BF">, (dialogue, conversation_score, statement_score, ratio))</span></span>
<span class="line"><span style="color:#ABB2BF">    conn.</span><span style="color:#61AFEF">commit</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">    conn.</span><span style="color:#61AFEF">close</span><span style="color:#ABB2BF">()</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">def</span><span style="color:#61AFEF"> check_if_classified</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66;font-style:italic">dialogue</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#ABB2BF">    conn </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> sqlite3.</span><span style="color:#61AFEF">connect</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;results.sqlite&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">    c </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> conn.</span><span style="color:#61AFEF">cursor</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    # Prepare the query, using parameter substitution to avoid SQL injection</span></span>
<span class="line"><span style="color:#ABB2BF">    c.</span><span style="color:#61AFEF">execute</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;SELECT id FROM dialogue_bert_classification WHERE dialogue = ?&#39;</span><span style="color:#ABB2BF">, (dialogue,))</span></span>
<span class="line"><span style="color:#ABB2BF">    result </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> c.</span><span style="color:#61AFEF">fetchone</span><span style="color:#ABB2BF">()  </span><span style="color:#7F848E;font-style:italic"># Fetch the first row of results</span></span>
<span class="line"><span style="color:#ABB2BF">    conn.</span><span style="color:#61AFEF">close</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#ABB2BF"> result </span><span style="color:#C678DD">is</span><span style="color:#C678DD"> not</span><span style="color:#D19A66"> None</span><span style="color:#7F848E;font-style:italic">  # Return True if a result was found, otherwise False</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">device </span><span style="color:#56B6C2">=</span><span style="color:#98C379"> &#39;cuda&#39;</span><span style="color:#C678DD"> if</span><span style="color:#ABB2BF"> torch.cuda.</span><span style="color:#61AFEF">is_available</span><span style="color:#ABB2BF">() </span><span style="color:#C678DD">else</span><span style="color:#98C379"> &#39;cpu&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">classifier </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> pipeline</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&quot;zero-shot-classification&quot;</span><span style="color:#ABB2BF">, </span><span style="color:#E06C75;font-style:italic">model</span><span style="color:#56B6C2">=</span><span style="color:#98C379">&quot;MoritzLaurer/DeBERTa-v3-base-mnli-fever-anli&quot;</span><span style="color:#ABB2BF">, </span><span style="color:#E06C75;font-style:italic">device</span><span style="color:#56B6C2">=</span><span style="color:#D19A66">0</span><span style="color:#ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic"># Define the batch size</span></span>
<span class="line"><span style="color:#ABB2BF">batch_size </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 32</span><span style="color:#7F848E;font-style:italic">  # You can adjust this based on your memory constraints</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic"># Function to divide the dataset into batches</span></span>
<span class="line"><span style="color:#C678DD">def</span><span style="color:#61AFEF"> divide_into_batches</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66;font-style:italic">data</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66;font-style:italic">batch_size</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#C678DD">    for</span><span style="color:#ABB2BF"> i </span><span style="color:#C678DD">in</span><span style="color:#56B6C2"> range</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">0</span><span style="color:#ABB2BF">, </span><span style="color:#56B6C2">len</span><span style="color:#ABB2BF">(data), batch_size):</span></span>
<span class="line"><span style="color:#C678DD">        yield</span><span style="color:#ABB2BF"> data[i:i </span><span style="color:#56B6C2">+</span><span style="color:#ABB2BF"> batch_size]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic"># Split the dataset into batches</span></span>
<span class="line"><span style="color:#ABB2BF">batches </span><span style="color:#56B6C2">=</span><span style="color:#56B6C2"> list</span><span style="color:#ABB2BF">(</span><span style="color:#61AFEF">divide_into_batches</span><span style="color:#ABB2BF">(dialogues[</span><span style="color:#D19A66">0</span><span style="color:#ABB2BF">:</span><span style="color:#D19A66">100</span><span style="color:#ABB2BF">], batch_size))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">candidate_labels </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> [</span><span style="color:#98C379">&quot;conversation&quot;</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">&quot;statement&quot;</span><span style="color:#ABB2BF">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">conversation_scores </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> []</span></span>
<span class="line"><span style="color:#ABB2BF">statement_scores </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> []</span></span>
<span class="line"></span>
<span class="line"><span style="color:#61AFEF">create_classification_table</span><span style="color:#ABB2BF">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic"># Process each batch</span></span>
<span class="line"><span style="color:#C678DD">for</span><span style="color:#ABB2BF"> batch </span><span style="color:#C678DD">in</span><span style="color:#61AFEF"> tqdm</span><span style="color:#ABB2BF">(batches):</span></span>
<span class="line"><span style="color:#C678DD">    for</span><span style="color:#ABB2BF"> i, dialogue </span><span style="color:#C678DD">in</span><span style="color:#56B6C2"> enumerate</span><span style="color:#ABB2BF">(batch):</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#61AFEF"> check_if_classified</span><span style="color:#ABB2BF">(dialogue):</span></span>
<span class="line"><span style="color:#C678DD">            continue</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">        output </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> classifier</span><span style="color:#ABB2BF">([dialogue], candidate_labels, </span><span style="color:#E06C75;font-style:italic">multi_label</span><span style="color:#56B6C2">=</span><span style="color:#D19A66">False</span><span style="color:#ABB2BF">)[</span><span style="color:#D19A66">0</span><span style="color:#ABB2BF">]</span></span>
<span class="line"><span style="color:#ABB2BF">        conversation_score </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> output[</span><span style="color:#98C379">&#39;scores&#39;</span><span style="color:#ABB2BF">][</span><span style="color:#D19A66">0</span><span style="color:#ABB2BF">]</span></span>
<span class="line"><span style="color:#ABB2BF">        statement_score </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> output[</span><span style="color:#98C379">&#39;scores&#39;</span><span style="color:#ABB2BF">][</span><span style="color:#D19A66">1</span><span style="color:#ABB2BF">]</span></span>
<span class="line"><span style="color:#ABB2BF">        ratio </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> statement_score </span><span style="color:#56B6C2">/</span><span style="color:#ABB2BF"> conversation_score</span></span>
<span class="line"></span>
<span class="line"><span style="color:#61AFEF">        insert_classification_result</span><span style="color:#ABB2BF">(dialogue, conversation_score, statement_score, ratio)</span></span>
<span class="line"><span style="color:#ABB2BF">        </span></span>
<span class="line"><span style="color:#ABB2BF">df </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> table_as_dataframe</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;dialogue_bert_classification&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">df[</span><span style="color:#98C379">&#39;ratio&#39;</span><span style="color:#ABB2BF">] </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> df.</span><span style="color:#61AFEF">apply</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">lambda</span><span style="color:#D19A66;font-style:italic"> row</span><span style="color:#ABB2BF">: row[</span><span style="color:#98C379">&#39;statement_score&#39;</span><span style="color:#ABB2BF">] </span><span style="color:#56B6C2">/</span><span style="color:#ABB2BF"> row[</span><span style="color:#98C379">&#39;conversation_score&#39;</span><span style="color:#ABB2BF">], </span><span style="color:#E06C75;font-style:italic">axis</span><span style="color:#56B6C2">=</span><span style="color:#D19A66">1</span><span style="color:#ABB2BF">)</span></span></code></pre>
<p>Let’s look at the dialogues that the model classified as statements (or with roughly equal weighting for <em>statement</em> and <em>conversation</em>)<br/>
For that let’s look at the weighting distribution (expressed as ratio of statement score over conversation score)</p>
<pre class="astro-code one-dark-pro" style="background-color:#282c34;color:#abb2bf;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word" tabindex="0"><code><span class="line"><span style="color:#C678DD">import</span><span style="color:#ABB2BF"> matplotlib.pyplot </span><span style="color:#C678DD">as</span><span style="color:#ABB2BF"> plt</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">plt.</span><span style="color:#61AFEF">hist</span><span style="color:#ABB2BF">(df[</span><span style="color:#98C379">&#39;ratio&#39;</span><span style="color:#ABB2BF">], </span><span style="color:#E06C75;font-style:italic">bins</span><span style="color:#56B6C2">=</span><span style="color:#D19A66">10</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">plt.</span><span style="color:#61AFEF">xlabel</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;Statement score ratio&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">plt.</span><span style="color:#61AFEF">ylabel</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;Frequency&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">plt.</span><span style="color:#61AFEF">title</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;Dialogues&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">plt.</span><span style="color:#61AFEF">show</span><span style="color:#ABB2BF">()</span></span></code></pre>
<p><img src="/images/nvc/2.png" alt="image"/></p>
<p>0.8 maybe seems like a good treshold</p>
<p><code>df[df[&#39;ratio&#39;] &gt; 0.8].sort_values(by=&#39;ratio&#39;)[[&#39;dialogue&#39;, &#39;ratio&#39;]]</code></p>
<div class="output-result" data-astro-cid-c5o6katz> 












































<table><thead><tr><th>index</th><th>dialogue</th><th>ratio</th></tr></thead><tbody><tr><td>54</td><td>I’m not gonna watch you do laundry.</td><td>0.821589</td></tr><tr><td>59</td><td>Jerry? I have to tell you something. This is the dullest moment I’ve ever experienced.</td><td>0.871188</td></tr><tr><td>66</td><td>Yeah, but how could you be so sure?</td><td>0.876894</td></tr><tr><td>93</td><td>You know, I almost wound up going to that game.</td><td>0.893139</td></tr><tr><td>12</td><td>Trust me George. No one has any interest in seeing you on caffeine.</td><td>0.923207</td></tr><tr><td>34</td><td>No…no…no, I hate to tell you this. You’re not gonna see this woman.</td><td>0.937720</td></tr><tr><td>11</td><td>Can you relax, it’s a cup of coffee. Claire is a professional waitress.</td><td>0.964591</td></tr></tbody></table> </div> 
<p>These examples aren’t really suitable for our purpose. A lot of them are clearly dialogue excerpts lacking context, they’re not the kind of textbook-style self-contained statements that we’re looking for.</p>
<p>What if instead of using the dialogues directly we fed the scripts to a LLM and asked it to create statements inspired by it?</p>
<p>To get the results we are looking for we will use a convenient little trick. We use the <a href="https://huggingface.co/docs/transformers/chat_templating">chat templates</a> feature of the Hugging Face tokenizer library to feed the model both our user prompt and an affirmation by the model. We basically prefix the model’s answer with a few words of acknowledgment (“<em>Understood. I will now do [description of task]</em>”). The way I understand it, this basically helps the attention layer make associations between the AI answer and user instruction, this in turn seems to generate more relevant answers. If you want the model to remember a particular step you can add it to this part. (“<em>I will do […] while making sure that [important constraint  to remember]</em>”). It can also help with getting a specific format out of the model (“<em>Here are the [things you asked for] in json format : {</em>“)</p>
<p>We use this togeter with the <code>apply_chat_template</code> method of the tokenizer to format the prompt based on our messages.
See the animation below.</p>
<figure class="mx-6"> <img src="/images/nvc/2.webp" alt="ChatML visualization"> <figcaption class="m-0"> <hr class="m-0 mt-2 mb-2"> <p> <p>Impersonated acknowledgment prompting with <a href="https://github.com/MicrosoftDocs/azure-docs/blob/main/articles/ai-services/openai/includes/chat-markup-language.md#working-with-chat-markup-language-chatml">ChatML</a>, <em>red</em> is typed in by a user, <em>blue</em> is language model completion</p> </p> </figcaption> </figure>
<p>With this, we are ready to start generating statements based on the Seinfeld scripts.</p>
<pre class="astro-code one-dark-pro" style="background-color:#282c34;color:#abb2bf;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word" tabindex="0"><code><span class="line"><span style="color:#C678DD">from</span><span style="color:#ABB2BF"> transformers </span><span style="color:#C678DD">import</span><span style="color:#ABB2BF"> AutoTokenizer</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">tokenizer </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> AutoTokenizer.</span><span style="color:#61AFEF">from_pretrained</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;NousResearch/Nous-Hermes-2-Mixtral-8x7B-SFT&#39;</span><span style="color:#ABB2BF">, </span><span style="color:#E06C75;font-style:italic">use_fast</span><span style="color:#56B6C2">=</span><span style="color:#D19A66">True</span><span style="color:#ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic"># our prompt only generates evaluations, we do this because when asking the model for an observation it seems to always start with &quot;I notice&quot;, resulting in non natural sounding statements</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"># instead we will generate only evaluations as there are more naturally occurring in our data</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"># to counteract the imbalance we will later derive observation statements from the evaluations</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">def</span><span style="color:#61AFEF"> make_prompt</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66;font-style:italic">scene</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#ABB2BF">    prompt </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> f</span><span style="color:#98C379">&quot;&quot;&quot;We are working on  a textbook.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">Here is an excerpt</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">```</span></span>
<span class="line"><span style="color:#98C379">To determine your proficiency at discerning between observations and evaluations, complete the following exercise.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">“John was angry with me yesterday for no reason.”</span></span>
<span class="line"><span style="color:#98C379">It is an evaluation</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">“Yesterday evening Nancy bit her fingernails while watching television.”</span></span>
<span class="line"><span style="color:#98C379">It is an observation</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">“Sam didn’t ask for my opinion during the meeting.”</span></span>
<span class="line"><span style="color:#98C379">It is an observation</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">“My father is a good man.”</span></span>
<span class="line"><span style="color:#98C379">It is an evaluation</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">“Janice works too much.”</span></span>
<span class="line"><span style="color:#98C379">It is an evaluation</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">“Henry is aggressive.”</span></span>
<span class="line"><span style="color:#98C379">It is an evaluation</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">“Pam was first in line every day this week.”</span></span>
<span class="line"><span style="color:#98C379">It is an observation</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">“My son often doesn’t brush his teeth.”</span></span>
<span class="line"><span style="color:#98C379">It is an evaluation</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">“Luke told me I didn’t look good in yellow.”</span></span>
<span class="line"><span style="color:#98C379">It is an observation</span></span>
<span class="line"><span style="color:#98C379">```</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">We want to create new examples and statements.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">Read this as inspiration</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">```</span></span>
<span class="line"><span style="color:#D19A66">{</span><span style="color:#ABB2BF">scene</span><span style="color:#D19A66">}</span></span>
<span class="line"><span style="color:#98C379">```</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">Roleplay as one of the characters and make a evaluation statement&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#ABB2BF">    </span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#ABB2BF"> tokenizer.</span><span style="color:#61AFEF">apply_chat_template</span><span style="color:#ABB2BF">([{</span></span>
<span class="line"><span style="color:#98C379">                            &quot;content&quot;</span><span style="color:#ABB2BF">: prompt,</span></span>
<span class="line"><span style="color:#98C379">                            &quot;role&quot;</span><span style="color:#ABB2BF">: </span><span style="color:#98C379">&quot;user&quot;</span></span>
<span class="line"><span style="color:#ABB2BF">                        }], </span><span style="color:#E06C75;font-style:italic">tokenize</span><span style="color:#56B6C2">=</span><span style="color:#D19A66">False</span><span style="color:#ABB2BF">, </span><span style="color:#E06C75;font-style:italic">add_generation_prompt</span><span style="color:#56B6C2">=</span><span style="color:#D19A66">True</span><span style="color:#ABB2BF">) </span><span style="color:#56B6C2">+</span><span style="color:#98C379"> &#39;Understood. I will write a new statement for your NVC textbook by roleplaying as one of the characters in this scene.</span><span style="color:#56B6C2">\n</span><span style="color:#98C379">I will roleplay as&#39;</span><span style="color:#7F848E;font-style:italic"> #[AI completes here] #impersonated acknowledgment</span></span></code></pre>
<astro-accordion data-code="{codeBlock}" data-astro-cid-qbtd5bqq> <button class="accordion-toggle flex items-center text-sm" data-astro-cid-qbtd5bqq><b data-astro-cid-qbtd5bqq>Show Code</b> <svg class="chevron-icon w-6 h-6 -rotate-90 transition-transform transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" data-astro-cid-qbtd5bqq> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" data-astro-cid-qbtd5bqq></path> </svg></button> <div class="code-content hidden" data-astro-cid-qbtd5bqq> <pre class="astro-code one-dark-pro" style="background-color:#282c34;color:#abb2bf;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word" tabindex="0"><code><span class="line"><span style="color:#C678DD">import</span><span style="color:#ABB2BF"> os</span></span>
<span class="line"><span style="color:#C678DD">import</span><span style="color:#ABB2BF"> requests</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D19A66">TOGETHER_API_KEY</span><span style="color:#56B6C2"> =</span><span style="color:#ABB2BF"> os.environ.</span><span style="color:#61AFEF">get</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;TOGETHER_API_KEY&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#C678DD">if</span><span style="color:#D19A66"> TOGETHER_API_KEY</span><span style="color:#C678DD"> is</span><span style="color:#D19A66"> None</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#D19A66">    TOGETHER_API_KEY</span><span style="color:#56B6C2"> =</span><span style="color:#56B6C2"> input</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&quot;Enter your Together API Key: &quot;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D19A66">ENDPOINT_URL</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> &#39;https://api.together.xyz/v1/completions&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">def</span><span style="color:#61AFEF"> generate</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66;font-style:italic">generation_id</span><span style="color:#ABB2BF">=</span><span style="color:#D19A66">0</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66;font-style:italic">max_retries</span><span style="color:#ABB2BF">=</span><span style="color:#D19A66">10</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66;font-style:italic">DEBUG</span><span style="color:#ABB2BF">=</span><span style="color:#D19A66">False</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#C678DD">    for</span><span style="color:#ABB2BF"> attempt </span><span style="color:#C678DD">in</span><span style="color:#56B6C2"> range</span><span style="color:#ABB2BF">(max_retries):</span></span>
<span class="line"><span style="color:#C678DD">        try</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#C678DD">            if</span><span style="color:#D19A66"> DEBUG</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#56B6C2">                print</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">f</span><span style="color:#98C379">&quot;Attempting to generate for ID </span><span style="color:#D19A66">{</span><span style="color:#ABB2BF">generation_id</span><span style="color:#D19A66">}</span><span style="color:#98C379">, attempt </span><span style="color:#D19A66">{</span><span style="color:#ABB2BF">attempt </span><span style="color:#56B6C2">+</span><span style="color:#D19A66"> 1}</span><span style="color:#98C379">&quot;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">            res </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> requests.</span><span style="color:#61AFEF">post</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">ENDPOINT_URL</span><span style="color:#ABB2BF">, </span><span style="color:#E06C75;font-style:italic">json</span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF">{</span></span>
<span class="line"><span style="color:#98C379">                &quot;model&quot;</span><span style="color:#ABB2BF">: </span><span style="color:#98C379">&quot;NousResearch/Nous-Hermes-2-Mixtral-8x7B-SFT&quot;</span><span style="color:#ABB2BF">, </span><span style="color:#7F848E;font-style:italic">#We use SFT version and not DPO because it allegedly is better at creative uses</span></span>
<span class="line"><span style="color:#98C379">                &quot;max_tokens&quot;</span><span style="color:#ABB2BF">: </span><span style="color:#D19A66">512</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#98C379">                &quot;request_type&quot;</span><span style="color:#ABB2BF">: </span><span style="color:#98C379">&quot;language-model-inference&quot;</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#98C379">                &quot;temperature&quot;</span><span style="color:#ABB2BF">: </span><span style="color:#D19A66">0.7</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#98C379">                &quot;top_p&quot;</span><span style="color:#ABB2BF">: </span><span style="color:#D19A66">0.7</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#98C379">                &quot;top_k&quot;</span><span style="color:#ABB2BF">: </span><span style="color:#D19A66">50</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#98C379">                &quot;repetition_penalty&quot;</span><span style="color:#ABB2BF">: </span><span style="color:#D19A66">1</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#98C379">                &quot;stop&quot;</span><span style="color:#ABB2BF">: [</span></span>
<span class="line"><span style="color:#98C379">                    &quot;&lt;|im_end|&gt;&quot;</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#98C379">                    &quot;&lt;|im_start|&gt;&quot;</span></span>
<span class="line"><span style="color:#98C379">                    &quot;</span><span style="color:#56B6C2">\n</span><span style="color:#98C379">&quot;</span></span>
<span class="line"><span style="color:#ABB2BF">                ],</span></span>
<span class="line"><span style="color:#98C379">                &#39;prompt&#39;</span><span style="color:#ABB2BF">: </span><span style="color:#61AFEF">make_prompt</span><span style="color:#ABB2BF">(random.</span><span style="color:#61AFEF">choice</span><span style="color:#ABB2BF">(scene_texts)),</span></span>
<span class="line"><span style="color:#98C379">                &quot;repetitive_penalty&quot;</span><span style="color:#ABB2BF">: </span><span style="color:#D19A66">1</span></span>
<span class="line"><span style="color:#ABB2BF">            }, </span><span style="color:#E06C75;font-style:italic">headers</span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF">{</span><span style="color:#98C379">&quot;Authorization&quot;</span><span style="color:#ABB2BF">: </span><span style="color:#C678DD">f</span><span style="color:#98C379">&quot;Bearer </span><span style="color:#D19A66">{TOGETHER_API_KEY}</span><span style="color:#98C379">&quot;</span><span style="color:#ABB2BF">})</span></span>
<span class="line"><span style="color:#ABB2BF">            </span></span>
<span class="line"><span style="color:#C678DD">            if</span><span style="color:#ABB2BF"> res.status_code </span><span style="color:#56B6C2">==</span><span style="color:#D19A66"> 200</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#ABB2BF">                generation_id </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> res.</span><span style="color:#61AFEF">json</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">get</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;id&#39;</span><span style="color:#ABB2BF">, generation_id)</span></span>
<span class="line"><span style="color:#ABB2BF">                result </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> res.</span><span style="color:#61AFEF">json</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">get</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;choices&#39;</span><span style="color:#ABB2BF">, [{}])[</span><span style="color:#D19A66">0</span><span style="color:#ABB2BF">].</span><span style="color:#61AFEF">get</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;text&#39;</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">&#39;&#39;</span><span style="color:#ABB2BF">).</span><span style="color:#61AFEF">strip</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">                </span></span>
<span class="line"><span style="color:#C678DD">                if</span><span style="color:#D19A66"> DEBUG</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#56B6C2">                    print</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">f</span><span style="color:#98C379">&quot;Success: Generation ID </span><span style="color:#D19A66">{</span><span style="color:#ABB2BF">generation_id</span><span style="color:#D19A66">}</span><span style="color:#98C379">, Result: </span><span style="color:#D19A66">{</span><span style="color:#ABB2BF">result[:</span><span style="color:#D19A66">250</span><span style="color:#ABB2BF">]</span><span style="color:#D19A66">}</span><span style="color:#98C379">...&quot;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#C678DD">                return</span><span style="color:#ABB2BF"> generation_id, result</span></span>
<span class="line"><span style="color:#C678DD">            else</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#56B6C2">                print</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">f</span><span style="color:#98C379">&#39;API error: </span><span style="color:#D19A66">{</span><span style="color:#ABB2BF">res.status_code</span><span style="color:#D19A66">}</span><span style="color:#98C379">, attempt </span><span style="color:#D19A66">{</span><span style="color:#ABB2BF">attempt </span><span style="color:#56B6C2">+</span><span style="color:#D19A66"> 1}</span><span style="color:#98C379"> of </span><span style="color:#D19A66">{</span><span style="color:#ABB2BF">max_retries</span><span style="color:#D19A66">}</span><span style="color:#98C379">&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#C678DD">        except</span><span style="color:#ABB2BF"> KeyboardInterrupt:</span></span>
<span class="line"><span style="color:#56B6C2">            print</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&quot;KeyboardInterrupt received, stopping generation&quot;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#C678DD">            break</span></span>
<span class="line"><span style="color:#C678DD">        except</span><span style="color:#ABB2BF"> Exception </span><span style="color:#C678DD">as</span><span style="color:#ABB2BF"> e:</span></span>
<span class="line"><span style="color:#56B6C2">            print</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">f</span><span style="color:#98C379">&#39;Exception occurred for generation_id </span><span style="color:#D19A66">{</span><span style="color:#ABB2BF">generation_id</span><span style="color:#D19A66">}</span><span style="color:#98C379">: </span><span style="color:#D19A66">{</span><span style="color:#ABB2BF">e</span><span style="color:#D19A66">}</span><span style="color:#98C379">&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#ABB2BF"> generation_id, </span><span style="color:#D19A66">None</span></span></code></pre> </div> </astro-accordion>  
<pre class="astro-code one-dark-pro" style="background-color:#282c34;color:#abb2bf;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word" tabindex="0"><code><span class="line"><span style="color:#C678DD">import</span><span style="color:#ABB2BF"> copy</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">def</span><span style="color:#61AFEF"> create_scene_statements_table</span><span style="color:#ABB2BF">():</span></span>
<span class="line"><span style="color:#ABB2BF">    conn </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> sqlite3.</span><span style="color:#61AFEF">connect</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;results.sqlite&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">    c </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> conn.</span><span style="color:#61AFEF">cursor</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">    c.</span><span style="color:#61AFEF">execute</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;&#39;&#39;</span></span>
<span class="line"><span style="color:#98C379">        CREATE TABLE IF NOT EXISTS scene_statements (</span></span>
<span class="line"><span style="color:#98C379">            id INTEGER PRIMARY KEY,</span></span>
<span class="line"><span style="color:#98C379">            scene TEXT,</span></span>
<span class="line"><span style="color:#98C379">            prompt TEXT,</span></span>
<span class="line"><span style="color:#98C379">            generation TEXT,</span></span>
<span class="line"><span style="color:#98C379">            generation_params json</span></span>
<span class="line"><span style="color:#98C379">        )</span></span>
<span class="line"><span style="color:#98C379">    &#39;&#39;&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">    conn.</span><span style="color:#61AFEF">commit</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">    conn.</span><span style="color:#61AFEF">close</span><span style="color:#ABB2BF">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">def</span><span style="color:#61AFEF"> insert_scene_statement</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66;font-style:italic">scene</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66;font-style:italic">prompt</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66;font-style:italic">generation</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66;font-style:italic">generation_params</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#ABB2BF">    conn </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> sqlite3.</span><span style="color:#61AFEF">connect</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;results.sqlite&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">    c </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> conn.</span><span style="color:#61AFEF">cursor</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">    </span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    # Check if the scene with the same prompt already exists</span></span>
<span class="line"><span style="color:#ABB2BF">    c.</span><span style="color:#61AFEF">execute</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;&#39;&#39;</span></span>
<span class="line"><span style="color:#98C379">        SELECT COUNT(*) FROM scene_statements WHERE scene = ? AND prompt = ?</span></span>
<span class="line"><span style="color:#98C379">    &#39;&#39;&#39;</span><span style="color:#ABB2BF">, (scene, prompt))</span></span>
<span class="line"><span style="color:#ABB2BF">    exists </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> c.</span><span style="color:#61AFEF">fetchone</span><span style="color:#ABB2BF">()[</span><span style="color:#D19A66">0</span><span style="color:#ABB2BF">] </span><span style="color:#56B6C2">&gt;</span><span style="color:#D19A66"> 0</span></span>
<span class="line"><span style="color:#ABB2BF">    </span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    # If it doesn&#39;t exist, insert the new row</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#C678DD"> not</span><span style="color:#ABB2BF"> exists:</span></span>
<span class="line"><span style="color:#ABB2BF">        c.</span><span style="color:#61AFEF">execute</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;&#39;&#39;</span></span>
<span class="line"><span style="color:#98C379">            INSERT INTO scene_statements (scene, prompt, generation, generation_params)</span></span>
<span class="line"><span style="color:#98C379">            VALUES (?, ?, ?, ?)</span></span>
<span class="line"><span style="color:#98C379">        &#39;&#39;&#39;</span><span style="color:#ABB2BF">, (scene, prompt, generation, json.</span><span style="color:#61AFEF">dumps</span><span style="color:#ABB2BF">(generation_params)))</span></span>
<span class="line"><span style="color:#ABB2BF">        conn.</span><span style="color:#61AFEF">commit</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#C678DD">    else</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#56B6C2">        print</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&quot;Entry already exists for scene and prompt, skipping insert.&quot;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">    </span></span>
<span class="line"><span style="color:#ABB2BF">    conn.</span><span style="color:#61AFEF">close</span><span style="color:#ABB2BF">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">def</span><span style="color:#61AFEF"> get_generated_statement_for_scene_prompt</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66;font-style:italic">prompt</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#ABB2BF">    conn </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> sqlite3.</span><span style="color:#61AFEF">connect</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;results.sqlite&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">    c </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> conn.</span><span style="color:#61AFEF">cursor</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    # Query to find an existing generation for the given prompt</span></span>
<span class="line"><span style="color:#ABB2BF">    c.</span><span style="color:#61AFEF">execute</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;&#39;&#39;</span></span>
<span class="line"><span style="color:#98C379">        SELECT generation FROM scene_statements WHERE prompt = ?</span></span>
<span class="line"><span style="color:#98C379">    &#39;&#39;&#39;</span><span style="color:#ABB2BF">, (prompt,))</span></span>
<span class="line"><span style="color:#ABB2BF">    result </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> c.</span><span style="color:#61AFEF">fetchone</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">    conn.</span><span style="color:#61AFEF">close</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#ABB2BF"> result[</span><span style="color:#D19A66">0</span><span style="color:#ABB2BF">] </span><span style="color:#C678DD">if</span><span style="color:#ABB2BF"> result </span><span style="color:#C678DD">else</span><span style="color:#D19A66"> None</span></span>
<span class="line"><span style="color:#ABB2BF">    </span></span>
<span class="line"><span style="color:#C678DD">def</span><span style="color:#61AFEF"> generate_statement_from_scene</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66;font-style:italic">scene</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66;font-style:italic">max_retries</span><span style="color:#ABB2BF">=</span><span style="color:#D19A66">10</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#ABB2BF">    generation_params </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#98C379">        &quot;model&quot;</span><span style="color:#ABB2BF">: </span><span style="color:#98C379">&quot;NousResearch/Nous-Hermes-2-Mixtral-8x7B-SFT&quot;</span><span style="color:#ABB2BF">,  </span><span style="color:#7F848E;font-style:italic"># We use SFT version and not DPO because it is allegedly better at creative uses</span></span>
<span class="line"><span style="color:#98C379">        &quot;max_tokens&quot;</span><span style="color:#ABB2BF">: </span><span style="color:#D19A66">512</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#98C379">        &quot;temperature&quot;</span><span style="color:#ABB2BF">: </span><span style="color:#D19A66">0.7</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#98C379">        &quot;top_p&quot;</span><span style="color:#ABB2BF">: </span><span style="color:#D19A66">0.7</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#98C379">        &quot;top_k&quot;</span><span style="color:#ABB2BF">: </span><span style="color:#D19A66">50</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#98C379">        &quot;stop&quot;</span><span style="color:#ABB2BF">: [</span></span>
<span class="line"><span style="color:#98C379">            &quot;&lt;|im_end|&gt;&quot;</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#98C379">            &quot;&lt;|im_start|&gt;&quot;</span></span>
<span class="line"><span style="color:#ABB2BF">        ],</span></span>
<span class="line"><span style="color:#98C379">        &quot;repetition_penalty&quot;</span><span style="color:#ABB2BF">: </span><span style="color:#D19A66">1</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    prompt </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> make_prompt</span><span style="color:#ABB2BF">(scene)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#56B6C2"> len</span><span style="color:#ABB2BF">(tokenizer.</span><span style="color:#61AFEF">encode</span><span style="color:#ABB2BF">(prompt)) </span><span style="color:#56B6C2">&gt;</span><span style="color:#D19A66"> 32768</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#D19A66"> None</span><span style="color:#7F848E;font-style:italic"> # Skip prompts that are too long</span></span>
<span class="line"><span style="color:#ABB2BF">        </span></span>
<span class="line"><span style="color:#ABB2BF">    </span></span>
<span class="line"><span style="color:#ABB2BF">    existing_generation </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> get_generated_statement_for_scene_prompt</span><span style="color:#ABB2BF">(prompt)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#ABB2BF"> existing_generation </span><span style="color:#C678DD">is</span><span style="color:#C678DD"> not</span><span style="color:#D19A66"> None</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#56B6C2">        print</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&quot;Found existing generation for prompt&quot;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#D19A66"> None</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    retries </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 0</span></span>
<span class="line"><span style="color:#C678DD">    while</span><span style="color:#ABB2BF"> retries </span><span style="color:#56B6C2">&lt;</span><span style="color:#ABB2BF"> max_retries:</span></span>
<span class="line"><span style="color:#C678DD">        try</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#ABB2BF">            res </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> requests.</span><span style="color:#61AFEF">post</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">ENDPOINT_URL</span><span style="color:#ABB2BF">, </span><span style="color:#E06C75;font-style:italic">json</span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF">{</span></span>
<span class="line"><span style="color:#56B6C2">                **</span><span style="color:#ABB2BF">generation_params,</span></span>
<span class="line"><span style="color:#98C379">                &quot;prompt&quot;</span><span style="color:#ABB2BF">: prompt,</span></span>
<span class="line"><span style="color:#ABB2BF">            }, </span><span style="color:#E06C75;font-style:italic">headers</span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF">{</span></span>
<span class="line"><span style="color:#98C379">                &quot;Authorization&quot;</span><span style="color:#ABB2BF">: </span><span style="color:#C678DD">f</span><span style="color:#98C379">&quot;Bearer </span><span style="color:#D19A66">{TOGETHER_API_KEY}</span><span style="color:#98C379">&quot;</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#ABB2BF">            })</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">            if</span><span style="color:#ABB2BF"> res.status_code </span><span style="color:#56B6C2">==</span><span style="color:#D19A66"> 200</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#C678DD">                return</span><span style="color:#ABB2BF"> scene, prompt, res.</span><span style="color:#61AFEF">json</span><span style="color:#ABB2BF">()[</span><span style="color:#98C379">&#39;choices&#39;</span><span style="color:#ABB2BF">][</span><span style="color:#D19A66">0</span><span style="color:#ABB2BF">][</span><span style="color:#98C379">&#39;text&#39;</span><span style="color:#ABB2BF">], generation_params</span></span>
<span class="line"><span style="color:#C678DD">            else</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#ABB2BF">                error_message </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> res.text</span></span>
<span class="line"><span style="color:#56B6C2">                print</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">f</span><span style="color:#98C379">&quot;Attempt </span><span style="color:#D19A66">{</span><span style="color:#ABB2BF">retries </span><span style="color:#56B6C2">+</span><span style="color:#D19A66"> 1}</span><span style="color:#98C379"> failed with status code </span><span style="color:#D19A66">{</span><span style="color:#ABB2BF">res.status_code</span><span style="color:#D19A66">}</span><span style="color:#98C379">. Error: </span><span style="color:#D19A66">{</span><span style="color:#ABB2BF">error_message</span><span style="color:#D19A66">}</span><span style="color:#98C379">. Retrying...&quot;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#C678DD">        except</span><span style="color:#ABB2BF"> requests.exceptions.RequestException </span><span style="color:#C678DD">as</span><span style="color:#ABB2BF"> e:</span></span>
<span class="line"><span style="color:#56B6C2">            print</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">f</span><span style="color:#98C379">&quot;An error occurred: </span><span style="color:#D19A66">{</span><span style="color:#ABB2BF">e</span><span style="color:#D19A66">}</span><span style="color:#98C379">. Retrying...&quot;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">        retries </span><span style="color:#56B6C2">+=</span><span style="color:#D19A66"> 1</span></span>
<span class="line"><span style="color:#ABB2BF">        time.</span><span style="color:#61AFEF">sleep</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">1</span><span style="color:#ABB2BF">)  </span><span style="color:#7F848E;font-style:italic"># Sleep for a bit before retrying to avoid overwhelming the server</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#D19A66"> None</span></span>
<span class="line"><span style="color:#ABB2BF">    </span></span>
<span class="line"><span style="color:#ABB2BF">scene_texts </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> [scene[</span><span style="color:#98C379">&#39;text&#39;</span><span style="color:#ABB2BF">] </span><span style="color:#C678DD">for</span><span style="color:#ABB2BF"> scene </span><span style="color:#C678DD">in</span><span style="color:#ABB2BF"> scenes][</span><span style="color:#D19A66">0</span><span style="color:#ABB2BF">:</span><span style="color:#D19A66">30</span><span style="color:#ABB2BF">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">arguments_list </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> scene_texts</span></span>
<span class="line"><span style="color:#ABB2BF">generator </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> Generator</span><span style="color:#ABB2BF">(</span><span style="color:#E06C75;font-style:italic">max_workers</span><span style="color:#56B6C2">=</span><span style="color:#D19A66">20</span><span style="color:#ABB2BF">, </span><span style="color:#E06C75;font-style:italic">generate_function</span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF">generate_statement_from_scene, </span><span style="color:#E06C75;font-style:italic">arguments_list</span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF">arguments_list)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#61AFEF">create_scene_statements_table</span><span style="color:#ABB2BF">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">for</span><span style="color:#ABB2BF"> result </span><span style="color:#C678DD">in</span><span style="color:#61AFEF"> tqdm</span><span style="color:#ABB2BF">(generator, </span><span style="color:#E06C75;font-style:italic">total</span><span style="color:#56B6C2">=len</span><span style="color:#ABB2BF">(arguments_list)):</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#ABB2BF"> result </span><span style="color:#C678DD">is</span><span style="color:#C678DD"> not</span><span style="color:#D19A66"> None</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#ABB2BF">        scene, prompt, generation, generation_params </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> result</span></span>
<span class="line"><span style="color:#61AFEF">        insert_scene_statement</span><span style="color:#ABB2BF">(scene, prompt, generation, generation_params)</span></span></code></pre>
<p>Let’s look at the newly generated statements:</p>
<p><code>table_as_dataframe(&#39;scene_statements&#39;)[[&#39;generation&#39;]]</code></p>
<div class="output-result" data-astro-cid-c5o6katz> 




















































<table><thead><tr><th>index</th><th>generation</th></tr></thead><tbody><tr><td>0</td><td>Elaine and make an evaluation statement.\n”Jerry, your constant interruptions during our conversations are really frustrating.”</td></tr><tr><td>1</td><td>Jerry and make an evaluation statement.\nJerry: “Performing on stage is one of the most exhilarating experiences I’ve ever had.”</td></tr><tr><td>2</td><td>Helen and make an evaluation statement.\n”Jerry, you’re always so worried about what other people think. It’s exhausting to watch.”</td></tr><tr><td>3</td><td>Jerry and make an evaluation statement.\n”Jerry: (thinking) Vanessa is the most captivating woman I’ve ever met.”</td></tr><tr><td>4</td><td>Helen, Jerry’s mother.\n”I think Jerry should just ask Elaine for the number instead of waiting for the other woman in the lobby.”</td></tr><tr><td>…</td><td>…</td></tr><tr><td>3643</td><td>Jerry Seinfeld. Here’s the statement:\n”Jerry Seinfeld felt embarrassed when he had to wear the puffy shirt on the Today Show.”\nThis statement is an evaluation because it expresses Jerry’s emotional response to the situation.</td></tr><tr><td>3644</td><td>Elaine and make an evaluation statement.\nElaine: “The Soup Nazi’s soup is the best I’ve ever tasted.”</td></tr><tr><td>3645</td><td>Jane Wells.\nStatement: “The endless parade of witnesses who have come forth so enthusiastically to testify against these four seemingly ordinary people has left the courtroom and everyone who has attended this trial in a state of shock and disbelief.”</td></tr><tr><td>3646</td><td>Babu Bhatt and make an evaluation statement.\n”Jerry and Elaine’s constant mocking of me and my restaurant has deeply hurt my feelings and damaged my reputation. They are not good people.”</td></tr><tr><td>3647</td><td>Estelle, George’s mother, and make an evaluation statement.\nEstelle: “Judge Vandelay, I truly believe that my son George is a good person at heart, despite the unfortunate situation he finds himself in.”</td></tr></tbody></table> </div> 
<p>That looks good, it just need a big of cleaning to remove extra text. We could try and conjure some regex magic but instead we will just prompt the model again and ask it to clean the string the way we want. And while we are at it we will also ask the LLM to change the names in the statement so we don’t end up with a dataset biased towards people named ‘Jerry’, ‘George’ or ‘Elaine’. To ensure a nice distribution of names we will provide the LLM with a random list of names to choose from. The <code>faker</code> library can help with that.</p>
<pre class="astro-code one-dark-pro" style="background-color:#282c34;color:#abb2bf;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word" tabindex="0"><code><span class="line"><span>!pip install faker</span></span></code></pre>
<pre class="astro-code one-dark-pro" style="background-color:#282c34;color:#abb2bf;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word" tabindex="0"><code><span class="line"><span style="color:#C678DD">import</span><span style="color:#ABB2BF"> random</span></span>
<span class="line"><span style="color:#C678DD">from</span><span style="color:#ABB2BF"> transformers </span><span style="color:#C678DD">import</span><span style="color:#ABB2BF"> AutoTokenizer</span></span>
<span class="line"><span style="color:#C678DD">from</span><span style="color:#ABB2BF"> faker </span><span style="color:#C678DD">import</span><span style="color:#ABB2BF"> Faker</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">fake </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> Faker</span><span style="color:#ABB2BF">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">tokenizer </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> AutoTokenizer.</span><span style="color:#61AFEF">from_pretrained</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;teknium/OpenHermes-2.5-Mistral-7B&#39;</span><span style="color:#ABB2BF">, </span><span style="color:#E06C75;font-style:italic">use_fast</span><span style="color:#56B6C2">=</span><span style="color:#D19A66">True</span><span style="color:#ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">nl </span><span style="color:#56B6C2">=</span><span style="color:#98C379"> &#39;</span><span style="color:#56B6C2">\n</span><span style="color:#98C379">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic"># cleaning prompt with few shot examples</span></span>
<span class="line"><span style="color:#C678DD">def</span><span style="color:#61AFEF"> clean_prompt</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66;font-style:italic">input</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#C678DD"> f</span><span style="color:#98C379">&quot;&quot;&quot;Rewrite what is verbally stated in the input given by the user, excluding any preambles or introductions that are not part of the direct speech. The output should be enclosed in curly quotation marks.</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">examples:</span></span>
<span class="line"><span style="color:#98C379">---</span></span>
<span class="line"><span style="color:#98C379">USER:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">input</span></span>
<span class="line"><span style="color:#98C379">```</span></span>
<span class="line"><span style="color:#98C379">Elaine. Statement: &quot;Elaine&#39;s ability to adapt and maintain her composure in unfamiliar situations is truly impressive.&quot;</span></span>
<span class="line"><span style="color:#98C379">```</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">names_to_choose_from</span></span>
<span class="line"><span style="color:#98C379">```</span></span>
<span class="line"><span style="color:#98C379">Alicia</span></span>
<span class="line"><span style="color:#98C379">Nancy</span></span>
<span class="line"><span style="color:#98C379">Robertson</span></span>
<span class="line"><span style="color:#98C379">Gonzales</span></span>
<span class="line"><span style="color:#98C379">Vega</span></span>
<span class="line"><span style="color:#98C379">```</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">ASSISTANT: There was a stray &quot;Elaine&quot; leading the input, and also the string &quot;Statement. :&quot; I removed both.</span></span>
<span class="line"><span style="color:#98C379">In addition, within the statement I found the following name : Elaine.</span></span>
<span class="line"><span style="color:#98C379">I made sure to replace those names with ones you gave me.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">Cleaned statement : “Mckay&#39;s ability to adapt and maintain his composure in unfamiliar situations is truly impressive.”</span></span>
<span class="line"><span style="color:#98C379">USER:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">input</span></span>
<span class="line"><span style="color:#98C379">```</span></span>
<span class="line"><span style="color:#98C379">George and make an evaluation statement.</span></span>
<span class="line"><span style="color:#98C379">&quot;I think the new scoreboard will make a significant impact on the fans&#39; experience at the games.&quot;</span></span>
<span class="line"><span style="color:#98C379">```</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">names_to_choose_from</span></span>
<span class="line"><span style="color:#98C379">```</span></span>
<span class="line"><span style="color:#98C379">Ronald</span></span>
<span class="line"><span style="color:#98C379">Mckay</span></span>
<span class="line"><span style="color:#98C379">Emily</span></span>
<span class="line"><span style="color:#98C379">Vargas</span></span>
<span class="line"><span style="color:#98C379">Michelle</span></span>
<span class="line"><span style="color:#98C379">```</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">Output:</span></span>
<span class="line"><span style="color:#98C379">ASSISTANT: The input contains a statement but has a preamble &quot;George and make an evaluation statement.</span><span style="color:#56B6C2">\n</span><span style="color:#98C379">&quot;. I made sure to remove it.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">Cleaned statement : “I think the new scoreboard will make a significant impact on the fans&#39; experience at the games”</span></span>
<span class="line"><span style="color:#98C379">USER:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">input:</span></span>
<span class="line"><span style="color:#98C379">```</span></span>
<span class="line"><span style="color:#98C379">Jerry and make an evaluation statement.</span></span>
<span class="line"><span style="color:#98C379">Statement: &quot;It&#39;s ridiculous that we have to come to this party and pretend to be happy for Carol and Larry when we&#39;re actually miserable because of the apartment situation.&quot;</span></span>
<span class="line"><span style="color:#98C379">```</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">names_to_choose_from</span></span>
<span class="line"><span style="color:#98C379">```</span></span>
<span class="line"><span style="color:#98C379">Justin</span></span>
<span class="line"><span style="color:#98C379">Smith</span></span>
<span class="line"><span style="color:#98C379">Harrington</span></span>
<span class="line"><span style="color:#98C379">Graves</span></span>
<span class="line"><span style="color:#98C379">Carr</span></span>
<span class="line"><span style="color:#98C379">Sanchez</span></span>
<span class="line"><span style="color:#98C379">Page</span></span>
<span class="line"><span style="color:#98C379">Randall</span></span>
<span class="line"><span style="color:#98C379">```</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">ASSISTANT: The input contains a statement but has a preamble &quot;Jerry and make an evaluation statement.&quot;. I made sure to remove it.</span></span>
<span class="line"><span style="color:#98C379">In addition, within the statement I found the following name: Carol, Larry.</span></span>
<span class="line"><span style="color:#98C379">I made sure to replace those names with ones you gave me.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">Cleaned statement : “It&#39;s ridiculous that we have to come to this party and pretend to be happy for Justin and Randall when we&#39;re actually miserable because of the apartment situation.”</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">USER:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">input</span></span>
<span class="line"><span style="color:#98C379">```</span></span>
<span class="line"><span style="color:#D19A66">{</span><span style="color:#56B6C2">input</span><span style="color:#D19A66">}</span></span>
<span class="line"><span style="color:#98C379">```</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">names_to_choose_from</span></span>
<span class="line"><span style="color:#98C379">```</span></span>
<span class="line"><span style="color:#D19A66">{</span><span style="color:#ABB2BF">nl.</span><span style="color:#61AFEF">join</span><span style="color:#ABB2BF">([random.</span><span style="color:#61AFEF">choice</span><span style="color:#ABB2BF">([fake.</span><span style="color:#61AFEF">first_name</span><span style="color:#ABB2BF">(), fake.</span><span style="color:#61AFEF">last_name</span><span style="color:#ABB2BF">()]) </span><span style="color:#C678DD">for</span><span style="color:#ABB2BF"> e </span><span style="color:#C678DD">in</span><span style="color:#56B6C2"> range</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">35</span><span style="color:#ABB2BF">)]) # </span><span style="color:#C678DD">in</span><span style="color:#ABB2BF"> the </span><span style="color:#56B6C2">list</span><span style="color:#ABB2BF"> of names we randomly choose either a first name </span><span style="color:#C678DD">or</span><span style="color:#ABB2BF"> a last name to ensure even more variety</span><span style="color:#D19A66">}</span></span>
<span class="line"><span style="color:#98C379">```&quot;&quot;&quot;</span></span></code></pre>
<astro-accordion data-code="{codeBlock}" data-astro-cid-qbtd5bqq> <button class="accordion-toggle flex items-center text-sm" data-astro-cid-qbtd5bqq><b data-astro-cid-qbtd5bqq>Show Code</b> <svg class="chevron-icon w-6 h-6 -rotate-90 transition-transform transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" data-astro-cid-qbtd5bqq> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" data-astro-cid-qbtd5bqq></path> </svg></button> <div class="code-content hidden" data-astro-cid-qbtd5bqq> <pre class="astro-code one-dark-pro" style="background-color:#282c34;color:#abb2bf;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word" tabindex="0"><code><span class="line"><span style="color:#C678DD">def</span><span style="color:#61AFEF"> create_table_for_clean_statements</span><span style="color:#ABB2BF">():</span></span>
<span class="line"><span style="color:#ABB2BF">    conn </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> sqlite3.</span><span style="color:#61AFEF">connect</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;results.sqlite&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">    c </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> conn.</span><span style="color:#61AFEF">cursor</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">    c.</span><span style="color:#61AFEF">execute</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;&#39;&#39;</span></span>
<span class="line"><span style="color:#98C379">        CREATE TABLE IF NOT EXISTS clean_statements (</span></span>
<span class="line"><span style="color:#98C379">            id INTEGER PRIMARY KEY,</span></span>
<span class="line"><span style="color:#98C379">            initial_statement TEXT UNIQUE,</span></span>
<span class="line"><span style="color:#98C379">            prompt TEXT UNIQUE,</span></span>
<span class="line"><span style="color:#98C379">            generation TEXT,</span></span>
<span class="line"><span style="color:#98C379">            generation_params json</span></span>
<span class="line"><span style="color:#98C379">        )</span></span>
<span class="line"><span style="color:#98C379">    &#39;&#39;&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">    conn.</span><span style="color:#61AFEF">commit</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">    conn.</span><span style="color:#61AFEF">close</span><span style="color:#ABB2BF">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">def</span><span style="color:#61AFEF"> insert_clean_statement</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66;font-style:italic">initial_statement</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66;font-style:italic">prompt</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66;font-style:italic">generation</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66;font-style:italic">generation_params</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#ABB2BF">    conn </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> sqlite3.</span><span style="color:#61AFEF">connect</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;results.sqlite&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">    c </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> conn.</span><span style="color:#61AFEF">cursor</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">    </span></span>
<span class="line"><span style="color:#C678DD">    try</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#ABB2BF">        c.</span><span style="color:#61AFEF">execute</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;&#39;&#39;</span></span>
<span class="line"><span style="color:#98C379">            INSERT INTO clean_statements (initial_statement, prompt, generation, generation_params)</span></span>
<span class="line"><span style="color:#98C379">            VALUES (?, ?, ?, ?)</span></span>
<span class="line"><span style="color:#98C379">        &#39;&#39;&#39;</span><span style="color:#ABB2BF">, (initial_statement, prompt, generation, json.</span><span style="color:#61AFEF">dumps</span><span style="color:#ABB2BF">(generation_params)))</span></span>
<span class="line"><span style="color:#ABB2BF">        conn.</span><span style="color:#61AFEF">commit</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#C678DD">    except</span><span style="color:#ABB2BF"> sqlite3.IntegrityError:</span></span>
<span class="line"><span style="color:#56B6C2">        print</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&quot;Entry already exists for prompt, skipping insert.&quot;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">    </span></span>
<span class="line"><span style="color:#ABB2BF">    conn.</span><span style="color:#61AFEF">close</span><span style="color:#ABB2BF">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">def</span><span style="color:#61AFEF"> get_clean_generation_for_statement_prompt</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66;font-style:italic">prompt</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#ABB2BF">    conn </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> sqlite3.</span><span style="color:#61AFEF">connect</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;results.sqlite&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">    c </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> conn.</span><span style="color:#61AFEF">cursor</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">    c.</span><span style="color:#61AFEF">execute</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;&#39;&#39;</span></span>
<span class="line"><span style="color:#98C379">        SELECT generation FROM clean_statements WHERE prompt = ?</span></span>
<span class="line"><span style="color:#98C379">    &#39;&#39;&#39;</span><span style="color:#ABB2BF">, (prompt,))</span></span>
<span class="line"><span style="color:#ABB2BF">    result </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> c.</span><span style="color:#61AFEF">fetchone</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">    conn.</span><span style="color:#61AFEF">close</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#ABB2BF"> result[</span><span style="color:#D19A66">0</span><span style="color:#ABB2BF">] </span><span style="color:#C678DD">if</span><span style="color:#ABB2BF"> result </span><span style="color:#C678DD">else</span><span style="color:#D19A66"> None</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">def</span><span style="color:#61AFEF"> clean_and_generate</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66;font-style:italic">statement</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66;font-style:italic">max_retries</span><span style="color:#ABB2BF">=</span><span style="color:#D19A66">10</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#ABB2BF">    generation_params </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#98C379">        &quot;model&quot;</span><span style="color:#ABB2BF">: </span><span style="color:#98C379">&quot;teknium/OpenHermes-2p5-Mistral-7B&quot;</span><span style="color:#ABB2BF">, </span><span style="color:#7F848E;font-style:italic"># A 7B model will do the job here</span></span>
<span class="line"><span style="color:#98C379">        &quot;max_tokens&quot;</span><span style="color:#ABB2BF">: </span><span style="color:#D19A66">512</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#98C379">        &quot;temperature&quot;</span><span style="color:#ABB2BF">: </span><span style="color:#D19A66">0.5</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#98C379">        &quot;top_p&quot;</span><span style="color:#ABB2BF">: </span><span style="color:#D19A66">0.4</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#98C379">        &quot;top_k&quot;</span><span style="color:#ABB2BF">: </span><span style="color:#D19A66">50</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#98C379">        &quot;stop&quot;</span><span style="color:#ABB2BF">: [</span></span>
<span class="line"><span style="color:#98C379">            &quot;&lt;|end_of_turn|&gt;&quot;</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#98C379">            &quot;&lt;/s&gt;&quot;</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#98C379">            &quot;”&quot;</span></span>
<span class="line"><span style="color:#ABB2BF">        ],</span></span>
<span class="line"><span style="color:#98C379">        &quot;repetition_penalty&quot;</span><span style="color:#ABB2BF">: </span><span style="color:#D19A66">1</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">    </span></span>
<span class="line"><span style="color:#ABB2BF">    prompt </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> tokenizer.</span><span style="color:#61AFEF">apply_chat_template</span><span style="color:#ABB2BF">([</span></span>
<span class="line"><span style="color:#ABB2BF">         {</span></span>
<span class="line"><span style="color:#98C379">             &quot;role&quot;</span><span style="color:#ABB2BF">: </span><span style="color:#98C379">&quot;user&quot;</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#98C379">             &quot;content&quot;</span><span style="color:#ABB2BF">: </span><span style="color:#61AFEF">clean_prompt</span><span style="color:#ABB2BF">(statement) }], </span><span style="color:#E06C75;font-style:italic">tokenize</span><span style="color:#56B6C2">=</span><span style="color:#D19A66">False</span><span style="color:#ABB2BF">, </span><span style="color:#E06C75;font-style:italic">add_generation_prompt</span><span style="color:#56B6C2">=</span><span style="color:#D19A66">True</span><span style="color:#ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    existing_generation </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> get_clean_generation_for_statement_prompt</span><span style="color:#ABB2BF">(prompt)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#ABB2BF"> existing_generation </span><span style="color:#C678DD">is</span><span style="color:#C678DD"> not</span><span style="color:#D19A66"> None</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#56B6C2">        print</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&quot;Found existing generation for prompt&quot;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#D19A66"> None</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    retries </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 0</span></span>
<span class="line"><span style="color:#C678DD">    while</span><span style="color:#ABB2BF"> retries </span><span style="color:#56B6C2">&lt;</span><span style="color:#ABB2BF"> max_retries:</span></span>
<span class="line"><span style="color:#C678DD">        try</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#ABB2BF">            res </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> requests.</span><span style="color:#61AFEF">post</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">ENDPOINT_URL</span><span style="color:#ABB2BF">, </span><span style="color:#E06C75;font-style:italic">json</span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF">{</span></span>
<span class="line"><span style="color:#56B6C2">                **</span><span style="color:#ABB2BF">generation_params,</span></span>
<span class="line"><span style="color:#98C379">                &quot;prompt&quot;</span><span style="color:#ABB2BF">: prompt,</span></span>
<span class="line"><span style="color:#ABB2BF">            }, </span><span style="color:#E06C75;font-style:italic">headers</span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF">{</span></span>
<span class="line"><span style="color:#98C379">                &quot;Authorization&quot;</span><span style="color:#ABB2BF">: </span><span style="color:#C678DD">f</span><span style="color:#98C379">&quot;Bearer </span><span style="color:#D19A66">{TOGETHER_API_KEY}</span><span style="color:#98C379">&quot;</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#ABB2BF">            })</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">            if</span><span style="color:#ABB2BF"> res.status_code </span><span style="color:#56B6C2">==</span><span style="color:#D19A66"> 200</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#C678DD">                return</span><span style="color:#ABB2BF"> statement, prompt, res.</span><span style="color:#61AFEF">json</span><span style="color:#ABB2BF">()[</span><span style="color:#98C379">&#39;choices&#39;</span><span style="color:#ABB2BF">][</span><span style="color:#D19A66">0</span><span style="color:#ABB2BF">][</span><span style="color:#98C379">&#39;text&#39;</span><span style="color:#ABB2BF">], generation_params</span></span>
<span class="line"><span style="color:#C678DD">            else</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#ABB2BF">                error_message </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> res.text</span></span>
<span class="line"><span style="color:#56B6C2">                print</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">f</span><span style="color:#98C379">&quot;Attempt </span><span style="color:#D19A66">{</span><span style="color:#ABB2BF">retries </span><span style="color:#56B6C2">+</span><span style="color:#D19A66"> 1}</span><span style="color:#98C379"> failed with status code </span><span style="color:#D19A66">{</span><span style="color:#ABB2BF">res.status_code</span><span style="color:#D19A66">}</span><span style="color:#98C379">. Error: </span><span style="color:#D19A66">{</span><span style="color:#ABB2BF">error_message</span><span style="color:#D19A66">}</span><span style="color:#98C379">. Retrying...&quot;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#C678DD">        except</span><span style="color:#ABB2BF"> requests.exceptions.RequestException </span><span style="color:#C678DD">as</span><span style="color:#ABB2BF"> e:</span></span>
<span class="line"><span style="color:#56B6C2">            print</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">f</span><span style="color:#98C379">&quot;An error occurred: </span><span style="color:#D19A66">{</span><span style="color:#ABB2BF">e</span><span style="color:#D19A66">}</span><span style="color:#98C379">. Retrying...&quot;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">        retries </span><span style="color:#56B6C2">+=</span><span style="color:#D19A66"> 1</span></span>
<span class="line"><span style="color:#ABB2BF">        time.</span><span style="color:#61AFEF">sleep</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">1</span><span style="color:#ABB2BF">)  </span><span style="color:#7F848E;font-style:italic"># Sleep for a bit before retrying to avoid overwhelming the server</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#D19A66"> None</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">def</span><span style="color:#61AFEF"> fetch_generations_from_scene_statements</span><span style="color:#ABB2BF">():</span></span>
<span class="line"><span style="color:#ABB2BF">    conn </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> sqlite3.</span><span style="color:#61AFEF">connect</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;results.sqlite&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">    c </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> conn.</span><span style="color:#61AFEF">cursor</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">    c.</span><span style="color:#61AFEF">execute</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;&#39;&#39;</span></span>
<span class="line"><span style="color:#98C379">        SELECT generation FROM scene_statements</span></span>
<span class="line"><span style="color:#98C379">    &#39;&#39;&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">    generations </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> c.</span><span style="color:#61AFEF">fetchall</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">    conn.</span><span style="color:#61AFEF">close</span><span style="color:#ABB2BF">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#ABB2BF"> [generation[</span><span style="color:#D19A66">0</span><span style="color:#ABB2BF">] </span><span style="color:#C678DD">for</span><span style="color:#ABB2BF"> generation </span><span style="color:#C678DD">in</span><span style="color:#ABB2BF"> generations]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">arguments_list </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> fetch_generations_from_scene_statements</span><span style="color:#ABB2BF">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">generator </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> Generator</span><span style="color:#ABB2BF">(</span><span style="color:#E06C75;font-style:italic">max_workers</span><span style="color:#56B6C2">=</span><span style="color:#D19A66">20</span><span style="color:#ABB2BF">, </span><span style="color:#E06C75;font-style:italic">generate_function</span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF">clean_and_generate, </span><span style="color:#E06C75;font-style:italic">arguments_list</span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF">arguments_list)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#61AFEF">create_table_for_clean_statements</span><span style="color:#ABB2BF">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">for</span><span style="color:#ABB2BF"> result </span><span style="color:#C678DD">in</span><span style="color:#61AFEF"> tqdm</span><span style="color:#ABB2BF">(generator, </span><span style="color:#E06C75;font-style:italic">total</span><span style="color:#56B6C2">=len</span><span style="color:#ABB2BF">(arguments_list)):</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#ABB2BF"> result </span><span style="color:#C678DD">is</span><span style="color:#C678DD"> not</span><span style="color:#D19A66"> None</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#ABB2BF">        initial_statement, prompt, generation, generation_params </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> result</span></span>
<span class="line"><span style="color:#61AFEF">        insert_clean_statement</span><span style="color:#ABB2BF">(initial_statement, prompt, generation, generation_params)</span></span></code></pre> </div> </astro-accordion>  
<p><code>table_as_dataframe(&#39;clean_statements&#39;)[[&#39;generation&#39;]].sample(5)</code></p>
<div class="output-result" data-astro-cid-c5o6katz> 




























<table><thead><tr><th>index</th><th>generation</th></tr></thead><tbody><tr><td>1577</td><td>The input contains a statement but has a preamble “George and make an evaluation statement.”. I made sure to remove it.\nIn addition, within the statement I found the following names: Jerry, Elaine, and my father.\nI made sure to replace those names with ones you gave me.\n\nCleaned statement : “It’s disappointing that Danielle and Brett didn’t take the time to say hello to my father.</td></tr><tr><td>1715</td><td>The input contains a statement but has a preamble “Elaine and make an evaluation statement:“. I made sure to remove it.\nIn addition, within the statement I found the following name: Landis.\nI made sure to replace that name with ones you gave me.\n\nCleaned statement : “It’s heartbreaking to see James so devastated about his injury. I can’t imagine how difficult it must be for him to face the possibility of not being able to play tennis again.</td></tr><tr><td>1678</td><td>The input contains a statement but has a preamble “Jerry.”. I made sure to remove it.\nIn addition, within the statement I found the following name: Jerry.\nI made sure to replace that name with ones you gave me.\n\nCleaned statement : “David believes that the specials are a waste of time and effort for both the waitress and the customer, as they are not special enough to be included on the regular menu.</td></tr><tr><td>1001</td><td>The input contains a statement but has a preamble “Jerry and make an evaluation statement.”. I made sure to remove it.\nIn addition, within the statement I found the following name: Elaine.\nI made sure to replace that name with ones you gave me.\n\nCleaned statement : “I think Elizabeth is always in a rush and doesn’t value our time together.</td></tr><tr><td>1857</td><td>The input contains a statement but has a preamble “Jerry and make an evaluation statement.”. I made sure to remove it.\nIn addition, within the statement I found the following name: Newman.\nI made sure to replace that name with ones you gave me.\n\nCleaned statement : “Nathan, always leaving his Chunky wrappers in my apartment. He’s such a slob!</td></tr></tbody></table> </div> 
<p>Looking good! Let’s extract the cleaned statements</p>
<pre class="astro-code one-dark-pro" style="background-color:#282c34;color:#abb2bf;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">df </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> table_as_dataframe</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;clean_statements&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">df </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> df[df[</span><span style="color:#98C379">&#39;generation&#39;</span><span style="color:#ABB2BF">].str.</span><span style="color:#61AFEF">contains</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&quot;“&quot;</span><span style="color:#ABB2BF">)] </span><span style="color:#7F848E;font-style:italic"># heuristic to keep good results</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">def</span><span style="color:#61AFEF"> extract_statement_from_response</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66;font-style:italic">response</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#ABB2BF">    quote_idx </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> response.</span><span style="color:#61AFEF">rfind</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&quot;“&quot;</span><span style="color:#ABB2BF">) </span><span style="color:#7F848E;font-style:italic"># We use rfind to make sure to get the last quote statement</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#ABB2BF"> response[quote_idx</span><span style="color:#56B6C2">+</span><span style="color:#D19A66">1</span><span style="color:#ABB2BF">:]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">df[</span><span style="color:#98C379">&#39;cleaned_statement&#39;</span><span style="color:#ABB2BF">] </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> df[</span><span style="color:#98C379">&#39;generation&#39;</span><span style="color:#ABB2BF">].</span><span style="color:#61AFEF">apply</span><span style="color:#ABB2BF">(extract_statement_from_response)</span></span>
<span class="line"><span style="color:#ABB2BF">df </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> df[df[</span><span style="color:#98C379">&#39;cleaned_statement&#39;</span><span style="color:#ABB2BF">] </span><span style="color:#56B6C2">!=</span><span style="color:#98C379"> &#39;&#39;</span><span style="color:#ABB2BF">] </span><span style="color:#7F848E;font-style:italic"># Filter for empty statements</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">df[[</span><span style="color:#98C379">&#39;cleaned_statement&#39;</span><span style="color:#ABB2BF">]]</span></span></code></pre>
<div class="output-result" data-astro-cid-c5o6katz> 




















































<table><thead><tr><th>index</th><th>cleaned_statement</th></tr></thead><tbody><tr><td>0</td><td>Performing on stage is one of the most exhilarating experiences I’ve ever had.</td></tr><tr><td>1</td><td>Vanessa is the most captivating woman I’ve ever met.</td></tr><tr><td>2</td><td>Heather, you’re always so worried about what other people think. It’s exhausting to watch.</td></tr><tr><td>3</td><td>Maria, your constant interruptions during our conversations are really frustrating.</td></tr><tr><td>4</td><td>You’re always barging in unannounced and making a mess. It’s really inconsiderate.</td></tr><tr><td>…</td><td>…</td></tr><tr><td>3541</td><td>Moore felt embarrassed when he had to wear the puffy shirt on the Today Show.</td></tr><tr><td>3542</td><td>Evans may have been a good employee, but his lack of knowledge about baseball was quite concerning.</td></tr><tr><td>3543</td><td>Melanie and Dana’s constant mocking of me and my restaurant has deeply hurt my feelings and damaged my reputation. They are not good people.</td></tr><tr><td>3544</td><td>I can’t believe we got caught and are now facing criminal charges. This whole situation is a complete disaster, and I can’t help but feel like we’re all going to pay the price for our reckless behavior.</td></tr><tr><td>3545</td><td>The endless parade of witnesses who have come forth so enthusiastically to testify against these four seemingly ordinary people has left the courtroom and everyone who has attended this trial in a state of shock and disbelief.</td></tr></tbody></table> </div> 
<p>That seems like what we wanted!</p>
<p>Now let’s deduplicate using embedding similarity.</p>
<astro-accordion data-code="{codeBlock}" data-astro-cid-qbtd5bqq> <button class="accordion-toggle flex items-center text-sm" data-astro-cid-qbtd5bqq><b data-astro-cid-qbtd5bqq>Show Code</b> <svg class="chevron-icon w-6 h-6 -rotate-90 transition-transform transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" data-astro-cid-qbtd5bqq> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" data-astro-cid-qbtd5bqq></path> </svg></button> <div class="code-content hidden" data-astro-cid-qbtd5bqq> <pre class="astro-code one-dark-pro" style="background-color:#282c34;color:#abb2bf;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word" tabindex="0"><code><span class="line"><span style="color:#C678DD">import</span><span style="color:#ABB2BF"> sqlite3</span></span>
<span class="line"><span style="color:#C678DD">import</span><span style="color:#ABB2BF"> numpy </span><span style="color:#C678DD">as</span><span style="color:#ABB2BF"> np</span></span>
<span class="line"><span style="color:#C678DD">import</span><span style="color:#ABB2BF"> matplotlib.pyplot </span><span style="color:#C678DD">as</span><span style="color:#ABB2BF"> plt</span></span>
<span class="line"><span style="color:#C678DD">from</span><span style="color:#ABB2BF"> sentence_transformers </span><span style="color:#C678DD">import</span><span style="color:#ABB2BF"> SentenceTransformer</span></span>
<span class="line"><span style="color:#C678DD">from</span><span style="color:#ABB2BF"> sklearn.metrics.pairwise </span><span style="color:#C678DD">import</span><span style="color:#ABB2BF"> cosine_similarity</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">statements </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> df[</span><span style="color:#98C379">&#39;cleaned_statement&#39;</span><span style="color:#ABB2BF">].</span><span style="color:#61AFEF">to_list</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">model </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> SentenceTransformer</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;all-MiniLM-L6-v2&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic"># Generate embeddings for each statement</span></span>
<span class="line"><span style="color:#ABB2BF">embeddings </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> model.</span><span style="color:#61AFEF">encode</span><span style="color:#ABB2BF">(statements)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic"># Calculate cosine similarity</span></span>
<span class="line"><span style="color:#ABB2BF">cosine_sim </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> cosine_similarity</span><span style="color:#ABB2BF">(embeddings)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic"># Exclude self-comparison</span></span>
<span class="line"><span style="color:#ABB2BF">np.</span><span style="color:#61AFEF">fill_diagonal</span><span style="color:#ABB2BF">(cosine_sim, </span><span style="color:#56B6C2">-</span><span style="color:#D19A66">1</span><span style="color:#ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic"># Find the index of the most similar statement for each statement</span></span>
<span class="line"><span style="color:#ABB2BF">most_similar_indices </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> np.</span><span style="color:#61AFEF">argmax</span><span style="color:#ABB2BF">(cosine_sim, </span><span style="color:#E06C75;font-style:italic">axis</span><span style="color:#56B6C2">=</span><span style="color:#D19A66">1</span><span style="color:#ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic"># Calculate the highest cosine similarity score for each statement</span></span>
<span class="line"><span style="color:#ABB2BF">highest_cosine_similarity_scores </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> np.</span><span style="color:#61AFEF">max</span><span style="color:#ABB2BF">(cosine_sim, </span><span style="color:#E06C75;font-style:italic">axis</span><span style="color:#56B6C2">=</span><span style="color:#D19A66">1</span><span style="color:#ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic"># Retrieve the most similar statement for each statement using the indices</span></span>
<span class="line"><span style="color:#ABB2BF">most_similar_statements </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> [statements[index] </span><span style="color:#C678DD">for</span><span style="color:#ABB2BF"> index </span><span style="color:#C678DD">in</span><span style="color:#ABB2BF"> most_similar_indices]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic"># Create a DataFrame</span></span>
<span class="line"><span style="color:#ABB2BF">df </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> pd.</span><span style="color:#61AFEF">DataFrame</span><span style="color:#ABB2BF">({</span></span>
<span class="line"><span style="color:#98C379">    &#39;statement&#39;</span><span style="color:#ABB2BF">: statements,</span></span>
<span class="line"><span style="color:#98C379">    &#39;most_similar_statement&#39;</span><span style="color:#ABB2BF">: most_similar_statements,</span></span>
<span class="line"><span style="color:#98C379">    &#39;highest_cosine_similarity_by_embedding&#39;</span><span style="color:#ABB2BF">: highest_cosine_similarity_scores</span></span>
<span class="line"><span style="color:#ABB2BF">})</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic"># Plotting</span></span>
<span class="line"><span style="color:#ABB2BF">plt.</span><span style="color:#61AFEF">hist</span><span style="color:#ABB2BF">(df[</span><span style="color:#98C379">&#39;highest_cosine_similarity_by_embedding&#39;</span><span style="color:#ABB2BF">], </span><span style="color:#E06C75;font-style:italic">bins</span><span style="color:#56B6C2">=</span><span style="color:#D19A66">20</span><span style="color:#ABB2BF">)  </span><span style="color:#7F848E;font-style:italic"># Adjust the number of bins as needed</span></span>
<span class="line"><span style="color:#ABB2BF">plt.</span><span style="color:#61AFEF">xlabel</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;Highest similarity with another statement in the set&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">plt.</span><span style="color:#61AFEF">ylabel</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;Frequency&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">plt.</span><span style="color:#61AFEF">title</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;Embedding similarity histogram&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">plt.</span><span style="color:#61AFEF">show</span><span style="color:#ABB2BF">()</span></span></code></pre> </div> </astro-accordion>  
<figure class="mx-6"> <img src="/images/nvc/3.png" alt="TV script seeded generated statement embedding similarity histogram"> <figcaption class="m-0"> <hr class="m-0 mt-2 mb-2"> <p> <p>That’s a normal distribution if I’ve ever seen one. Mode collapse avoided!</p> </p> </figcaption> </figure>
<p>Let’s still look at the similar examples to find a good treshold for filtering</p>
<pre class="astro-code one-dark-pro" style="background-color:#282c34;color:#abb2bf;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">df[df[</span><span style="color:#98C379">&#39;highest_cosine_similarity_by_embedding&#39;</span><span style="color:#ABB2BF">] </span><span style="color:#56B6C2">&lt;</span><span style="color:#D19A66"> 0.8</span><span style="color:#ABB2BF">].</span><span style="color:#61AFEF">sort_values</span><span style="color:#ABB2BF">(</span><span style="color:#E06C75;font-style:italic">by</span><span style="color:#56B6C2">=</span><span style="color:#98C379">&#39;highest_cosine_similarity_by_embedding&#39;</span><span style="color:#ABB2BF">, </span><span style="color:#E06C75;font-style:italic">ascending</span><span style="color:#56B6C2">=</span><span style="color:#D19A66">False</span><span style="color:#ABB2BF">)</span></span></code></pre>
<div class="output-result" data-astro-cid-c5o6katz> 
































































<table><thead><tr><th>statement</th><th>most_similar_string_by_embedding</th><th>highest_cosine_similarity_by_embedding</th></tr></thead><tbody><tr><td>561</td><td>Jerry, I think you’re being too critical about…</td><td>I can’t help but feel that commercial is tryin…</td></tr><tr><td>779</td><td>I can’t help but feel that commercial is tryin…</td><td>Jerry, I think you’re being too critical about…</td></tr><tr><td>560</td><td>This situation is hopeless, and we’re all goin…</td><td>I can’t believe we’re stuck in this dark, clau…</td></tr><tr><td>345</td><td>I can’t believe we’re stuck in this dark, clau…</td><td>This situation is hopeless, and we’re all goin…</td></tr><tr><td>64</td><td>I find it amusing how the laser guy manages to…</td><td>I think that guy with the laser is really funn…</td></tr><tr><td>…</td><td>…</td><td>…</td></tr><tr><td>456</td><td>Hunter, you’re always so worried about followi…</td><td>I feel frustrated and misunderstood by the sec…</td></tr><tr><td>721</td><td>I believe that singing is a great way to expre…</td><td>I think it’s important for people to learn and…</td></tr><tr><td>776</td><td>I don’t know how you put up with this.</td><td>I can’t believe I let myself get into this sit…</td></tr><tr><td>113</td><td>I believe that being a matador is not as easy …</td><td>I think it’s great that you’re willing to help…</td></tr><tr><td>803</td><td>I feel frustrated because I’m trying to charge…</td><td>This phone company representative is so frustr…</td></tr></tbody></table> </div> 
<p>0.8 cosine similarity seems like a good threshold for removing duplicates. Our data is starting to look good!</p>
<p><code>kept = df[df[&#39;highest_cosine_similarity_by_embedding&#39;] &lt; 0.8]</code></p>
<p>Now let’s inspect our cleaned samples to make sure they are indeed “clean”</p>
<p><code>kept.sample(10)</code></p>
<div class="output-result" data-astro-cid-c5o6katz> 






































































<table><thead><tr><th>index</th><th>statement</th><th>most_similar_statement</th><th>highest_cosine_similarity_by_embedding</th></tr></thead><tbody><tr><td>2180</td><td>I am deeply saddened by the loss of Derek, but we must move forward and focus on the business at hand.</td><td>It’s frustrating to see Derek struggling with his relationship with Lisa, but I can’t help but find it entertaining.</td><td>0.521388</td></tr><tr><td>2010</td><td>I can’t believe you had to run away from those dogs, Joanna. It’s just not safe for you to be walking around in this neighborhood.</td><td>Felicia: I can’t believe how loud those dogs are! It’s like they’re trying to wake the entire neighborhood!</td><td>0.540056</td></tr><tr><td>2924</td><td>I feel frustrated and disappointed when Benson took away my desk without considering how much I valued that space.</td><td>I believe that House’s reaction to the lack of space under the desk was overly dramatic and unnecessary.</td><td>0.550225</td></tr><tr><td>2318</td><td>I can’t believe how lucky I am today. First, the wedding is delayed until June, which feels like a stay of execution. Then, I find out that Mason’s best friend, Jasmine, broke up with her boyfriend. This is a perfect opportunity for me to set up a date with Jasmine and enjoy some of the benefits of being in a relationship without actually being married.</td><td>I can’t believe you missed the wedding, Tamara. You always manage to be late for the important events in our lives.</td><td>0.574179</td></tr><tr><td>1137</td><td>I find it disrespectful that Brian keeps using thin tape on my car’s dashboard. It shows a lack of consideration for my preferences.</td><td>The Gonzalez seems to be overly concerned about the lipstick on his dashboard, which is a minor issue compared to the condom found in his car.</td><td>0.483860</td></tr><tr><td>1841</td><td>Jake, I must say, you have the most peculiar dental habits I’ve ever seen. It’s almost as if you enjoy coming to the dentist!</td><td>Jerry’s evaluation of the electric toothbrush - The Ori-dent is unbelievable. Every time you use it, you feel like you just came from the dentist!</td><td>0.562710</td></tr><tr><td>66</td><td>Jerry’s reaction to the eulogist’s mention of Michael’s pony shows that he is uncomfortable with the idea of expressing emotions, especially during a somber event like a funeral.</td><td>Jerry’s Evaluation Statement: Despite the eulogy’s attempt to paint a picture of Christina’s happy childhood, I couldn’t help but feel a sense of loss and sadness. It’s heartbreaking to think about the beautiful moments she had with her beloved pony, which are now just memories.</td><td>0.600774</td></tr><tr><td>281</td><td>Robinson, I can’t believe you missed that pop fly. You’re usually so sharp on the field.</td><td>Cooper: I can’t believe I missed that ball! I must be losing my touch.</td><td>0.493075</td></tr><tr><td>855</td><td>That Michael is such a jerk! He should be more friendly and entertaining.</td><td>I think Michael is always so entertaining and witty. I never get bored when I’m with him.</td><td>0.750507</td></tr><tr><td>3497</td><td>Moore felt embarrassed when he had to wear the puffy shirt on the Today Show.</td><td>I can’t believe Watkins just made me pretend to be mugged in front of a bus full of tourists. I feel so embarrassed and uncomfortable.</td><td>0.509021</td></tr></tbody></table> </div> 
<p>Mmh, look at <code>2010</code>: <code>Felicia: I can&#39;t believe how loud those dogs are! It&#39;s like they&#39;re trying to wake the entire neighborhood!</code> and <code>1841</code>: <code>Jerry&#39;s evaluation of the electric toothbrush - The Ori-dent is unbelievable. Every time you use it, you feel like you just came from the dentist!</code></p>
<p>Those string were not properly cleaned. We could try and process them further but instead we will just go ahead and remove them from our set with a simple heuristic.</p>
<pre class="astro-code one-dark-pro" style="background-color:#282c34;color:#abb2bf;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">discarded </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> kept[(kept[</span><span style="color:#98C379">&#39;statement&#39;</span><span style="color:#ABB2BF">].str.</span><span style="color:#61AFEF">contains</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;evaluat&#39;</span><span style="color:#ABB2BF">, </span><span style="color:#E06C75;font-style:italic">case</span><span style="color:#56B6C2">=</span><span style="color:#D19A66">False</span><span style="color:#ABB2BF">)) </span><span style="color:#56B6C2">|</span><span style="color:#ABB2BF"> (kept[</span><span style="color:#98C379">&#39;statement&#39;</span><span style="color:#ABB2BF">].str.</span><span style="color:#61AFEF">contains</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;:&#39;</span><span style="color:#ABB2BF">))]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#56B6C2">print</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">f</span><span style="color:#98C379">&quot;Total : </span><span style="color:#D19A66">{</span><span style="color:#56B6C2">len</span><span style="color:#ABB2BF">(kept)</span><span style="color:#D19A66">}</span><span style="color:#98C379">, discarded : </span><span style="color:#D19A66">{</span><span style="color:#56B6C2">len</span><span style="color:#ABB2BF">(discarded)</span><span style="color:#D19A66">}</span><span style="color:#98C379">, ratio : </span><span style="color:#D19A66">{</span><span style="color:#56B6C2">len</span><span style="color:#ABB2BF">(discarded) </span><span style="color:#56B6C2">/</span><span style="color:#56B6C2"> len</span><span style="color:#ABB2BF">(kept)</span><span style="color:#D19A66">}</span><span style="color:#98C379">&quot;</span><span style="color:#ABB2BF">)</span></span></code></pre>
<div class="output-result" data-astro-cid-c5o6katz> <p>Total : 3481, discarded : 458, ratio : 0.1315713875323183</p> </div> 
<p>I’m okay with that</p>
<pre class="astro-code one-dark-pro" style="background-color:#282c34;color:#abb2bf;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">kept </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> kept.</span><span style="color:#61AFEF">drop</span><span style="color:#ABB2BF">(discarded.index)</span></span></code></pre>
<p>We are now ready to augment the generated statements with NVC classification! We use Llama 2 70B again.</p>
<astro-accordion data-code="{codeBlock}" data-astro-cid-qbtd5bqq> <button class="accordion-toggle flex items-center text-sm" data-astro-cid-qbtd5bqq><b data-astro-cid-qbtd5bqq>Show Code</b> <svg class="chevron-icon w-6 h-6 -rotate-90 transition-transform transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" data-astro-cid-qbtd5bqq> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" data-astro-cid-qbtd5bqq></path> </svg></button> <div class="code-content hidden" data-astro-cid-qbtd5bqq> <pre class="astro-code one-dark-pro" style="background-color:#282c34;color:#abb2bf;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word" tabindex="0"><code><span class="line"><span style="color:#C678DD">def</span><span style="color:#61AFEF"> create_llama_classification_table</span><span style="color:#ABB2BF">():</span></span>
<span class="line"><span style="color:#ABB2BF">    conn </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> sqlite3.</span><span style="color:#61AFEF">connect</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;results.sqlite&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">    c </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> conn.</span><span style="color:#61AFEF">cursor</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">    c.</span><span style="color:#61AFEF">execute</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;&#39;&#39;</span></span>
<span class="line"><span style="color:#98C379">        CREATE TABLE IF NOT EXISTS llama_classifications (</span></span>
<span class="line"><span style="color:#98C379">            id INTEGER PRIMARY KEY,</span></span>
<span class="line"><span style="color:#98C379">            statement TEXT,</span></span>
<span class="line"><span style="color:#98C379">            prompt TEXT,</span></span>
<span class="line"><span style="color:#98C379">            generation TEXT,</span></span>
<span class="line"><span style="color:#98C379">            generation_params json</span></span>
<span class="line"><span style="color:#98C379">        )</span></span>
<span class="line"><span style="color:#98C379">    &#39;&#39;&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">    conn.</span><span style="color:#61AFEF">commit</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">    conn.</span><span style="color:#61AFEF">close</span><span style="color:#ABB2BF">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">def</span><span style="color:#61AFEF"> insert_generated_classification</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66;font-style:italic">statement</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66;font-style:italic">prompt</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66;font-style:italic">generation</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66;font-style:italic">generation_params</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#ABB2BF">    conn </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> sqlite3.</span><span style="color:#61AFEF">connect</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;results.sqlite&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">    c </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> conn.</span><span style="color:#61AFEF">cursor</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">    c.</span><span style="color:#61AFEF">execute</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;&#39;&#39;</span></span>
<span class="line"><span style="color:#98C379">        INSERT INTO llama_classifications (statement, prompt, generation, generation_params)</span></span>
<span class="line"><span style="color:#98C379">        VALUES (?, ?, ?, ?)</span></span>
<span class="line"><span style="color:#98C379">    &#39;&#39;&#39;</span><span style="color:#ABB2BF">, (statement, prompt, generation, json.</span><span style="color:#61AFEF">dumps</span><span style="color:#ABB2BF">(generation_params)))</span></span>
<span class="line"><span style="color:#ABB2BF">    conn.</span><span style="color:#61AFEF">commit</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">    conn.</span><span style="color:#61AFEF">close</span><span style="color:#ABB2BF">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">def</span><span style="color:#61AFEF"> get_generated_classification_for_statement</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66;font-style:italic">statement</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#ABB2BF">    conn </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> sqlite3.</span><span style="color:#61AFEF">connect</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;results.sqlite&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">    c </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> conn.</span><span style="color:#61AFEF">cursor</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">    c.</span><span style="color:#61AFEF">execute</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;&#39;&#39;</span></span>
<span class="line"><span style="color:#98C379">        SELECT generation FROM llama_classifications WHERE statement = ?</span></span>
<span class="line"><span style="color:#98C379">    &#39;&#39;&#39;</span><span style="color:#ABB2BF">, (statement,))</span></span>
<span class="line"><span style="color:#ABB2BF">    result </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> c.</span><span style="color:#61AFEF">fetchone</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">    conn.</span><span style="color:#61AFEF">close</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#ABB2BF"> result[</span><span style="color:#D19A66">0</span><span style="color:#ABB2BF">] </span><span style="color:#C678DD">if</span><span style="color:#ABB2BF"> result </span><span style="color:#C678DD">else</span><span style="color:#D19A66"> None</span></span>
<span class="line"><span style="color:#ABB2BF">    </span></span>
<span class="line"><span style="color:#C678DD">def</span><span style="color:#61AFEF"> table_as_dataframe</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66;font-style:italic">table</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#ABB2BF">    conn </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> sqlite3.</span><span style="color:#61AFEF">connect</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;results.sqlite&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">    query </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> f</span><span style="color:#98C379">&#39;SELECT * FROM </span><span style="color:#D19A66">{</span><span style="color:#ABB2BF">table</span><span style="color:#D19A66">}</span><span style="color:#98C379">&#39;</span></span>
<span class="line"><span style="color:#ABB2BF">    df </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> pd.</span><span style="color:#61AFEF">read_sql_query</span><span style="color:#ABB2BF">(query, conn)</span></span>
<span class="line"><span style="color:#ABB2BF">    conn.</span><span style="color:#61AFEF">close</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#ABB2BF"> df</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">def</span><span style="color:#61AFEF"> generate_classification</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66;font-style:italic">statement</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66;font-style:italic">max_retries</span><span style="color:#ABB2BF">=</span><span style="color:#D19A66">10</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#ABB2BF">    generation_params </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#98C379">        &quot;model&quot;</span><span style="color:#ABB2BF">: </span><span style="color:#98C379">&quot;togethercomputer/llama-2-70b&quot;</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#98C379">        &quot;max_tokens&quot;</span><span style="color:#ABB2BF">: </span><span style="color:#D19A66">512</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#98C379">        &quot;temperature&quot;</span><span style="color:#ABB2BF">: </span><span style="color:#D19A66">0.7</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#98C379">        &quot;top_p&quot;</span><span style="color:#ABB2BF">: </span><span style="color:#D19A66">0.7</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#98C379">        &quot;top_k&quot;</span><span style="color:#ABB2BF">: </span><span style="color:#D19A66">50</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#98C379">        &quot;stop&quot;</span><span style="color:#ABB2BF">: [</span><span style="color:#98C379">&quot;</span><span style="color:#56B6C2">\n\n</span><span style="color:#98C379">&quot;</span><span style="color:#ABB2BF">],</span></span>
<span class="line"><span style="color:#98C379">        &quot;repetition_penalty&quot;</span><span style="color:#ABB2BF">: </span><span style="color:#D19A66">1</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    prompt </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> make_seed_prompt</span><span style="color:#ABB2BF">() </span><span style="color:#56B6C2">+</span><span style="color:#C678DD"> f</span><span style="color:#98C379">&#39; “</span><span style="color:#D19A66">{</span><span style="color:#ABB2BF">statement</span><span style="color:#D19A66">}</span><span style="color:#98C379">”&#39;</span><span style="color:#56B6C2"> +</span><span style="color:#98C379"> &#39;</span><span style="color:#56B6C2">\n</span><span style="color:#98C379">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    existing_generation </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> get_generated_classification_for_statement</span><span style="color:#ABB2BF">(statement)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#ABB2BF"> existing_generation </span><span style="color:#C678DD">is</span><span style="color:#C678DD"> not</span><span style="color:#D19A66"> None</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#56B6C2">        print</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&quot;Found existing generation for prompt&quot;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#D19A66"> None</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    retries </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 0</span></span>
<span class="line"><span style="color:#C678DD">    while</span><span style="color:#ABB2BF"> retries </span><span style="color:#56B6C2">&lt;</span><span style="color:#ABB2BF"> max_retries:</span></span>
<span class="line"><span style="color:#C678DD">        try</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#ABB2BF">            res </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> requests.</span><span style="color:#61AFEF">post</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">ENDPOINT_URL</span><span style="color:#ABB2BF">, </span><span style="color:#E06C75;font-style:italic">json</span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF">{</span></span>
<span class="line"><span style="color:#56B6C2">                **</span><span style="color:#ABB2BF">generation_params,</span></span>
<span class="line"><span style="color:#98C379">                &quot;prompt&quot;</span><span style="color:#ABB2BF">: prompt,</span></span>
<span class="line"><span style="color:#ABB2BF">            }, </span><span style="color:#E06C75;font-style:italic">headers</span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF">{</span></span>
<span class="line"><span style="color:#98C379">                &quot;Authorization&quot;</span><span style="color:#ABB2BF">: </span><span style="color:#C678DD">f</span><span style="color:#98C379">&quot;Bearer </span><span style="color:#D19A66">{TOGETHER_API_KEY}</span><span style="color:#98C379">&quot;</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#ABB2BF">            })</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">            if</span><span style="color:#ABB2BF"> res.status_code </span><span style="color:#56B6C2">==</span><span style="color:#D19A66"> 200</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#C678DD">                return</span><span style="color:#ABB2BF"> statement, prompt, res.</span><span style="color:#61AFEF">json</span><span style="color:#ABB2BF">()[</span><span style="color:#98C379">&#39;choices&#39;</span><span style="color:#ABB2BF">][</span><span style="color:#D19A66">0</span><span style="color:#ABB2BF">][</span><span style="color:#98C379">&#39;text&#39;</span><span style="color:#ABB2BF">], generation_params</span></span>
<span class="line"><span style="color:#C678DD">            else</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#ABB2BF">                error_message </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> res.text</span></span>
<span class="line"><span style="color:#56B6C2">                print</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">f</span><span style="color:#98C379">&quot;Attempt </span><span style="color:#D19A66">{</span><span style="color:#ABB2BF">retries </span><span style="color:#56B6C2">+</span><span style="color:#D19A66"> 1}</span><span style="color:#98C379"> failed with status code </span><span style="color:#D19A66">{</span><span style="color:#ABB2BF">res.status_code</span><span style="color:#D19A66">}</span><span style="color:#98C379">. Error: </span><span style="color:#D19A66">{</span><span style="color:#ABB2BF">error_message</span><span style="color:#D19A66">}</span><span style="color:#98C379">. Retrying...&quot;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#C678DD">        except</span><span style="color:#ABB2BF"> Exception </span><span style="color:#C678DD">as</span><span style="color:#ABB2BF"> e:</span></span>
<span class="line"><span style="color:#56B6C2">            print</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">f</span><span style="color:#98C379">&quot;An error occurred: </span><span style="color:#D19A66">{</span><span style="color:#ABB2BF">e</span><span style="color:#D19A66">}</span><span style="color:#98C379">. Retrying...&quot;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">        retries </span><span style="color:#56B6C2">+=</span><span style="color:#D19A66"> 1</span></span>
<span class="line"><span style="color:#ABB2BF">        time.</span><span style="color:#61AFEF">sleep</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">1</span><span style="color:#ABB2BF">)  </span><span style="color:#7F848E;font-style:italic"># Sleep for a bit before retrying to avoid overwhelming the server</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#D19A66"> None</span></span>
<span class="line"></span>
<span class="line"><span style="color:#61AFEF">create_llama_classification_table</span><span style="color:#ABB2BF">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">arguments_list </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> kept[</span><span style="color:#98C379">&#39;statement&#39;</span><span style="color:#ABB2BF">].</span><span style="color:#61AFEF">to_list</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">generator </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> Generator</span><span style="color:#ABB2BF">(</span><span style="color:#E06C75;font-style:italic">max_workers</span><span style="color:#56B6C2">=</span><span style="color:#D19A66">20</span><span style="color:#ABB2BF">, </span><span style="color:#E06C75;font-style:italic">generate_function</span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF">generate_classification, </span><span style="color:#E06C75;font-style:italic">arguments_list</span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF">arguments_list)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">for</span><span style="color:#ABB2BF"> result </span><span style="color:#C678DD">in</span><span style="color:#61AFEF"> tqdm</span><span style="color:#ABB2BF">(generator, </span><span style="color:#E06C75;font-style:italic">total</span><span style="color:#56B6C2">=len</span><span style="color:#ABB2BF">(arguments_list)):</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#ABB2BF"> result </span><span style="color:#C678DD">is</span><span style="color:#C678DD"> not</span><span style="color:#D19A66"> None</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#ABB2BF">        statement, prompt, generation, generation_params </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> result</span></span>
<span class="line"><span style="color:#61AFEF">        insert_generated_classification</span><span style="color:#ABB2BF">(statement, prompt, generation, generation_params)</span></span></code></pre> </div> </astro-accordion>  
<p><code>table_as_dataframe(&#39;llama_classifications&#39;).head(5)</code></p>
<div class="output-result" data-astro-cid-c5o6katz> 


































<table><thead><tr><th>Index</th><th>Statement</th><th>Generation</th></tr></thead><tbody><tr><td>0</td><td>Statement:“I remember when we used to come here every day. It was like a second home to us.”</td><td>\nReasoning: This statement is a recollection of a past experience. It’s not a judgment or interpretation of the experience but a memory of how it felt to the speaker.\nClassification: Observation</td></tr><tr><td>1</td><td>Statement:“I know I look great, and I’m confident in my own skin.”</td><td>\nReasoning: The statement contains personal judgments about the speaker’s appearance and confidence. The speaker is evaluating themselves and expressing their beliefs about their appearance and self-confidence.\nClassification: Evaluation\nPure observation alternative: “I am wearing a red dress today.”</td></tr><tr><td>2</td><td>Statement:“I can’t believe you’re making me wait for your boyfriend, Rodriguez. I have a flight to catch!”</td><td>\nReasoning: The statement includes emotional expressions like “I can’t believe” and “making me wait,” which are evaluative. The speaker is expressing their frustration and impatience towards the person they’re addressing.\nClassification: Evaluation\nPure observation alternative: “I have a flight to catch.”</td></tr><tr><td>3</td><td>Statement:“My friend has been ignoring me lately, and I feel hurt by their actions.”</td><td>\nReasoning: This statement combines observations (my friend has been ignoring me lately) and feelings (I feel hurt by their actions). It’s not an evaluation because it doesn’t assign a judgment or interpretation to the friend’s actions.\nClassification: Mixed\nPure observation alternative: “My friend hasn’t returned my calls for the past two weeks.”</td></tr><tr><td>4</td><td>Statement:“I’m so glad to finally meet you, Hawkins. I’ve heard so much about you from our mutual friends.”</td><td>\nReasoning: This statement expresses the speaker’s positive emotions towards meeting Hawkins and mentions the source of their knowledge about Hawkins. It doesn’t contain any evaluative language or judgment about Hawkins or the mutual friends.\nClassification: Observation</td></tr></tbody></table> </div> 
<p>That looks good to me.
Let’s parse our data into a structured format.</p>
<pre class="astro-code one-dark-pro" style="background-color:#282c34;color:#abb2bf;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word" tabindex="0"><code><span class="line"><span style="color:#C678DD">import</span><span style="color:#ABB2BF"> sqlite3</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">def</span><span style="color:#61AFEF"> fetch_column</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66;font-style:italic">table</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66;font-style:italic">col</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#ABB2BF">    conn </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> sqlite3.</span><span style="color:#61AFEF">connect</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;results.sqlite&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">    c </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> conn.</span><span style="color:#61AFEF">cursor</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">    c.</span><span style="color:#61AFEF">execute</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">f</span><span style="color:#98C379">&#39;SELECT </span><span style="color:#D19A66">{</span><span style="color:#ABB2BF">col</span><span style="color:#D19A66">}</span><span style="color:#98C379"> FROM </span><span style="color:#D19A66">{</span><span style="color:#ABB2BF">table</span><span style="color:#D19A66">}</span><span style="color:#98C379">&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">    all_statements </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> [row[</span><span style="color:#D19A66">0</span><span style="color:#ABB2BF">] </span><span style="color:#C678DD">for</span><span style="color:#ABB2BF"> row </span><span style="color:#C678DD">in</span><span style="color:#ABB2BF"> c.</span><span style="color:#61AFEF">fetchall</span><span style="color:#ABB2BF">()]</span></span>
<span class="line"><span style="color:#ABB2BF">    conn.</span><span style="color:#61AFEF">close</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#ABB2BF"> all_statements</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">statements </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> fetch_column</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;llama_classifications&#39;</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">&#39;statement&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">generations </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> fetch_column</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;llama_classifications&#39;</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">&#39;generation&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">def</span><span style="color:#61AFEF"> extract_field</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66;font-style:italic">sample</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66;font-style:italic">prefix</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#ABB2BF">    class_lines </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> [line </span><span style="color:#C678DD">for</span><span style="color:#ABB2BF"> line </span><span style="color:#C678DD">in</span><span style="color:#ABB2BF"> sample.</span><span style="color:#61AFEF">split</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;</span><span style="color:#56B6C2">\n</span><span style="color:#98C379">&#39;</span><span style="color:#ABB2BF">) </span><span style="color:#C678DD">if</span><span style="color:#ABB2BF"> line.</span><span style="color:#61AFEF">startswith</span><span style="color:#ABB2BF">(prefix)]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#56B6C2"> len</span><span style="color:#ABB2BF">(class_lines) </span><span style="color:#56B6C2">&gt;</span><span style="color:#D19A66"> 0</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#ABB2BF"> class_lines[</span><span style="color:#D19A66">0</span><span style="color:#ABB2BF">][</span><span style="color:#56B6C2">len</span><span style="color:#ABB2BF">(prefix):].</span><span style="color:#61AFEF">strip</span><span style="color:#ABB2BF">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#D19A66"> None</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">def</span><span style="color:#61AFEF"> extract_all_fields</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66;font-style:italic">sample</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#ABB2BF">    statement </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> extract_field</span><span style="color:#ABB2BF">(sample, </span><span style="color:#98C379">&#39;Statement:&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">    reasoning </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> extract_field</span><span style="color:#ABB2BF">(sample, </span><span style="color:#98C379">&#39;Reasoning:&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">    classification </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> extract_field</span><span style="color:#ABB2BF">(sample, </span><span style="color:#98C379">&#39;Classification:&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">    pure_observation_alternative </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> extract_field</span><span style="color:#ABB2BF">(sample, </span><span style="color:#98C379">&#39;Pure observation alternative:&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    parsed </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#98C379">        &#39;statement&#39;</span><span style="color:#ABB2BF">: statement,</span></span>
<span class="line"><span style="color:#98C379">        &#39;reasoning&#39;</span><span style="color:#ABB2BF">: reasoning,</span></span>
<span class="line"><span style="color:#98C379">        &#39;classification&#39;</span><span style="color:#ABB2BF">: classification,</span></span>
<span class="line"><span style="color:#98C379">        &#39;pure_observation_alternative&#39;</span><span style="color:#ABB2BF">: pure_observation_alternative</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#ABB2BF"> {key: value </span><span style="color:#C678DD">for</span><span style="color:#ABB2BF"> key, value </span><span style="color:#C678DD">in</span><span style="color:#ABB2BF"> parsed.</span><span style="color:#61AFEF">items</span><span style="color:#ABB2BF">() </span><span style="color:#C678DD">if</span><span style="color:#ABB2BF"> value </span><span style="color:#C678DD">is</span><span style="color:#C678DD"> not</span><span style="color:#D19A66"> None</span><span style="color:#ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">records </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> [</span><span style="color:#61AFEF">extract_all_fields</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;Statement: &#39;</span><span style="color:#56B6C2"> +</span><span style="color:#ABB2BF"> statements[i] </span><span style="color:#56B6C2">+</span><span style="color:#98C379"> &#39;</span><span style="color:#56B6C2">\n</span><span style="color:#98C379">&#39;</span><span style="color:#56B6C2"> +</span><span style="color:#ABB2BF"> gen) </span><span style="color:#C678DD">for</span><span style="color:#ABB2BF"> i, gen </span><span style="color:#C678DD">in</span><span style="color:#56B6C2"> enumerate</span><span style="color:#ABB2BF">(generations)]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">df </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> pd.</span><span style="color:#61AFEF">DataFrame</span><span style="color:#ABB2BF">(records)</span></span></code></pre>
<p>We can now compute the class distribution of our current dataset.</p>
<pre class="astro-code one-dark-pro" style="background-color:#282c34;color:#abb2bf;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word" tabindex="0"><code><span class="line"><span style="color:#C678DD">import</span><span style="color:#ABB2BF"> matplotlib.pyplot </span><span style="color:#C678DD">as</span><span style="color:#ABB2BF"> plt</span></span>
<span class="line"><span style="color:#C678DD">import</span><span style="color:#ABB2BF"> numpy </span><span style="color:#C678DD">as</span><span style="color:#ABB2BF"> np</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic"># Create a histogram of the classification labels</span></span>
<span class="line"><span style="color:#ABB2BF">unique_labels, label_counts </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> np.</span><span style="color:#61AFEF">unique</span><span style="color:#ABB2BF">(df[</span><span style="color:#98C379">&#39;classification&#39;</span><span style="color:#ABB2BF">], </span><span style="color:#E06C75;font-style:italic">return_counts</span><span style="color:#56B6C2">=</span><span style="color:#D19A66">True</span><span style="color:#ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic"># Sort the labels by count in descending order, and keep only top 10</span></span>
<span class="line"><span style="color:#ABB2BF">sorted_indices </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> np.</span><span style="color:#61AFEF">argsort</span><span style="color:#ABB2BF">(label_counts)[::</span><span style="color:#56B6C2">-</span><span style="color:#D19A66">1</span><span style="color:#ABB2BF">]</span></span>
<span class="line"><span style="color:#ABB2BF">top_labels </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> unique_labels[sorted_indices][:</span><span style="color:#D19A66">10</span><span style="color:#ABB2BF">]</span></span>
<span class="line"><span style="color:#ABB2BF">top_counts </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> label_counts[sorted_indices][:</span><span style="color:#D19A66">10</span><span style="color:#ABB2BF">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">plt.</span><span style="color:#61AFEF">bar</span><span style="color:#ABB2BF">(top_labels, top_counts)</span></span>
<span class="line"><span style="color:#ABB2BF">plt.</span><span style="color:#61AFEF">xlabel</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;Classes&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">plt.</span><span style="color:#61AFEF">ylabel</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;Frequency&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">plt.</span><span style="color:#61AFEF">title</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;Top 5 Classification Distribution Histogram&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">plt.</span><span style="color:#61AFEF">xticks</span><span style="color:#ABB2BF">(</span><span style="color:#E06C75;font-style:italic">rotation</span><span style="color:#56B6C2">=</span><span style="color:#D19A66">45</span><span style="color:#ABB2BF">) </span><span style="color:#7F848E;font-style:italic">#Rotate labels to prevent overlap</span></span>
<span class="line"><span style="color:#ABB2BF">plt.</span><span style="color:#61AFEF">show</span><span style="color:#ABB2BF">()</span></span></code></pre>
<p><img src="/images/nvc/4.png" alt="image"/></p>
<p>Mostly evaluations! That tracks as we asked Hermes to generate evaluations.</p>
<p>We only want to keep the samples classified as ‘Evaluation’ and ‘Observation’ samples</p>
<p><code>kept = df[(df[&#39;classification&#39;] == &#39;Evaluation&#39;) | (df[&#39;classification&#39;] == &#39;Observation&#39;)]</code></p>
<p>Let’s look at our generations</p>
<astro-accordion data-code="{codeBlock}" data-astro-cid-qbtd5bqq> <button class="accordion-toggle flex items-center text-sm" data-astro-cid-qbtd5bqq><b data-astro-cid-qbtd5bqq>Show Code</b> <svg class="chevron-icon w-6 h-6 -rotate-90 transition-transform transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" data-astro-cid-qbtd5bqq> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" data-astro-cid-qbtd5bqq></path> </svg></button> <div class="code-content hidden" data-astro-cid-qbtd5bqq> <pre class="astro-code one-dark-pro" style="background-color:#282c34;color:#abb2bf;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word" tabindex="0"><code><span class="line"><span style="color:#C678DD">def</span><span style="color:#61AFEF"> format_sample</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66;font-style:italic">sample</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#ABB2BF">    formatted </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> f</span><span style="color:#98C379">&#39;&#39;&#39;Statement:“</span><span style="color:#D19A66">{</span><span style="color:#ABB2BF">sample[</span><span style="color:#98C379">&#39;statement&#39;</span><span style="color:#ABB2BF">].</span><span style="color:#61AFEF">strip</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">lstrip</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&quot;“&quot;</span><span style="color:#ABB2BF">).</span><span style="color:#61AFEF">rstrip</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&quot;”&quot;</span><span style="color:#ABB2BF">)</span><span style="color:#D19A66">}</span><span style="color:#98C379">”</span></span>
<span class="line"><span style="color:#98C379">Reasoning: </span><span style="color:#D19A66">{</span><span style="color:#ABB2BF">sample[</span><span style="color:#98C379">&#39;reasoning&#39;</span><span style="color:#ABB2BF">]</span><span style="color:#D19A66">}</span></span>
<span class="line"><span style="color:#98C379">Classification: </span><span style="color:#D19A66">{</span><span style="color:#ABB2BF">sample[</span><span style="color:#98C379">&#39;classification&#39;</span><span style="color:#ABB2BF">]</span><span style="color:#D19A66">}</span><span style="color:#98C379">&#39;&#39;&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#56B6C2"> isinstance</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;pure_observation_alternative&#39;</span><span style="color:#C678DD"> in</span><span style="color:#ABB2BF"> sample </span><span style="color:#C678DD">and</span><span style="color:#ABB2BF"> sample[</span><span style="color:#98C379">&#39;pure_observation_alternative&#39;</span><span style="color:#ABB2BF">], </span><span style="color:#56B6C2">str</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#ABB2BF">        formatted </span><span style="color:#56B6C2">+=</span><span style="color:#98C379"> &#39;</span><span style="color:#56B6C2">\n</span><span style="color:#98C379">&#39;</span><span style="color:#56B6C2"> +</span><span style="color:#C678DD"> f</span><span style="color:#98C379">&quot;Pure observation alternative: “</span><span style="color:#D19A66">{</span><span style="color:#ABB2BF">sample[</span><span style="color:#98C379">&#39;pure_observation_alternative&#39;</span><span style="color:#ABB2BF">].</span><span style="color:#61AFEF">strip</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">lstrip</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;“&#39;</span><span style="color:#ABB2BF">).</span><span style="color:#61AFEF">rstrip</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;”&#39;</span><span style="color:#ABB2BF">)</span><span style="color:#D19A66">}</span><span style="color:#98C379">”&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#ABB2BF"> formatted</span></span></code></pre> </div> </astro-accordion>  
<p><code>print(format_sample(df.sample(1).iloc[0]))</code></p>
<div class="output-result" data-astro-cid-c5o6katz> <p>Statement:“I think it’s ridiculous that we have to pretend to be someone else just to see an apartment.”
Reasoning: The statement contains evaluative language like “ridiculous” and “pretend to be someone else,” which are judgments about the situation.
Classification: Evaluation
Pure observation alternative: “We had to wear suits and ties to see an apartment.”</p> </div> 
<p>Pretty good!</p>
<p>Let’s look at another one</p>
<p><code>print(format_sample(df.sample(1).iloc[0]))</code></p>
<div class="output-result" data-astro-cid-c5o6katz> <p>Statement:“I think Stephanie is a great girl, but we just couldn’t make it work between us.”
Reasoning: This statement includes a judgment about Stephanie’s character (she’s a “great girl”) and a personal interpretation of the speaker’s relationship with her (they “couldn’t make it work”).
Classification: Evaluation
Pure observation alternative: “I have a lot of respect for Stephanie, but we decided to end our relationship.”</p> </div> 
<p>Unfortunately, this one doesn’t hit the mark as well. It feels distinctly artificial, lacking discernment and common sense.</p>
<p>We don’t want that in our data. Let’s add one final step to our pipeline: rating based filtering.</p>
<h2 id="quality-control-rating-and-refining-the-generated-statements">Quality Control: Rating and Refining the Generated Statements</h2>
<p>To evaluate the quality of our generations we can manually create ratings (with a rationale) for a few generations and use this as a few-shot prompt to rate all our samples.</p>
<pre class="astro-code one-dark-pro" style="background-color:#282c34;color:#abb2bf;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word" tabindex="0"><code><span class="line"><span style="color:#C678DD">from</span><span style="color:#ABB2BF"> transformers </span><span style="color:#C678DD">import</span><span style="color:#ABB2BF"> AutoTokenizer</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">tokenizer </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> AutoTokenizer.</span><span style="color:#61AFEF">from_pretrained</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;NousResearch/Nous-Hermes-2-Mixtral-8x7B-DPO&#39;</span><span style="color:#ABB2BF">, </span><span style="color:#E06C75;font-style:italic">use_fast</span><span style="color:#56B6C2">=</span><span style="color:#D19A66">True</span><span style="color:#ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">def</span><span style="color:#61AFEF"> evaluation_prompt</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66;font-style:italic">sample</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#ABB2BF"> tokenizer.</span><span style="color:#61AFEF">apply_chat_template</span><span style="color:#ABB2BF">(</span></span>
<span class="line"><span style="color:#ABB2BF">        [</span></span>
<span class="line"><span style="color:#ABB2BF">            {</span></span>
<span class="line"><span style="color:#98C379">                &quot;role&quot;</span><span style="color:#ABB2BF">: </span><span style="color:#98C379">&quot;user&quot;</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#98C379">                &quot;content&quot;</span><span style="color:#ABB2BF">: </span><span style="color:#98C379">&quot;&quot;&quot;This is an exercise to learn some key principles of NVC as presented by Marshall B. Rosenberg</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">```</span></span>
<span class="line"><span style="color:#98C379">OBSERVATION OR EVALUATION?</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">In the context of Nonviolent Communication (NVC), it&#39;s crucial to distinguish between observations and evaluations. Observations are neutral descriptions of what one perceives, devoid of personal judgments or interpretations. In contrast, evaluations contain personal judgments or interpretations of situations. Your task is to review the provided statements and identify which ones are pure observations without any evaluations mixed in. By mastering this distinction, you can communicate more effectively, minimizing misunderstandings and conflicts.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">To determine your proficiency at discerning between observations and evaluations, complete the following exercise.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">Statement: “John was angry with me yesterday for no reason.”</span></span>
<span class="line"><span style="color:#98C379">Reasoning: The statement suggests that John felt a certain emotion (anger) directed towards the speaker and adds the qualifier &quot;for no reason&quot;. Emotions are subjective experiences, and we can&#39;t definitively know someone&#39;s emotion unless they express it. The phrase &quot;for no reason&quot; is a judgment because it interprets the cause of John&#39;s perceived emotion.</span></span>
<span class="line"><span style="color:#98C379">Classification: Evaluation</span></span>
<span class="line"><span style="color:#98C379">Pure observation alternative: “John told me he was angry,” or “John pounded his fist on the table.”</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">Statement: “Yesterday evening Nancy bit her fingernails while watching television.”</span></span>
<span class="line"><span style="color:#98C379">Reasoning: This statement is simply describing an action Nancy did at a specific time. There is no attached judgment or interpretation of why she did it or what it means about her character or state of mind.</span></span>
<span class="line"><span style="color:#98C379">Classification: Observation</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">Statement: “Sam didn’t ask for my opinion during the meeting.”</span></span>
<span class="line"><span style="color:#98C379">Reasoning: This is a factual statement about something Sam did not do during a meeting. It doesn&#39;t assign any emotion, motive, or judgment to Sam&#39;s actions.</span></span>
<span class="line"><span style="color:#98C379">Classification: Observation</span></span>
<span class="line"><span style="color:#98C379">Statement: “My father is a good man.”</span></span>
<span class="line"><span style="color:#98C379">Reasoning: The term &quot;good&quot; is subjective. What constitutes a &quot;good man&quot; can vary from person to person. This statement is expressing a personal judgment or belief about the father&#39;s character rather than a factual observation.</span></span>
<span class="line"><span style="color:#98C379">Classification: Evaluation</span></span>
<span class="line"><span style="color:#98C379">Nonviolent alternative: “For the last twenty-five years, my father has given one-tenth of his salary to charity.”</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">Statement: “Janice works too much.”</span></span>
<span class="line"><span style="color:#98C379">Reasoning: The phrase &quot;too much&quot; is a judgment that implies there is an appropriate or normal amount of work, and Janice exceeds that. It&#39;s not a simple recounting of facts but an interpretation of her work habits.</span></span>
<span class="line"><span style="color:#98C379">Classification: Evaluation</span></span>
<span class="line"><span style="color:#98C379">Pure observation alternative: “Janice spent more than sixty hours at the office this week.”</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">Statement: “Henry is aggressive.”</span></span>
<span class="line"><span style="color:#98C379">Reasoning: Labeling Henry as &quot;aggressive&quot; is a judgment. &quot;Aggressive&quot; is an interpretive term that assigns a character trait to Henry based on behaviors or actions that aren&#39;t specified in this statement.</span></span>
<span class="line"><span style="color:#98C379">Classification: Evaluation</span></span>
<span class="line"><span style="color:#98C379">Pure observation alternative: “Henry hit his sister when she switched the television channel.”</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">Statement: “Pam was first in line every day this week.”</span></span>
<span class="line"><span style="color:#98C379">Reasoning: This statement simply states a repeated action Pam took on specific days. There&#39;s no interpretation about why she was first in line or what it might mean about her character.</span></span>
<span class="line"><span style="color:#98C379">Classification: Observation</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">Statement: “My son often doesn’t brush his teeth.”</span></span>
<span class="line"><span style="color:#98C379">Reasoning: The term &quot;often&quot; is a judgment that implies a frequency comparison to what is considered normal or acceptable. The statement isn&#39;t just stating times when the son didn&#39;t brush his teeth but is implying he neglects this action more than he should.</span></span>
<span class="line"><span style="color:#98C379">Classification: Evaluation</span></span>
<span class="line"><span style="color:#98C379">Pure observation alternative: “Twice this week my son didn’t brush his teeth before going to bed.”</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">Statement: “Luke told me I didn’t look good in yellow.”</span></span>
<span class="line"><span style="color:#98C379">Reasoning: This statement recounts a specific thing Luke said to the speaker. While Luke&#39;s statement was evaluative, the speaker is merely stating a fact about what Luke expressed, without adding their own judgment or interpretation.</span></span>
<span class="line"><span style="color:#98C379">Classification: Observation</span></span>
<span class="line"><span style="color:#98C379">```</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">We are trying to create a dataset of these statement classification to train an expert language model to learn to do this classification.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">We have collected thousands of samples but they vary in quality. The text above text showcases the highest quality possible. Not all our collected samples have this quality. We aim to assess the quality of our samples. You will be tasked with looking at a sample and telling me what quality it is based on guidelines I will provide to you.</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">My guidelines come in the form of examples.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">Good example 10/10</span></span>
<span class="line"><span style="color:#98C379">==================================</span></span>
<span class="line"><span style="color:#98C379">Statement:“I think it&#39;s ridiculous that we have to pretend to be someone else just to see an apartment.”</span></span>
<span class="line"><span style="color:#98C379">Reasoning: The statement contains evaluative language like &quot;ridiculous&quot; and &quot;pretend to be someone else,&quot; which are judgments about the situation.</span></span>
<span class="line"><span style="color:#98C379">Classification: Evaluation</span></span>
<span class="line"><span style="color:#98C379">Pure observation alternative: “We had to wear suits and ties to see an apartment.”</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">Rating: Suggests an observation statement that does not tie identity to time bound clothing choices</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">Final judgment: Good sample because of clear example of evaluative language and good classification and reasoning + suggestion on the student&#39;s behalf</span></span>
<span class="line"><span style="color:#98C379">==================================</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">Okay-ish example 7/10</span></span>
<span class="line"><span style="color:#98C379">==================================</span></span>
<span class="line"><span style="color:#98C379">Statement:“I think Rose is too focused on the game and not paying enough attention to the road.”</span></span>
<span class="line"><span style="color:#98C379">Reasoning: This statement contains a judgment about Rose&#39;s level of focus and attention, which is subjective and not a factual observation.</span></span>
<span class="line"><span style="color:#98C379">Classification: Evaluation</span></span>
<span class="line"><span style="color:#98C379">Pure observation alternative: “Rose is playing a game on her phone while driving.”</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">Rating: The spirit is there but actually a driver being distracted and not paying enough attention to the road is a valid concern and not a simple evaluation</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">Final judgment: bad sample because of ambiguous statement</span></span>
<span class="line"><span style="color:#98C379">==================================</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">Good example 8/10</span></span>
<span class="line"><span style="color:#98C379">==================================</span></span>
<span class="line"><span style="color:#98C379">Statement:“I think it&#39;s ridiculous that Toni is so obsessed with his old high school hangout. It&#39;s like he&#39;s stuck in the past and can&#39;t move on.”</span></span>
<span class="line"><span style="color:#98C379">Reasoning: This statement includes several evaluations, such as &quot;ridiculous,&quot; &quot;obsessed,&quot; and &quot;stuck in the past.&quot; These terms imply a negative judgment of Toni&#39;s behavior and mindset.</span></span>
<span class="line"><span style="color:#98C379">Classification: Evaluation</span></span>
<span class="line"><span style="color:#98C379">Pure observation alternative: “Toni has mentioned his high school hangout several times in the past week.”</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">Rating: The student correctly identified the use of evaluative language in the statement and provided a simple straight forward and not convoluted evaluation free observation</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">Final judgment: Good sample because of clear example statement</span></span>
<span class="line"><span style="color:#98C379">==================================</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">Okay-ish example 7/10</span></span>
<span class="line"><span style="color:#98C379">==================================</span></span>
<span class="line"><span style="color:#98C379">Statement:“I think Stacey really appreciates this new jacket I bought.”</span></span>
<span class="line"><span style="color:#98C379">Reasoning: The statement includes the phrase &quot;I think,&quot; which implies the speaker is expressing their own interpretation or judgment about Stacey&#39;s feelings towards the jacket.</span></span>
<span class="line"><span style="color:#98C379">Classification: Evaluation</span></span>
<span class="line"><span style="color:#98C379">Pure observation alternative: “Stacey smiled and said ‘thank you’ when I gave her the jacket.”</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">Rating: While the observation is clearly a good observation statement, the first statement could be justified in context. For instance the speaker could have said prior facts about Stacey and the jacket</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">Final judgment: bad sample because of ambiguous statement</span></span>
<span class="line"><span style="color:#98C379">==================================</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">Good example 7.5/10</span></span>
<span class="line"><span style="color:#98C379">==================================</span></span>
<span class="line"><span style="color:#98C379">Statement:“I think Pacheco is always so focused on winning that he forgets to enjoy the game.”</span></span>
<span class="line"><span style="color:#98C379">Reasoning: This statement contains an evaluation of Pacheco&#39;s behavior. The speaker is interpreting Pacheco&#39;s focus on winning as a negative trait that prevents him from enjoying the game.</span></span>
<span class="line"><span style="color:#98C379">Classification: Evaluation</span></span>
<span class="line"><span style="color:#98C379">Pure observation alternative: “Pacheco has been practicing with the team every day for the past month.”</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">Rating: Good classification and reasoning on the student&#39;s practicing</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">Final judgment: Good sample because of classification, but statement could be clearer in a textbook setting</span></span>
<span class="line"><span style="color:#98C379">==================================</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">Bad example 4/10</span></span>
<span class="line"><span style="color:#98C379">==================================</span></span>
<span class="line"><span style="color:#98C379">Statement:“I think Stephanie is a great girl, but we just couldn&#39;t make it work between us.”</span></span>
<span class="line"><span style="color:#98C379">Reasoning: This statement includes a judgment about Stephanie&#39;s character (she&#39;s a &quot;great girl&quot;) and a personal interpretation of the speaker&#39;s relationship with her (they &quot;couldn&#39;t make it work&quot;).</span></span>
<span class="line"><span style="color:#98C379">Classification: Evaluation</span></span>
<span class="line"><span style="color:#98C379">Pure observation alternative: “I have a lot of respect for Stephanie, but we decided to end our relationship.”</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">Rating: Classification lacks nuance</span></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">Final judgment: Bad sample because of overly simplistic classification and reasoning and useless alternative suggestion</span></span>
<span class="line"><span style="color:#98C379">==================================</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#98C379">I will give you a sample and you will rate it as I thought you. Understood?&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#ABB2BF">},</span></span>
<span class="line"><span style="color:#ABB2BF">            {</span></span>
<span class="line"><span style="color:#98C379">                &quot;content&quot;</span><span style="color:#ABB2BF">: </span><span style="color:#98C379">&quot;Understood. I will rate the given samples based on the guidelines you provided. Please provide me with the first sample to rate.&quot;</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#98C379">                &quot;role&quot;</span><span style="color:#ABB2BF">: </span><span style="color:#98C379">&quot;assistant&quot;</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#ABB2BF">            },</span></span>
<span class="line"><span style="color:#ABB2BF">            {</span><span style="color:#98C379">&quot;content&quot;</span><span style="color:#ABB2BF">: sample, </span><span style="color:#98C379">&quot;role&quot;</span><span style="color:#ABB2BF">: </span><span style="color:#98C379">&quot;user&quot;</span><span style="color:#ABB2BF">},</span></span>
<span class="line"><span style="color:#ABB2BF">        ],</span></span>
<span class="line"><span style="color:#E06C75;font-style:italic">        tokenize</span><span style="color:#56B6C2">=</span><span style="color:#D19A66">False</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#E06C75;font-style:italic">        add_generation_prompt</span><span style="color:#56B6C2">=</span><span style="color:#D19A66">True</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#ABB2BF">    ) </span><span style="color:#56B6C2">+</span><span style="color:#98C379"> &#39;Rating:&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">def</span><span style="color:#61AFEF"> create_ratings_table</span><span style="color:#ABB2BF">():</span></span>
<span class="line"><span style="color:#ABB2BF">    conn </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> sqlite3.</span><span style="color:#61AFEF">connect</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;results.sqlite&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">    c </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> conn.</span><span style="color:#61AFEF">cursor</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">    c.</span><span style="color:#61AFEF">execute</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;&#39;&#39;</span></span>
<span class="line"><span style="color:#98C379">        CREATE TABLE IF NOT EXISTS hermes_ratings (</span></span>
<span class="line"><span style="color:#98C379">            id INTEGER PRIMARY KEY,</span></span>
<span class="line"><span style="color:#98C379">            sample TEXT,</span></span>
<span class="line"><span style="color:#98C379">            prompt TEXT,</span></span>
<span class="line"><span style="color:#98C379">            generation TEXT,</span></span>
<span class="line"><span style="color:#98C379">            generation_params json</span></span>
<span class="line"><span style="color:#98C379">        )</span></span>
<span class="line"><span style="color:#98C379">    &#39;&#39;&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">    conn.</span><span style="color:#61AFEF">commit</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">    conn.</span><span style="color:#61AFEF">close</span><span style="color:#ABB2BF">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">def</span><span style="color:#61AFEF"> insert_generated_rating</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66;font-style:italic">sample</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66;font-style:italic">prompt</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66;font-style:italic">generation</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66;font-style:italic">generation_params</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#ABB2BF">    conn </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> sqlite3.</span><span style="color:#61AFEF">connect</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;results.sqlite&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">    c </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> conn.</span><span style="color:#61AFEF">cursor</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">    c.</span><span style="color:#61AFEF">execute</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;&#39;&#39;</span></span>
<span class="line"><span style="color:#98C379">        INSERT INTO hermes_ratings (sample, prompt, generation, generation_params)</span></span>
<span class="line"><span style="color:#98C379">        VALUES (?, ?, ?, ?)</span></span>
<span class="line"><span style="color:#98C379">    &#39;&#39;&#39;</span><span style="color:#ABB2BF">, (sample, prompt, generation, json.</span><span style="color:#61AFEF">dumps</span><span style="color:#ABB2BF">(generation_params)))</span></span>
<span class="line"><span style="color:#ABB2BF">    conn.</span><span style="color:#61AFEF">commit</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">    conn.</span><span style="color:#61AFEF">close</span><span style="color:#ABB2BF">()</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">def</span><span style="color:#61AFEF"> get_generated_evaluation_for_prompt</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66;font-style:italic">prompt</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#ABB2BF">    conn </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> sqlite3.</span><span style="color:#61AFEF">connect</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;results.sqlite&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">    c </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> conn.</span><span style="color:#61AFEF">cursor</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">    c.</span><span style="color:#61AFEF">execute</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;&#39;&#39;</span></span>
<span class="line"><span style="color:#98C379">        SELECT generation FROM hermes_ratings WHERE prompt = ?</span></span>
<span class="line"><span style="color:#98C379">    &#39;&#39;&#39;</span><span style="color:#ABB2BF">, (prompt,))</span></span>
<span class="line"><span style="color:#ABB2BF">    result </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> c.</span><span style="color:#61AFEF">fetchone</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">    conn.</span><span style="color:#61AFEF">close</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#ABB2BF"> result[</span><span style="color:#D19A66">0</span><span style="color:#ABB2BF">] </span><span style="color:#C678DD">if</span><span style="color:#ABB2BF"> result </span><span style="color:#C678DD">else</span><span style="color:#D19A66"> None</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">def</span><span style="color:#61AFEF"> table_as_dataframe</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66;font-style:italic">table</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#ABB2BF">    conn </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> sqlite3.</span><span style="color:#61AFEF">connect</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;results.sqlite&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">    query </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> f</span><span style="color:#98C379">&#39;SELECT * FROM </span><span style="color:#D19A66">{</span><span style="color:#ABB2BF">table</span><span style="color:#D19A66">}</span><span style="color:#98C379">&#39;</span></span>
<span class="line"><span style="color:#ABB2BF">    df </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> pd.</span><span style="color:#61AFEF">read_sql_query</span><span style="color:#ABB2BF">(query, conn)</span></span>
<span class="line"><span style="color:#ABB2BF">    conn.</span><span style="color:#61AFEF">close</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#ABB2BF"> df</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">def</span><span style="color:#61AFEF"> generate_evaluation</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66;font-style:italic">sample</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66;font-style:italic">max_retries</span><span style="color:#ABB2BF">=</span><span style="color:#D19A66">10</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#ABB2BF">    generation_params </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#98C379">        &quot;model&quot;</span><span style="color:#ABB2BF">: </span><span style="color:#98C379">&quot;NousResearch/Nous-Hermes-2-Mixtral-8x7B-DPO&quot;</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#98C379">        &quot;max_tokens&quot;</span><span style="color:#ABB2BF">: </span><span style="color:#D19A66">512</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#98C379">        &quot;temperature&quot;</span><span style="color:#ABB2BF">: </span><span style="color:#D19A66">0.7</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#98C379">        &quot;top_p&quot;</span><span style="color:#ABB2BF">: </span><span style="color:#D19A66">0.7</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#98C379">        &quot;top_k&quot;</span><span style="color:#ABB2BF">: </span><span style="color:#D19A66">50</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#98C379">        &quot;stop&quot;</span><span style="color:#ABB2BF">: [</span></span>
<span class="line"><span style="color:#98C379">            &quot;&lt;|im_end|&gt;&quot;</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#98C379">            &quot;&lt;|im_start|&gt;&quot;</span></span>
<span class="line"><span style="color:#ABB2BF">        ],</span></span>
<span class="line"><span style="color:#98C379">        &quot;repetition_penalty&quot;</span><span style="color:#ABB2BF">: </span><span style="color:#D19A66">1</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    prompt </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> evaluation_prompt</span><span style="color:#ABB2BF">(sample)</span></span>
<span class="line"><span style="color:#ABB2BF">    </span></span>
<span class="line"><span style="color:#ABB2BF">    existing_generation </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> get_generated_evaluation_for_prompt</span><span style="color:#ABB2BF">(prompt)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#ABB2BF"> existing_generation </span><span style="color:#C678DD">is</span><span style="color:#C678DD"> not</span><span style="color:#D19A66"> None</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#56B6C2">        print</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&quot;Found existing generation for prompt&quot;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#D19A66"> None</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    retries </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 0</span></span>
<span class="line"><span style="color:#C678DD">    while</span><span style="color:#ABB2BF"> retries </span><span style="color:#56B6C2">&lt;</span><span style="color:#ABB2BF"> max_retries:</span></span>
<span class="line"><span style="color:#C678DD">        try</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#ABB2BF">            res </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> requests.</span><span style="color:#61AFEF">post</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">ENDPOINT_URL</span><span style="color:#ABB2BF">, </span><span style="color:#E06C75;font-style:italic">json</span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF">{</span></span>
<span class="line"><span style="color:#56B6C2">                **</span><span style="color:#ABB2BF">generation_params,</span></span>
<span class="line"><span style="color:#98C379">                &quot;prompt&quot;</span><span style="color:#ABB2BF">: prompt,</span></span>
<span class="line"><span style="color:#ABB2BF">            }, </span><span style="color:#E06C75;font-style:italic">headers</span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF">{</span></span>
<span class="line"><span style="color:#98C379">                &quot;Authorization&quot;</span><span style="color:#ABB2BF">: </span><span style="color:#C678DD">f</span><span style="color:#98C379">&quot;Bearer </span><span style="color:#D19A66">{TOGETHER_API_KEY}</span><span style="color:#98C379">&quot;</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#ABB2BF">            })</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">            if</span><span style="color:#ABB2BF"> res.status_code </span><span style="color:#56B6C2">==</span><span style="color:#D19A66"> 200</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#C678DD">                return</span><span style="color:#ABB2BF"> sample, prompt, res.</span><span style="color:#61AFEF">json</span><span style="color:#ABB2BF">()[</span><span style="color:#98C379">&#39;choices&#39;</span><span style="color:#ABB2BF">][</span><span style="color:#D19A66">0</span><span style="color:#ABB2BF">][</span><span style="color:#98C379">&#39;text&#39;</span><span style="color:#ABB2BF">], generation_params</span></span>
<span class="line"><span style="color:#C678DD">            else</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#ABB2BF">                error_message </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> res.text</span></span>
<span class="line"><span style="color:#56B6C2">                print</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">f</span><span style="color:#98C379">&quot;Attempt </span><span style="color:#D19A66">{</span><span style="color:#ABB2BF">retries </span><span style="color:#56B6C2">+</span><span style="color:#D19A66"> 1}</span><span style="color:#98C379"> failed with status code </span><span style="color:#D19A66">{</span><span style="color:#ABB2BF">res.status_code</span><span style="color:#D19A66">}</span><span style="color:#98C379">. Error: </span><span style="color:#D19A66">{</span><span style="color:#ABB2BF">error_message</span><span style="color:#D19A66">}</span><span style="color:#98C379">. Retrying...&quot;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#C678DD">        except</span><span style="color:#ABB2BF"> requests.exceptions.RequestException </span><span style="color:#C678DD">as</span><span style="color:#ABB2BF"> e:</span></span>
<span class="line"><span style="color:#56B6C2">            print</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">f</span><span style="color:#98C379">&quot;An error occurred: </span><span style="color:#D19A66">{</span><span style="color:#ABB2BF">e</span><span style="color:#D19A66">}</span><span style="color:#98C379">. Retrying...&quot;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">        retries </span><span style="color:#56B6C2">+=</span><span style="color:#D19A66"> 1</span></span>
<span class="line"><span style="color:#ABB2BF">        time.</span><span style="color:#61AFEF">sleep</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">1</span><span style="color:#ABB2BF">)  </span><span style="color:#7F848E;font-style:italic"># Sleep for a bit before retrying to avoid overwhelming the server</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#D19A66"> None</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#61AFEF">create_ratings_table</span><span style="color:#ABB2BF">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">arguments_list </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> [</span><span style="color:#61AFEF">format_sample</span><span style="color:#ABB2BF">(kept.iloc[i].</span><span style="color:#61AFEF">to_dict</span><span style="color:#ABB2BF">()) </span><span style="color:#C678DD">for</span><span style="color:#ABB2BF"> i </span><span style="color:#C678DD">in</span><span style="color:#56B6C2"> range</span><span style="color:#ABB2BF">(</span><span style="color:#56B6C2">len</span><span style="color:#ABB2BF">(kept))]</span></span>
<span class="line"><span style="color:#ABB2BF">generator </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> Generator</span><span style="color:#ABB2BF">(</span><span style="color:#E06C75;font-style:italic">max_workers</span><span style="color:#56B6C2">=</span><span style="color:#D19A66">20</span><span style="color:#ABB2BF">, </span><span style="color:#E06C75;font-style:italic">generate_function</span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF">generate_evaluation, </span><span style="color:#E06C75;font-style:italic">arguments_list</span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF">arguments_list)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">for</span><span style="color:#ABB2BF"> result </span><span style="color:#C678DD">in</span><span style="color:#61AFEF"> tqdm</span><span style="color:#ABB2BF">(generator, </span><span style="color:#E06C75;font-style:italic">total</span><span style="color:#56B6C2">=len</span><span style="color:#ABB2BF">(arguments_list)):</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#ABB2BF"> result </span><span style="color:#C678DD">is</span><span style="color:#C678DD"> not</span><span style="color:#D19A66"> None</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#ABB2BF">        sample, prompt, generation, generation_params </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> result</span></span>
<span class="line"><span style="color:#61AFEF">        insert_generated_rating</span><span style="color:#ABB2BF">(sample, prompt, generation, generation_params)</span></span></code></pre>
<p><code>df = table_as_dataframe(&#39;hermes_ratings&#39;)</code></p>
<p><code>df.sample(1).iloc[0]</code></p>
<div class="output-result" data-astro-cid-c5o6katz> 














<table><thead><tr><th>idx</th><th>Input</th><th>Rating</th></tr></thead><tbody><tr><td>0</td><td>Statement:“Jon, it’s Charles’s last day. We have to celebrate.”\nReasoning: This statement includes a judgment that it’s necessary to celebrate Charles’s last day. The speaker is imposing their interpretation of what should happen, rather than simply stating a fact or observation.\nClassification: Evaluation\nPure observation alternative: “It’s Charles’s last day. I feel sad.”</td><td>The reasoning provided is not entirely accurate. The statement does not necessarily contain a judgment, but rather an expression of the speaker’s feelings and a suggestion for an action to take. However, it does not strictly fit the definition of an observation statement.\nFinal judgment: The sample is not a perfect example, but it leans more towards an evaluation due to the suggestion of celebration. Rating: 6/10.</td></tr></tbody></table> </div> 
<p>Looks good to me.</p>
<p>Let’s now filter for the samples rated as “Good”.</p>
<pre class="astro-code one-dark-pro" style="background-color:#282c34;color:#abb2bf;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">good </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> [sample </span><span style="color:#C678DD">for</span><span style="color:#ABB2BF"> sample, evaluation </span><span style="color:#C678DD">in</span><span style="color:#56B6C2"> zip</span><span style="color:#ABB2BF">(df[</span><span style="color:#98C379">&#39;sample&#39;</span><span style="color:#ABB2BF">].</span><span style="color:#61AFEF">to_list</span><span style="color:#ABB2BF">(), df[</span><span style="color:#98C379">&#39;generation&#39;</span><span style="color:#ABB2BF">].</span><span style="color:#61AFEF">to_list</span><span style="color:#ABB2BF">()) </span><span style="color:#C678DD">if</span><span style="color:#98C379"> &#39;Final judgment: Good&#39;</span><span style="color:#C678DD"> in</span><span style="color:#ABB2BF"> evaluation]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">good_samples </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> [</span><span style="color:#61AFEF">extract_all_fields</span><span style="color:#ABB2BF">(sample) </span><span style="color:#C678DD">for</span><span style="color:#ABB2BF"> sample </span><span style="color:#C678DD">in</span><span style="color:#ABB2BF"> good </span><span style="color:#C678DD">if</span><span style="color:#56B6C2"> len</span><span style="color:#ABB2BF">(</span><span style="color:#61AFEF">extract_all_fields</span><span style="color:#ABB2BF">(sample).</span><span style="color:#61AFEF">keys</span><span style="color:#ABB2BF">()) </span><span style="color:#56B6C2">==</span><span style="color:#D19A66"> 4</span><span style="color:#ABB2BF">] </span><span style="color:#7F848E;font-style:italic"># Let&#39;s also keep only the samples that have all the four fields we want to parse```</span></span></code></pre>
<p>Now that we’ve filtered for quality, let’s plot the class distribution again.</p>
<astro-accordion data-code="{codeBlock}" data-astro-cid-qbtd5bqq> <button class="accordion-toggle flex items-center text-sm" data-astro-cid-qbtd5bqq><b data-astro-cid-qbtd5bqq>Show Code</b> <svg class="chevron-icon w-6 h-6 -rotate-90 transition-transform transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" data-astro-cid-qbtd5bqq> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" data-astro-cid-qbtd5bqq></path> </svg></button> <div class="code-content hidden" data-astro-cid-qbtd5bqq> <pre class="astro-code one-dark-pro" style="background-color:#282c34;color:#abb2bf;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word" tabindex="0"><code><span class="line"><span style="color:#C678DD">import</span><span style="color:#ABB2BF"> matplotlib.pyplot </span><span style="color:#C678DD">as</span><span style="color:#ABB2BF"> plt</span></span>
<span class="line"><span style="color:#C678DD">import</span><span style="color:#ABB2BF"> numpy </span><span style="color:#C678DD">as</span><span style="color:#ABB2BF"> np</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">classes </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> [sample[</span><span style="color:#98C379">&#39;classification&#39;</span><span style="color:#ABB2BF">] </span><span style="color:#C678DD">for</span><span style="color:#ABB2BF"> sample </span><span style="color:#C678DD">in</span><span style="color:#ABB2BF"> good_samples]</span></span>
<span class="line"><span style="color:#ABB2BF">classification_labels </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> [label </span><span style="color:#C678DD">for</span><span style="color:#ABB2BF"> label </span><span style="color:#C678DD">in</span><span style="color:#ABB2BF"> classes </span><span style="color:#C678DD">if</span><span style="color:#ABB2BF"> label </span><span style="color:#C678DD">is</span><span style="color:#C678DD"> not</span><span style="color:#D19A66"> None</span><span style="color:#ABB2BF">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic"># Create a histogram of the classification labels</span></span>
<span class="line"><span style="color:#ABB2BF">unique_labels, label_counts </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> np.</span><span style="color:#61AFEF">unique</span><span style="color:#ABB2BF">(classification_labels, </span><span style="color:#E06C75;font-style:italic">return_counts</span><span style="color:#56B6C2">=</span><span style="color:#D19A66">True</span><span style="color:#ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic"># Plot the histogram</span></span>
<span class="line"><span style="color:#ABB2BF">plt.</span><span style="color:#61AFEF">bar</span><span style="color:#ABB2BF">(unique_labels, label_counts)</span></span>
<span class="line"><span style="color:#ABB2BF">plt.</span><span style="color:#61AFEF">xlabel</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;Classes&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">plt.</span><span style="color:#61AFEF">ylabel</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;Frequency&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">plt.</span><span style="color:#61AFEF">title</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;Classification Distribution Histogram&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">plt.</span><span style="color:#61AFEF">show</span><span style="color:#ABB2BF">()</span></span></code></pre> </div> </astro-accordion>  
<p><img src="/images/nvc/5.png" alt="image"/></p>
<p>We only have one class represented in our dataset! Let’s fix that.</p>
<h2 id="balancing-the-dataset">Balancing the dataset</h2>
<p>You might have noticed that every statement comes with a generated “Pure observation alternative”. Let’s take 50% of our samples and switch the main statement to the observation alternative, then generate a new rationale and classification with this.</p>
<pre class="astro-code one-dark-pro" style="background-color:#282c34;color:#abb2bf;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word" tabindex="0"><code><span class="line"><span style="color:#C678DD">import</span><span style="color:#ABB2BF"> random</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic"># randomly select 50% of the samples to be observations</span></span>
<span class="line"><span style="color:#ABB2BF">observations </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> [sample[</span><span style="color:#98C379">&#39;pure_observation_alternative&#39;</span><span style="color:#ABB2BF">].</span><span style="color:#61AFEF">strip</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;“&#39;</span><span style="color:#ABB2BF">).</span><span style="color:#61AFEF">rstrip</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;”&#39;</span><span style="color:#ABB2BF">) </span><span style="color:#C678DD">for</span><span style="color:#ABB2BF"> sample </span><span style="color:#C678DD">in</span><span style="color:#ABB2BF"> random.</span><span style="color:#61AFEF">sample</span><span style="color:#ABB2BF">(good_samples, </span><span style="color:#56B6C2">int</span><span style="color:#ABB2BF">(</span><span style="color:#56B6C2">len</span><span style="color:#ABB2BF">(good_samples)</span><span style="color:#56B6C2">/</span><span style="color:#D19A66">2</span><span style="color:#ABB2BF">))]</span></span></code></pre>
<p>Now we generate the new rationales and classifications for the swapped statements</p>
<pre class="astro-code one-dark-pro" style="background-color:#282c34;color:#abb2bf;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word" tabindex="0"><code><span class="line"><span style="color:#C678DD">def</span><span style="color:#61AFEF"> create_swapped_classifications_table</span><span style="color:#ABB2BF">():</span></span>
<span class="line"><span style="color:#ABB2BF">    conn </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> sqlite3.</span><span style="color:#61AFEF">connect</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;results.sqlite&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">    c </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> conn.</span><span style="color:#61AFEF">cursor</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">    c.</span><span style="color:#61AFEF">execute</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;&#39;&#39;</span></span>
<span class="line"><span style="color:#98C379">        CREATE TABLE IF NOT EXISTS swapped_classifications (</span></span>
<span class="line"><span style="color:#98C379">            id INTEGER PRIMARY KEY,</span></span>
<span class="line"><span style="color:#98C379">            statement TEXT,</span></span>
<span class="line"><span style="color:#98C379">            prompt TEXT,</span></span>
<span class="line"><span style="color:#98C379">            generation TEXT,</span></span>
<span class="line"><span style="color:#98C379">            generation_params json</span></span>
<span class="line"><span style="color:#98C379">        )</span></span>
<span class="line"><span style="color:#98C379">    &#39;&#39;&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">    conn.</span><span style="color:#61AFEF">commit</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">    conn.</span><span style="color:#61AFEF">close</span><span style="color:#ABB2BF">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">def</span><span style="color:#61AFEF"> insert_generated_classification</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66;font-style:italic">statement</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66;font-style:italic">prompt</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66;font-style:italic">generation</span><span style="color:#ABB2BF">, </span><span style="color:#D19A66;font-style:italic">generation_params</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#ABB2BF">    conn </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> sqlite3.</span><span style="color:#61AFEF">connect</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;results.sqlite&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">    c </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> conn.</span><span style="color:#61AFEF">cursor</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">    c.</span><span style="color:#61AFEF">execute</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;&#39;&#39;</span></span>
<span class="line"><span style="color:#98C379">        INSERT INTO swapped_classifications (statement, prompt, generation, generation_params)</span></span>
<span class="line"><span style="color:#98C379">        VALUES (?, ?, ?, ?)</span></span>
<span class="line"><span style="color:#98C379">    &#39;&#39;&#39;</span><span style="color:#ABB2BF">, (statement, prompt, generation, json.</span><span style="color:#61AFEF">dumps</span><span style="color:#ABB2BF">(generation_params)))</span></span>
<span class="line"><span style="color:#ABB2BF">    conn.</span><span style="color:#61AFEF">commit</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">    conn.</span><span style="color:#61AFEF">close</span><span style="color:#ABB2BF">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">def</span><span style="color:#61AFEF"> table_as_dataframe</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66;font-style:italic">table</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#ABB2BF">    conn </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> sqlite3.</span><span style="color:#61AFEF">connect</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;results.sqlite&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">    query </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> f</span><span style="color:#98C379">&#39;SELECT * FROM </span><span style="color:#D19A66">{</span><span style="color:#ABB2BF">table</span><span style="color:#D19A66">}</span><span style="color:#98C379">&#39;</span></span>
<span class="line"><span style="color:#ABB2BF">    df </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> pd.</span><span style="color:#61AFEF">read_sql_query</span><span style="color:#ABB2BF">(query, conn)</span></span>
<span class="line"><span style="color:#ABB2BF">    conn.</span><span style="color:#61AFEF">close</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#ABB2BF"> df</span></span>
<span class="line"></span>
<span class="line"><span style="color:#61AFEF">create_swapped_classifications_table</span><span style="color:#ABB2BF">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">arguments_list </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> observations</span></span>
<span class="line"><span style="color:#ABB2BF">generator </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> Generator</span><span style="color:#ABB2BF">(</span><span style="color:#E06C75;font-style:italic">max_workers</span><span style="color:#56B6C2">=</span><span style="color:#D19A66">20</span><span style="color:#ABB2BF">, </span><span style="color:#E06C75;font-style:italic">generate_function</span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF">generate_classification, </span><span style="color:#E06C75;font-style:italic">arguments_list</span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF">arguments_list)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">for</span><span style="color:#ABB2BF"> result </span><span style="color:#C678DD">in</span><span style="color:#61AFEF"> tqdm</span><span style="color:#ABB2BF">(generator, </span><span style="color:#E06C75;font-style:italic">total</span><span style="color:#56B6C2">=len</span><span style="color:#ABB2BF">(arguments_list)):</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#ABB2BF"> result </span><span style="color:#C678DD">is</span><span style="color:#C678DD"> not</span><span style="color:#D19A66"> None</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#ABB2BF">        statement, prompt, generation, generation_params </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> result</span></span>
<span class="line"><span style="color:#61AFEF">        insert_generated_classification</span><span style="color:#ABB2BF">(statement, prompt, generation, generation_params)</span></span></code></pre>
<p>For good measure let’s keep only the new samples reclassified as Observations</p>
<pre class="astro-code one-dark-pro" style="background-color:#282c34;color:#abb2bf;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">statements </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> fetch_column</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;swapped_classifications&#39;</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">&#39;statement&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">generations </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> fetch_column</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;swapped_classifications&#39;</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">&#39;generation&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">swapped </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> [sample </span><span style="color:#C678DD">for</span><span style="color:#ABB2BF"> sample </span><span style="color:#C678DD">in</span><span style="color:#ABB2BF"> [</span><span style="color:#61AFEF">extract_all_fields</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;Statement: &#39;</span><span style="color:#56B6C2"> +</span><span style="color:#ABB2BF"> statements[i] </span><span style="color:#56B6C2">+</span><span style="color:#98C379"> &#39;</span><span style="color:#56B6C2">\n</span><span style="color:#98C379">&#39;</span><span style="color:#56B6C2"> +</span><span style="color:#ABB2BF"> gen) </span><span style="color:#C678DD">for</span><span style="color:#ABB2BF"> i, gen </span><span style="color:#C678DD">in</span><span style="color:#56B6C2"> enumerate</span><span style="color:#ABB2BF">(generations)] </span><span style="color:#C678DD">if</span><span style="color:#ABB2BF"> sample[</span><span style="color:#98C379">&#39;classification&#39;</span><span style="color:#ABB2BF">] </span><span style="color:#56B6C2">==</span><span style="color:#98C379"> &#39;Observation&#39;</span><span style="color:#ABB2BF">]</span></span></code></pre>
<p>Let’s filter yet again for good classifications</p>
<pre class="astro-code one-dark-pro" style="background-color:#282c34;color:#abb2bf;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">arguments_list </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> [</span><span style="color:#61AFEF">format_sample</span><span style="color:#ABB2BF">(sample) </span><span style="color:#C678DD">for</span><span style="color:#ABB2BF"> sample </span><span style="color:#C678DD">in</span><span style="color:#ABB2BF"> swapped]</span></span>
<span class="line"><span style="color:#ABB2BF">generator </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> Generator</span><span style="color:#ABB2BF">(</span><span style="color:#E06C75;font-style:italic">max_workers</span><span style="color:#56B6C2">=</span><span style="color:#D19A66">20</span><span style="color:#ABB2BF">, </span><span style="color:#E06C75;font-style:italic">generate_function</span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF">generate_evaluation, </span><span style="color:#E06C75;font-style:italic">arguments_list</span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF">arguments_list)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">for</span><span style="color:#ABB2BF"> result </span><span style="color:#C678DD">in</span><span style="color:#61AFEF"> tqdm</span><span style="color:#ABB2BF">(generator, </span><span style="color:#E06C75;font-style:italic">total</span><span style="color:#56B6C2">=len</span><span style="color:#ABB2BF">(arguments_list)):</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#ABB2BF"> result </span><span style="color:#C678DD">is</span><span style="color:#C678DD"> not</span><span style="color:#D19A66"> None</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#ABB2BF">        sample, prompt, generation, generation_params </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> result</span></span>
<span class="line"><span style="color:#61AFEF">        insert_generated_classification</span><span style="color:#ABB2BF">(sample, prompt, generation, generation_params)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">def</span><span style="color:#61AFEF"> fetch_rating_from_sample</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66;font-style:italic">sample</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#ABB2BF">    conn </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> sqlite3.</span><span style="color:#61AFEF">connect</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;results.sqlite&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">    cursor </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> conn.</span><span style="color:#61AFEF">cursor</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">    </span></span>
<span class="line"><span style="color:#ABB2BF">    query </span><span style="color:#56B6C2">=</span><span style="color:#98C379"> &quot;SELECT generation FROM hermes_ratings WHERE sample = ?&quot;</span></span>
<span class="line"><span style="color:#ABB2BF">    </span></span>
<span class="line"><span style="color:#ABB2BF">    cursor.</span><span style="color:#61AFEF">execute</span><span style="color:#ABB2BF">(query, (sample,))</span></span>
<span class="line"><span style="color:#ABB2BF">    </span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    # Fetch the result</span></span>
<span class="line"><span style="color:#ABB2BF">    result </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> cursor.</span><span style="color:#61AFEF">fetchone</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">    </span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    # Close the connection</span></span>
<span class="line"><span style="color:#ABB2BF">    conn.</span><span style="color:#61AFEF">close</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#ABB2BF">    </span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    # Check if the result is not None and return the value of column D</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#ABB2BF"> result:</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#ABB2BF"> result[</span><span style="color:#D19A66">0</span><span style="color:#ABB2BF">]</span></span>
<span class="line"><span style="color:#C678DD">    else</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#D19A66"> None</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">kept_swapped </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> [sample </span><span style="color:#C678DD">for</span><span style="color:#ABB2BF"> sample </span><span style="color:#C678DD">in</span><span style="color:#ABB2BF"> swapped </span><span style="color:#C678DD">if</span><span style="color:#98C379"> &#39;Final judgment: Good&#39;</span><span style="color:#C678DD"> in</span><span style="color:#61AFEF"> fetch_rating_from_sample</span><span style="color:#ABB2BF">(</span><span style="color:#61AFEF">format_sample</span><span style="color:#ABB2BF">(sample))]</span></span>
<span class="line"><span style="color:#ABB2BF">intact_samples </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> [sample </span><span style="color:#C678DD">for</span><span style="color:#ABB2BF"> sample </span><span style="color:#C678DD">in</span><span style="color:#ABB2BF"> good_samples </span><span style="color:#C678DD">if</span><span style="color:#ABB2BF"> sample[</span><span style="color:#98C379">&#39;pure_observation_alternative&#39;</span><span style="color:#ABB2BF">].</span><span style="color:#61AFEF">strip</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;“&#39;</span><span style="color:#ABB2BF">).</span><span style="color:#61AFEF">rstrip</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;”&#39;</span><span style="color:#ABB2BF">) </span><span style="color:#C678DD">not</span><span style="color:#C678DD"> in</span><span style="color:#ABB2BF"> observations]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">final </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> intact_samples </span><span style="color:#56B6C2">+</span><span style="color:#ABB2BF"> kept_swapped</span></span></code></pre>
<p>We can now plot the new distribution</p>
<astro-accordion data-code="{codeBlock}" data-astro-cid-qbtd5bqq> <button class="accordion-toggle flex items-center text-sm" data-astro-cid-qbtd5bqq><b data-astro-cid-qbtd5bqq>Show Code</b> <svg class="chevron-icon w-6 h-6 -rotate-90 transition-transform transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" data-astro-cid-qbtd5bqq> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" data-astro-cid-qbtd5bqq></path> </svg></button> <div class="code-content hidden" data-astro-cid-qbtd5bqq> <pre class="astro-code one-dark-pro" style="background-color:#282c34;color:#abb2bf;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word" tabindex="0"><code><span class="line"><span style="color:#C678DD">import</span><span style="color:#ABB2BF"> matplotlib.pyplot </span><span style="color:#C678DD">as</span><span style="color:#ABB2BF"> plt</span></span>
<span class="line"><span style="color:#C678DD">import</span><span style="color:#ABB2BF"> numpy </span><span style="color:#C678DD">as</span><span style="color:#ABB2BF"> np</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">statements </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> fetch_column</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;swapped_classifications&#39;</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">&#39;statement&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">generations </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> fetch_column</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;swapped_classifications&#39;</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">&#39;generation&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">classes </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> [sample[</span><span style="color:#98C379">&#39;classification&#39;</span><span style="color:#ABB2BF">] </span><span style="color:#C678DD">for</span><span style="color:#ABB2BF"> sample </span><span style="color:#C678DD">in</span><span style="color:#ABB2BF"> final]</span></span>
<span class="line"><span style="color:#ABB2BF">classification_labels </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> [label </span><span style="color:#C678DD">for</span><span style="color:#ABB2BF"> label </span><span style="color:#C678DD">in</span><span style="color:#ABB2BF"> classes </span><span style="color:#C678DD">if</span><span style="color:#ABB2BF"> label </span><span style="color:#C678DD">is</span><span style="color:#C678DD"> not</span><span style="color:#D19A66"> None</span><span style="color:#ABB2BF">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic"># Create a histogram of the classification labels</span></span>
<span class="line"><span style="color:#ABB2BF">unique_labels, label_counts </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> np.</span><span style="color:#61AFEF">unique</span><span style="color:#ABB2BF">(classification_labels, </span><span style="color:#E06C75;font-style:italic">return_counts</span><span style="color:#56B6C2">=</span><span style="color:#D19A66">True</span><span style="color:#ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic"># Plot the histogram</span></span>
<span class="line"><span style="color:#ABB2BF">plt.</span><span style="color:#61AFEF">bar</span><span style="color:#ABB2BF">(unique_labels, label_counts)</span></span>
<span class="line"><span style="color:#ABB2BF">plt.</span><span style="color:#61AFEF">xlabel</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;Classes&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">plt.</span><span style="color:#61AFEF">ylabel</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;Frequency&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">plt.</span><span style="color:#61AFEF">title</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&#39;Classification Distribution Histogram&#39;</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#ABB2BF">plt.</span><span style="color:#61AFEF">show</span><span style="color:#ABB2BF">()</span></span></code></pre> </div> </astro-accordion>  
<p><img src="/images/nvc/6.png" alt="image"/></p>
<p>Looks better</p>
<p>And with that we are done!</p>
<h2 id="the-final-step-pushing-to-hugging-face-hub">The Final Step: Pushing to Hugging Face hub</h2>
<p>Let’s push to the hub</p>
<pre class="astro-code one-dark-pro" style="background-color:#282c34;color:#abb2bf;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word" tabindex="0"><code><span class="line"><span style="color:#ABB2BF">!</span><span style="color:#61AFEF">pip</span><span style="color:#98C379"> install</span><span style="color:#98C379"> huggingface_hub</span></span></code></pre>
<pre class="astro-code one-dark-pro" style="background-color:#282c34;color:#abb2bf;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word" tabindex="0"><code><span class="line"><span style="color:#C678DD">from</span><span style="color:#ABB2BF"> huggingface_hub </span><span style="color:#C678DD">import</span><span style="color:#ABB2BF"> notebook_login</span></span>
<span class="line"></span>
<span class="line"><span style="color:#61AFEF">notebook_login</span><span style="color:#ABB2BF">()</span></span></code></pre>
<pre class="astro-code one-dark-pro" style="background-color:#282c34;color:#abb2bf;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word" tabindex="0"><code><span class="line"><span style="color:#C678DD">from</span><span style="color:#ABB2BF"> datasets </span><span style="color:#C678DD">import</span><span style="color:#ABB2BF"> Dataset, DatasetDict</span></span>
<span class="line"><span style="color:#C678DD">import</span><span style="color:#ABB2BF"> pandas </span><span style="color:#C678DD">as</span><span style="color:#ABB2BF"> pd</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">final_df </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> pd.</span><span style="color:#61AFEF">DataFrame</span><span style="color:#ABB2BF">(final)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">shuffled_df </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> final_df.</span><span style="color:#61AFEF">sample</span><span style="color:#ABB2BF">(</span><span style="color:#E06C75;font-style:italic">frac</span><span style="color:#56B6C2">=</span><span style="color:#D19A66">1</span><span style="color:#ABB2BF">).</span><span style="color:#61AFEF">reset_index</span><span style="color:#ABB2BF">(</span><span style="color:#E06C75;font-style:italic">drop</span><span style="color:#56B6C2">=</span><span style="color:#D19A66">True</span><span style="color:#ABB2BF">) </span><span style="color:#7F848E;font-style:italic"># Shuffle because right now the evaluations are all together and the observations all together</span></span>
<span class="line"><span style="color:#ABB2BF">dataset </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> Dataset.</span><span style="color:#61AFEF">from_pandas</span><span style="color:#ABB2BF">(shuffled_df) </span><span style="color:#7F848E;font-style:italic">#we use pandas we need to load a list of dicts and not a dict of lists as `Dataset` expects</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic"># we put in test set as it not is not meant to be trained on</span></span>
<span class="line"><span style="color:#ABB2BF">test_set </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> DatasetDict</span><span style="color:#ABB2BF">({</span></span>
<span class="line"><span style="color:#98C379">    &#39;test&#39;</span><span style="color:#ABB2BF">: dataset</span></span>
<span class="line"><span style="color:#ABB2BF">})</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">test_set.</span><span style="color:#61AFEF">push_to_hub</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&quot;thomasgauthier/observation_or_evaluation&quot;</span><span style="color:#ABB2BF">, </span><span style="color:#E06C75;font-style:italic">private</span><span style="color:#56B6C2">=</span><span style="color:#D19A66">True</span><span style="color:#ABB2BF">)</span></span></code></pre> </section> </main> <footer class="text-sm leading-[1.75] mt-4" data-astro-cid-sz7xmlte> <div data-astro-cid-sz7xmlte></div> </footer>  </div> </body></html>